DEFINENSTEP3NEURON{POINT_PROCESSR_VClampELECTRODE_CURRENTiRANGEe0,vo0,vi0,dur,amp,gain,rstim,tau1,tau2,fac,i}UNITS{(nA)=(nanoamp)(mV)=(millivolt)(uS)=(micromho)}PARAMETER{dur[NSTEP](ms)<0,1e9>amp[NSTEP](mV)gain=1e5<0,1e9>rstim=1(megohm)<1e-9,1e9>tau1=.001(ms)<0,1e9>tau2=0(ms)<0,1e9>e0(mV)vo0(mV)vi0(mV)fac=0<1,10>}ASSIGNED{v(mV)dt(ms)i(nA)stim(mV)tc(ms)}STATE{e(mV)vo(mV)vi(mV)}INITIAL{e0=0vo=vvo0=vvi=vvi0=ve=0FROMj=0TONSTEP-1{if(dur[j]>0&&amp[j]!=0){VERBATIM{externintcvode_active_;if(cvode_active_){hoc_execerror("VClamp","doesnotworkwithCVODE");}}ENDVERBATIM}}}BREAKPOINT{SOLVEupdateMETHODafter_cvodevstim()i=icur()}PROCEDUREvstim(){tc=0(ms)FROMj=0TONSTEP-1{if(j==1){if(t<dur[0]+(dur[1]/2)){stim=amp[0]-(t-dur[0])*(amp[1]/(dur[1]/2))}else{stim=amp[0]-(t-dur[0]-(dur[1]/2))*(-amp[1]/(dur[1]/2))-amp[1]}}else{stim=amp[j]}tc=tc+dur[j]if(t<tc){tc=tc+100VERBATIMbreak;ENDVERBATIM}}}FUNCTIONicur()(nA){LOCALvoutif(t>tc){e0=0vo0=0icur=0}else{SOLVEclampicur=(vo-v)/rstim}}LINEARclamp{LOCALt1,t2t1=tau1/dtt2=tau2/dt~vi=v+fac*vo-fac*v~t2*vo-t2*vo0+vo=-gain*e~-stim-e+vi-e+t1*vi-t1*e-t1*(vi0-e0)=0}PROCEDUREupdate(){i=icur()e0=evo0=vovi0=viVERBATIMreturn0;ENDVERBATIM}