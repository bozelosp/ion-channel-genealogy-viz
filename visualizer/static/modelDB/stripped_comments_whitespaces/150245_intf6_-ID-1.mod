NEURON{ARTIFICIAL_CELLINTF6RANGEVAM,VNM,VGA,AHPRANGEVAM2,VNM2,VGA2RANGEVmRANGEtauAM,tauNM,tauGARANGEtauAM2,tauNM2,tauGA2RANGEtauahp,ahpwtRANGEtauRR,RRWghtRANGERMP,VTH,Vblock,VTHC,VTHRRANGEincRRRANGEnbur,tbur,refrac,AHP2REFRANGEinvl,oinvl,WINV,invltRANGEVbrefracRANGESTDAM,STDNM,STDGARANGEmg0RANGEmaxnmcGLOBALEAM,ENM,EGA,mgGLOBALspkht,wwwid,wwhtGLOBALstopoqPOINTERsopRANGEspck,xloc,yloc,zlocRANGEt0,tg,twg,refractory,trrsRANGEcburRANGEWEXRANGEEXSYRANGElfpscaleGLOBALvdt,nxt,RES,ESIN,PskGLOBALprnum,nsw,rebegGLOBALsubsvint,jrsvn,jrsvd,jrtime,jrtmGLOBALDEAD_DIV,seedstepGLOBALseaddvioffGLOBALWVAR,DELMINGLOBALsavclock,slowset,FLAGGLOBALtmax,installed,verboseGLOBALpathbeg,pathend,PATHMEASURE,pathidtarg,pathtytarg,seadsetting,pathlenGLOBALmaxplasttGLOBALplaststartTGLOBALplastendTGLOBALresetplastGLOBALwsettingGLOBALESTDPGLOBALISTDPGLOBALSOFTSTDPGLOBALEPOTW,EDEPW,IPOTW,IDEPWGLOBALnextGIDGLOBALEDOPEGLOBALIDOPEGLOBALDOPEGLOBALFORWELIGTRGLOBALBACKELIGTRGLOBALEXPELIGTRGLOBALmaxeligtrdurGLOBALreseteligtrGLOBALscalingGLOBALdynamicdelGLOBALdelspeedGLOBALscaleinhibGLOBALactivitytauGLOBALactivitybetaGLOBALactivitygamma}PARAMETER{tauAM=10(ms)tauNM=300(ms)tauGA=10(ms)tauAM2=20(ms)tauNM2=300(ms)tauGA2=20(ms)invl=100(ms)WINV=0ahpwt=0tauahp=10(ms)tauRR=6(ms)refrac=5(ms)AHP2REF=0.0Vbrefrac=20(ms)RRWght=0.75wwwid=10wwht=10VTH=-45VTHC=-45VTHR=-45incRR=0Vblock=-20vdt=0.1mg=1sop=0nbur=1tbur=2RMP=-65EAM=65ENM=90EGA=-15spkht=50prnum=-1nsw=0rebeg=0subsvint=0jrsvn=1e4jrsvd=1e4jrtime=-1jrtm=-1seedstep=44340seaddvioff=9102098713763e-134DEAD_DIV=1WVAR=0.2stopoq=0PATHMEASURE=0verbose=1seadsetting=0pathidtarg=-1DELMIN=1e-5STDAM=0STDNM=0STDGA=0mg0=3.57maxnmc=1.0lfpscale=1.0maxplastt=10.0plaststartT=-1plastendT=-1resetplast=1wsetting=0ISTDP=0ESTDP=1SOFTSTDP=1EPOTW=1EDEPW=1IPOTW=1IDEPW=1nextGID=0DOPE=0EDOPE=0IDOPE=0FORWELIGTR=1BACKELIGTR=0EXPELIGTR=1maxeligtrdur=100.0reseteligtr=0scaling=0dynamicdel=0delspeed=0.0scaleinhib=0activitytau=100.0e3activitybeta=4.0e-8activitygamma=1.0e-10}ASSIGNED{VmVAMVNMVGAAHPVAM2VNM2VGA2t0tgtwgrefractorynxtxlocyloczloctrrsWEXEXSYRESESINPskcburinvltoinvltmaxspcksavclockslowsetFLAGinstalledpathbegpathendpathtytargpathlen}CONSTRUCTOR{VERBATIM{intlid,lty,lin,lco,lgid,i;unsignedintsz;if(ifarg(1)){lid=(int)*getarg(1);}else{lid=UINT_MAX;}if(ifarg(2)){lty=(int)*getarg(2);}else{lty=-1;}if(ifarg(3)){lin=(int)*getarg(3);}else{lin=-1;}if(ifarg(4)){lco=(int)*getarg(4);}else{lco=-1;}_p_sop=(double*)ecalloc(1,sizeof(id0));ip=IDP;ip->id=lid;ip->type=lty;ip->inhib=lin;ip->col=lco;ip->pg=0x0;ip->dvi=0x0;ip->del=0x0;ip->sprob=0x0;ip->syns=0x0;ip->wgain=0x0;ip->peconv=ip->piconv=0x0;ip->syw1=ip->syw2=0x0;ip->pplasttau=0x0;ip->pplastinc=0x0;ip->pplastmaxw=0x0;ip->pdope=0x0;ip->dead=ip->invl0=ip->record=ip->jttr=ip->input=0;ip->dvt=ip->vbr=ip->wrec=ip->jcn=ip->out=0;for(i=0;i<WRNUM;i++){ip->wreci[i]=-1;ip->wscale[i]=-1.0;}ip->rve=-1;pathbeg=-1;slowset=0;ip->activity=0;ip->max_err=0;ip->max_scale=100;ip->lastupdate=0;ip->scalefactor=1.0;ip->goal_activity=-1;ip->activity_integral_err=0.0;ip->gid=nextGID;nextGID+=1.0;process=(int)getpid();CNAME[SU]="SU";CNAME[DP]="DP";CNAME[IN]="IN";if(installed==2.0&&ip->pg){sz=ivoc_list_count(ip->pg->ce);if(verbose)printf("\t****WARNINGnewINTF6created:maywanttorerunjitcondiv****\n");}elseinstalled=1.0;cbsv=0x0;}ENDVERBATIM}PROCEDUREresetscaling(){VERBATIMip=IDP;ip->activity=0;ip->max_err=0;ip->max_scale=100;ip->lastupdate=0;ip->scalefactor=1.0;ip->goal_activity=-1;ip->activity_integral_err=0.0;ENDVERBATIM}DESTRUCTOR{VERBATIM{free(IDP);}ENDVERBATIM}INITIAL{LOCALidreset()t0=0tg=0twg=0trrs=0tmax=0pathend=-1pathlen=0VERBATIM{inti,ix;ip=IDP;_lid=(double)ip->id;ip->spkcnt=0;ip->blkcnt=0;ip->errflag=0;ip->pg->lastspk[ip->id]=-1;for(i=0;i<CTYN;i++){ix=cty[i];blockcnt[ix]=spikes[ix]=AMo[ix]=NMo[ix]=GAo[ix]=AMo2[ix]=NMo2[ix]=GAo2[ix]=0;}if(seadsetting==3&&resetplast&&ip->wgain)for(i=0;i<ip->dvt;i++)ip->wgain[i]=1.0;if(seadsetting==3&&ip->pdope)for(i=0;i<ip->dvt;i++)ip->pdope[i]=-1e9;}ENDVERBATIMjrsvn=jrsvdjrtime=jrtmif(vinflag()){randspk()net_send(nxt,2)}if(recflag()){recini()}if(pathbeg==id){stoprun=0net_send(0,2)}rebeg=0VERBATIMactivityoneovertau=1.0/activitytau;ENDVERBATIM}PROCEDUREreset(){Vm=RMPVAM=0VNM=0VGA=0AHP=0VAM2=0VNM2=0VGA2=0invlt=-1t0=ttg=ttwg=ttrrs=tcbur=0spck=0refractory=0VTHC=VTHVTHR=VTH}VERBATIMunsignedintGetDVIDSeedVal(unsignedintid){doublex[2];if(seadsetting==1){sead=((unsignedint)ip->id+seaddvioff)*1e6;}else{if(seadsetting==2)printf("Warning:GetDVIDSeedValcalledwithwtrandturnedoff\n");x[0]=(double)id;x[1]=seaddvioff;sead=hashseed2(2,x);}returnsead;}ENDVERBATIMFUNCTIONDVIDSeed(){VERBATIMreturn(double)GetDVIDSeedVal(IDP->id);ENDVERBATIM}NET_RECEIVE(wAM,wNM,wGA,wGB,wAM2,wNM2,wGA2,wflg){LOCALtmp,jcn,idINITIAL{wAM=wAMwNM=wNMwGA=wGAwGB=wGBwAM2=wAM2wNM2=wNM2wGA2=wGA2wflg=0}VERBATIMid0*ppre;intprty,poty,prin,prid,poid,ii,sy,nsyn,distal;doubleSTDf,wgain,syw1,syw2;ENDVERBATIMtmax=tVERBATIMif(stopoq&&!qsz())stoprun=1;ip=IDP;pg=ip->pg;ppre=0x0;poid=ip->id;if(ip->dead)return;_ljcn=ip->jcn;_lid=ip->id;tpnt=_pnt;if(PATHMEASURE){if(_lflag==2||_lflag<0){doubleidty;inti;if(_lflag==2)ip->flag=-1;idty=(double)(FOFFSET+ip->id)+1e-2*(double)ip->type+1e-3*(double)ip->inhib+1e-4;for(i=0;i<ip->dvt&&!stoprun;i++)if(ip->sprob[i]){(*pnt_receive[get_type(ip->dvi[i]->_prop)])(ip->dvi[i],wts,idty);#ifdefNRN_MECHANISM_DATA_IS_SOAneuron::legacy::set_globals_from_prop(_pnt->_prop,_ml_real,_ml,_iml);#else_p=_pnt->_prop->param;#endif_ppvar=get_dparam(_pnt->_prop);ip=IDP;}return;}elseif(_lflag!=2&&(pathtytarg==(double)ip->type||pathidtarg==(double)ip->id)){if(pathend==(double)ip->id)return;ip->flag=(unsignedchar)floor(t)+1;pathend=(double)ip->id;pathlen=tmax+1;stoprun=1.;return;}elseif(ip->flag||ip->dvt==0||stoprun){return;}elseif(ip->inhib){if(!ip->flag)ip->flag=(unsignedchar)floor(t)+1;}else{ip->flag=(unsignedchar)floor(t)+1;#ifdefined(t)net_send((void**)0x0,wts,tpnt,t+1.,-1.);#elsenet_send((void**)0x0,wts,tpnt,1.,-1.);#endifreturn;}}if(dynamicdel){dynamicdelete(t);}decay_activity_sensor(t);if(scaling){if(ip->goal_activity<0){ip->goal_activity=ip->activity;}if(!ip->inhib||scaleinhib){update_scale_factor(t);}}ip->lastupdate=t;if(_lflag==OK){FLAG=OK;flag();return;}if(_lflag<0){callback(_lflag);return;}pg->eventtot+=1;ENDVERBATIMVERBATIMif(ip->dbx>2)ENDVERBATIM{pid()printf("DB0if(flag==0){printf("(%g%g%g%g%g%g%g)",wAM,wNM,wGA,wAM2,wNM2,wGA2,wflg)}printf("\n")}if(flag>=FOFFSET){VERBATIM{prid=(int)(_lflag-FOFFSET);poty=(int)ip->type;prty=(int)(1e2*(_lflag-floor(_lflag)));prin=(int)(1e3*(_lflag-floor(_lflag)-prty*1e-2));distal=((int)(_lflag*1e5+0.5))%2;if(distal){sy=prin?GA2:AM2;}else{sy=prin?GA:AM;}STDf=_args[0];wgain=_args[1];syw1=_args[2];syw2=_args[3];if(ip->dbx<-1)printf("prid%d,poid%d,wgain=%g\n",prid,poid,wgain);for(ii=0;ii<=6;ii++)_args[ii]=0.;if(seadsetting==3){ppre=getlp(pg->ce,prid);if(ip->dbx<-1)printf("ppre%p,pre%d->po%d,wg=%g\n",ppre,prid,ip->id,wgain);if(ppre->inhib){if(!ISTDP&&!IDOPE)ppre=0x0;}else{if(!ESTDP&&!EDOPE)ppre=0x0;}}if(ppre){for(ii=sy,nsyn=0;ii<sy+2;ii++){if(ii==AM2||ii==AM||ii==GA||ii==GA2){if(wsetting==1.0){_args[ii]=ii==sy?syw1*wgain:syw2*wgain;}else{_args[ii]=wgain*WMAT(prty,poty,ii)*WD0(prty,poty,ii);}if(ip->dbx<-1)printf("pre%d->po%d,sy=%d,wg=%g,w=%g\n",prid,ip->id,ii,wgain,_args[ii]);}else{if(wsetting==1.0){_args[ii]=ii==sy?syw1:syw2;}else{_args[ii]=WMAT(prty,poty,ii)*WD0(prty,poty,ii);}}nsyn+=(_args[ii]>0.);}}else{if(wsetting==1.0){_args[sy+0]=syw1;_args[sy+1]=syw2;nsyn=(_args[sy+0]>0.)+(_args[sy+1]>0.);}else{for(ii=sy,nsyn=0;ii<sy+2;ii++)nsyn+=((_args[ii]=WMAT(prty,poty,ii)*WD0(prty,poty,ii))>0.);}}if(nsyn==0)return;if(scaling){for(ii=sy,nsyn=0;ii<sy+2;ii++){if(!ip->inhib){if(ii==AM2||ii==AM){_args[ii]*=ip->scalefactor;}if(ii==GA||ii==GA2){_args[ii]*=1/ip->scalefactor;}}else{if(ii==AM2||ii==AM){_args[ii]*=1/ip->scalefactor;}if(ii==GA||ii==GA2){_args[ii]*=ip->scalefactor;}}}}if(seadsetting==3){}elseif(seadsetting!=2){if(seadsetting==1){sead=(unsignedint)(floor(_lflag)*ip->id*seedstep);}else{hsh[0]=floor(_lflag);hsh[1]=(double)ip->id;hsh[2]=seedstep;sead=hashseed2(3,hsh);}mcell_ran4(&sead,&_args[sy],2,1.);for(ii=sy;ii<sy+2;ii++){_args[ii]=2*WVAR*(_args[ii]+0.5/WVAR-0.5)*WMAT(prty,poty,ii)*WD0(prty,poty,ii);}}}ENDVERBATIMVERBATIMif(ip->dbx>2)ENDVERBATIM{pid()printf("DFprintf("(%g%g%g%g%g%g%g)",wAM,wNM,wGA,wAM2,wNM2,wGA2,wflg)printf("\n")}}elseif(flag==4){cbur=cbur-1if(cbur>0){net_send(tbur,4)}else{refractory=1net_send(refrac-AHP*AHP2REF,3)}tmp=tVERBATIMif(ip->jttr)ENDVERBATIM{tmp=t+jttr()/10}if(jcn){jitcon(tmp)VERBATIMif(ip->out)ENDVERBATIM{net_event(tmp)}}else{net_event(tmp)}VERBATIMspikes[ip->type]++;ENDVERBATIMspck=spck+1VERBATIMif(ip->dbx>0)ENDVERBATIM{pid()printf("DBAVERBATIMif(ip->record)ENDVERBATIM{recspk(tmp)}VERBATIMif(ip->wrec)ENDVERBATIM{wrecord(t)}VERBATIMreturn;ENDVERBATIM}elseif(flag==0&&wflg==1){VERBATIMip->input=1;ENDVERBATIMwflg=2randspk()net_send(nxt,2)VERBATIMreturn;ENDVERBATIM}elseif(flag==0&&wflg==2){VERBATIMip->input=0;ENDVERBATIMwflg=1VERBATIMreturn;ENDVERBATIM}VERBATIMif(ip->record)ENDVERBATIM{record()}VERBATIMif(ip->wrec)ENDVERBATIM{wrecord(1e9)}if(VAM>hoc_epsilon){VAM=VAM*EXP(-(t-t0)/tauAM)}else{VAM=0}if(VNM>hoc_epsilon){VNM=VNM*EXP(-(t-t0)/tauNM)}else{VNM=0}if(VGA<-hoc_epsilon){VGA=VGA*EXP(-(t-t0)/tauGA)}else{VGA=0}if(VAM2>hoc_epsilon){VAM2=VAM2*EXP(-(t-t0)/tauAM2)}else{VAM2=0}if(VNM2>hoc_epsilon){VNM2=VNM2*EXP(-(t-t0)/tauNM2)}else{VNM2=0}if(VGA2<-hoc_epsilon){VGA2=VGA2*EXP(-(t-t0)/tauGA2)}else{VGA2=0}if(refractory==0){if(VTHC>VTH){VTHC=VTH+(VTHR-VTH)*EXP(-(t-trrs)/tauRR)}elseif(RRWght<0&&VTHC<VTH){VTHC=VTH-(VTHR-VTH)*EXP(-(t-trrs)/tauRR)}}if(AHP<-hoc_epsilon){AHP=AHP*EXP(-(t-t0)/tauahp)}else{AHP=0}t0=tVm=VAM+VNM+VGA+AHP+VAM2+VNM2+VGA2if(Vm>-RMP){Vm=-RMP}if(Vm<RMP){Vm=RMP}if(flag==0||flag>=FOFFSET){if(wAM>0){if(STDAM==0){VAM=VAM+wAM*(1-Vm/EAM)}else{VAM=VAM+(1-STDAM*STDf)*wAM*(1-Vm/EAM)}if(VAM>EAM){VERBATIMAMo[ip->type]++;ENDVERBATIM}elseif(VAM<0){VAM=0}}if(wAM2>0){if(STDAM==0){VAM2=VAM2+wAM2*(1-Vm/EAM)}else{VAM2=VAM2+(1-STDAM*STDf)*wAM2*(1-Vm/EAM)}if(VAM2>EAM){VERBATIMAMo2[ip->type]++;ENDVERBATIM}elseif(VAM2<0){VAM2=0}}if(wNM>0&&VNM<ENM){if(STDNM==0){VNM=VNM+wNM*rates(RMP+Vm)*(1-Vm/ENM)}else{VNM=VNM+(1-STDNM*STDf)*wNM*rates(RMP+Vm)*(1-Vm/ENM)}if(VNM>ENM){VERBATIMNMo[ip->type]++;ENDVERBATIM}elseif(VNM<0){VNM=0}}if(wNM2>0&&VNM2<ENM){if(STDNM==0){VNM2=VNM2+wNM2*rates(RMP+Vm)*(1-Vm/ENM)}else{VNM2=VNM2+(1-STDNM*STDf)*wNM2*rates(RMP+Vm)*(1-Vm/ENM)}if(VNM2>ENM){VERBATIMNMo2[ip->type]++;ENDVERBATIM}elseif(VNM2<0){VNM2=0}}if(wGA>0&&VGA>EGA){if(STDGA==0){VGA=VGA-wGA*(1-Vm/EGA)}else{VGA=VGA-(1-STDGA*STDf)*wGA*(1-Vm/EGA)}if(VGA<EGA){VERBATIMGAo[ip->type]++;ENDVERBATIMVERBATIMif(ip->dbx>2)ENDVERBATIM{pid()printf("DB0Aif(flag==0){printf("(%g%g%g%g%g%g)",wGA,EGA,VGA,Vm,AHP,STDf)}VERBATIMprintf("\nAA:%d:%d\n\n",GAo[ip->type],ip->type);ENDVERBATIM}}elseif(VGA>0){VGA=0}}if(wGA2>0&&VGA2>EGA){if(STDGA==0){VGA2=VGA2-wGA2*(1-Vm/EGA)}else{VGA2=VGA2-(1-STDGA*STDf)*wGA2*(1-Vm/EGA)}if(VGA2<EGA){VERBATIMGAo2[ip->type]++;ENDVERBATIMVERBATIMif(ip->dbx>2)ENDVERBATIM{pid()printf("DB0Aif(flag==0){printf("(%g%g%g%g%g%g)",wGA2,EGA,VGA2,Vm,AHP,STDf)}VERBATIMprintf("\nAA:%d:%d\n\n",GAo2[ip->type],ip->type);ENDVERBATIM}}elseif(VGA2>0){VGA2=0}}VERBATIMif(ip->invl0)ENDVERBATIM{Vm=RMP+VAM+VNM+VGA+AHP+VAM2+VNM2+VGA2if(Vm>0){Vm=0}if(Vm<-90){Vm=-90}if(invlt==-1){if(Vm>RMP){oinvl=invlinvlt=tnet_send(invl,1)}}else{tmp=shift(Vm)if(tmp!=0){net_move(tmp)if(id()<prnum){pid()printf("****MOVEt=%gto%gVm=%g%g,%g\n",t,tmp,Vm,invlt,oinvl)}}}}}elseif(flag==1){if(WINV<0){if(jcn){jitcon(t)VERBATIMif(ip->out)ENDVERBATIM{net_event(t)}}else{net_event(t)}VERBATIMspikes[ip->type]++;ENDVERBATIMspck=spck+1VERBATIMif(ip->dbx>0)ENDVERBATIM{pid()printf("DBCVERBATIMif(ip->record)ENDVERBATIM{recspk(t)}VERBATIMif(ip->wrec)ENDVERBATIM{wrecord(t)}}else{tmp=WINV*(1-Vm/EAM)VAM=VAM+tmp}oinvl=invlinvlt=tnet_send(invl,1)}elseif(flag==2){VERBATIMif(ip->dbx>1)ENDVERBATIM{pid()printf("DBBaif(WEX>1e8){if(jcn){jitcon(t)VERBATIMif(ip->out)ENDVERBATIM{net_event(t)}}else{net_event(t)}VERBATIMspikes[ip->type]++;ENDVERBATIMspck=spck+1VERBATIMif(ip->dbx>0)ENDVERBATIM{pid()printf("DBBVERBATIMif(ip->record)ENDVERBATIM{recspk(t)}VERBATIMif(ip->wrec)ENDVERBATIM{wrecord(t)}}elseif(WEX>0){if(EXSY==AM){tmp=WEX*(1-Vm/EAM)VAM=VAM+tmp}elseif(EXSY==AM2){tmp=WEX*(1-Vm/EAM)VAM2=VAM2+tmp}elseif(EXSY==NM){tmp=rates(RMP+Vm)*WEX*(1-Vm/ENM)VNM=VNM+tmp}elseif(EXSY==NM2){tmp=rates(RMP+Vm)*WEX*(1-Vm/ENM)VNM2=VNM2+tmp}}elseif(WEX<0&&WEX!=-1e9){if(EXSY==GA){tmp=WEX*(1-Vm/EGA)VGA=VGA+tmp}else{tmp=WEX*(1-Vm/EGA)VGA2=VGA2+tmp}}if(WEX!=-1e9){randspk()VERBATIMif(ip->input)ENDVERBATIM{net_send(nxt,2)}}}elseif(flag==3){refractory=0trrs=tVERBATIMreturn;ENDVERBATIM}Vm=VAM+VNM+VGA+RMP+AHP+VAM2+VNM2+VGA2if(Vm>0){Vm=0}if(Vm<-90){Vm=-90}if(refractory==0&&Vm>VTHC){VERBATIMif(!ip->vbr&&Vm>Vblock){ENDVERBATIMVERBATIMip->blkcnt++;blockcnt[ip->type]++;return;}ENDVERBATIMAHP=AHP-ahpwttmp=tVERBATIMif(ip->jttr)ENDVERBATIM{tmp=t+jttr()}VERBATIMENDVERBATIMVERBATIMENDVERBATIMVERBATIMraise_activity_sensor(t);ENDVERBATIMVERBATIMip->pg->lastspk[ip->id]=_ltmp;ENDVERBATIMVERBATIMENDVERBATIMif(jcn){jitcon(tmp)VERBATIMif(ip->out)ENDVERBATIM{net_event(tmp)}}else{net_event(tmp)}VERBATIMspikes[ip->type]++;ENDVERBATIMspck=spck+1VERBATIMif(ip->dbx>0)ENDVERBATIM{pid()printf("DBDVERBATIMif(ip->record)ENDVERBATIM{recspk(tmp)}VERBATIMif(ip->wrec)ENDVERBATIM{wrecord(tmp)}if(incRR){VTHC=VTHC+RRWght*(Vblock-VTH)if(VTHC>Vblock){VTHC=Vblock}elseif(VTHC<RMP){VTHC=RMP}}else{VTHC=VTH+RRWght*(Vblock-VTH)}VTHR=VTHCrefractory=1if(seadsetting==3){if(plaststartT<0||plastendT<0||(t>=plaststartT&&t<=plastendT)){VERBATIMif(ip->dbx<-1)printf("%d@%gapplyingplasticity\n",ip->id,ip->pg->lastspk[ip->id]);ENDVERBATIMVERBATIMif(ESTDP)applyEXSTDP(ip,ip->pg->lastspk[ip->id]);ENDVERBATIMVERBATIMif(ISTDP)applyIXSTDP(ip,ip->pg->lastspk[ip->id]);ENDVERBATIMVERBATIMif(EDOPE)applyEDOPE(ip,ip->pg->lastspk[ip->id]);ENDVERBATIMVERBATIMif(IDOPE)applyIDOPE(ip,ip->pg->lastspk[ip->id]);ENDVERBATIM}}if(nbur>1){cbur=nbur-1net_send(tbur,4)VERBATIMreturn;ENDVERBATIM}VERBATIMif(ip->vbr&&Vm>Vblock)ENDVERBATIM{net_send(Vbrefrac,3)VERBATIMif(ip->dbx>0)ENDVERBATIM{pid()printf("DBEVERBATIMreturn;ENDVERBATIM}net_send(refrac-AHP*AHP2REF,3)}}PROCEDUREjitcon(tm){VERBATIM{doublemindel,randel,idty,*x;intprty,poty,i,j,k,dv;Point_process*pnt;IvocVect*voi;ip=IDP;pg=ip->pg;if(verbose>1)printf("col%d,ip%p,pg%p\n",ip->col,ip,pg);if(!pg){printf("Nonetworkdefined--mustrunjitcondiv()\n");hxe();}ip->spkcnt++;if(pg->jrj<pg->jrmax){pg->jrid[pg->jrj]=(double)ip->id;pg->jrtv[pg->jrj]=_ltm;pg->jrj++;}elseif(wf2&&pg->jrmax)spkoutf2();pg->jri++;if(jrtm>0){if(t>jrtime){jrtime+=jrtm;spkstats2(1.);}}elseif(jrsvd>0&&pg->jri>jrsvn){jrsvn+=jrsvd;printf("t=%.02f%ld",t,ip->pg->jri);spkstats2(1.);}prty=(int)ip->type;if(ip->jcn==1)if(ip->dvt>0){#ifdefined(t)if(ip->jcn==1)if(ip->dvt>0)net_send((void**)0x0,wts,tpnt,t+ip->del[0],-1.);#elseif(ip->jcn==1)if(ip->dvt>0)net_send((void**)0x0,wts,tpnt,ip->del[0],-1.);#endif}}ENDVERBATIM}PROCEDUREspkstats(){VERBATIM{if(ifarg(1))tf=hoc_obj_file_arg(1);elsetf=0x0;}ENDVERBATIM}PROCEDUREspkoutf(){VERBATIM{if(ifarg(2)){wf1=hoc_obj_file_arg(1);wf2=hoc_obj_file_arg(2);}elseif(wf1!=0x0){spkoutf2();wf1=(FILE*)0x0;wf2=(FILE*)0x0;}}ENDVERBATIM}VERBATIMstaticvoidspkoutf2(){fprintf(wf1,"fwrite(pg->jrtv,sizeof(double),pg->jrj,wf2);fwrite(pg->jrid,sizeof(double),pg->jrj,wf2);fflush(wf1);fflush(wf2);pg->jrj=0;}ENDVERBATIMPROCEDUREcallhoc(){VERBATIMif(ifarg(1)){cbsv=hoc_lookup(gargstr(1));}else{cbsv=0x0;}ENDVERBATIM}PROCEDUREspkstats2(flag){VERBATIM{inti,ix,flag;doubleclk;ip=IDP;pg=ip->pg;flag=(int)(_lflag+1e-6);clk=clock()-savclock;savclock=clock();if(cbsv)hoc_call_func(cbsv,0);if(tf)fprintf(tf,"t=%.02f;%ld(%g)",t,pg->jri,clk/1e6);else{printf("t=%.02f;%ld(%g)",t,pg->jri,clk/1e6);}for(i=0;i<CTYN;i++){ix=cty[i];pg->spktot+=spikes[ix];if(tf){fprintf(tf,"%s:%d/%d:%d;%d;%d;%d;%d;%d",CNAME[i],spikes[ix],\blockcnt[ix],AMo[ix],NMo[ix],GAo[ix],AMo2[ix],NMo2[ix],GAo2[ix]);}else{printf("%s:%d/%d:%d;%d;%d;%d;%d;%d",CNAME[i],spikes[ix],blockcnt[ix],\AMo[ix],NMo[ix],GAo[ix],AMo2[ix],NMo2[ix],GAo2[ix]);}spck=0;blockcnt[ix]=spikes[ix]=0;AMo[ix]=NMo[ix]=GAo[ix]=AMo2[ix]=NMo2[ix]=GAo2[ix]=0;}if(tf&&flag==2){fprintf(tf,"\nt=%gtot_spks:%ld;tot_events:%ld\n",t,pg->spktot,pg->eventtot);}elseif(flag==2){printf("\ntotalspikes:%ld;totalevents:%ld\n",pg->spktot,pg->eventtot);}elseif(tf)fprintf(tf,"\n");elseprintf("\n");}ENDVERBATIM}PROCEDUREoobpr(){VERBATIM{inti,ix;for(i=0;i<CTYN;i++){ix=cty[i];printf("%d:%d/%d:%d;%d;%d;%d;%d;%d",ix,spikes[ix],blockcnt[ix],\AMo[ix],NMo[ix],GAo[ix],AMo2[ix],NMo2[ix],GAo2[ix]);}printf("\n");}ENDVERBATIM}PROCEDUREcallback(fl){VERBATIM{inti;doubleidty,idtflg,del0,ddel;id0*jp;Point_process*upnt;i=(unsignedint)((-_lfl)-1);jp=IDP;upnt=tpnt;del0=jp->del[i];ddel=0.;idty=(double)(FOFFSET+jp->id)+1e-2*(double)jp->type+1e-3*(double)jp->inhib+1e-4;while(ddel<=DELMIN){if(Vblock<VTHC){wts[0]=0;}elseif(STDAM||STDNM||STDGA){wts[0]=(VTHC-VTH)/(Vblock-VTH);}wts[1]=0.0;if(seadsetting==3){if(jp->inhib){if(ISTDP||IDOPE)wts[1]=jp->wgain[i];}else{if(ESTDP||EDOPE)wts[1]=jp->wgain[i];}}if(wsetting==1.0&&jp->syw1&&jp->syw2){wts[2]=jp->syw1[i];wts[3]=jp->syw2[i];}idtflg=idty+(1e-5*jp->syns[i]);if(jp->sprob[i])(*pnt_receive[get_type(jp->dvi[i]->_prop)])(jp->dvi[i],wts,idtflg);#ifdefNRN_MECHANISM_DATA_IS_SOAneuron::legacy::set_globals_from_prop(upnt->_prop,_ml_real,_ml,_iml);#else_p=upnt->_prop->param;#endif_ppvar=get_dparam(upnt->_prop);i++;if(i>=jp->dvt)return0;ddel=jp->del[i]-del0;}while(i<jp->dvt&&(!jp->sprob[i]||id0ptr(jp->dvi[i]->_prop)->dead))i++;if(i<jp->dvt){ddel=jp->del[i]-del0;;#ifdefined(t)net_send((void**)0x0,wts,upnt,t+ddel,(double)-(i+1));#elsenet_send((void**)0x0,wts,upnt,ddel,(double)-(i+1));#endif}}ENDVERBATIM}PROCEDUREmkdvi(){VERBATIM{inti,j,k,prty,poty,dv,dvt,dvii;double*x,*db,*dbs;Object*lb;Point_process*pnnt,**da,**das;ip=IDP;pg=ip->pg;if(ip->dead)return0;prty=ip->type;sead=GetDVIDSeedVal(ip->id);for(i=0,k=0,dvt=0;i<CTYN;i++){poty=cty[i];dvt+=DVG(prty,poty);}da=(Point_process**)malloc(dvt*sizeof(Point_process*));das=(Point_process**)malloc(dvt*sizeof(Point_process*));db=(double*)malloc(dvt*sizeof(double));dbs=(double*)malloc(dvt*sizeof(double));for(i=0,k=0,dvii=0;i<CTYN;i++){poty=cty[i];dv=DVG(prty,poty);if(dv>0){sead+=dv;if(dv>dscrsz){printf("B:Divergenceexceedsdscrsz:%d>%dfor%d->%d\n",dv,dscrsz,prty,poty);hxe();}mcell_ran4(&sead,dscr,dv,pg->ixe[poty]-pg->ix[poty]+1);for(j=0;j<dv;j++){if(!(lb=ivoc_list_item(pg->ce,(unsignedint)floor(dscr[j]+pg->ix[poty])))){printf("INTF6:callback%gexceeds%dforlistce\n",floor(dscr[j]+pg->ix[poty]),pg->cesz);hxe();}pnnt=(Point_process*)lb->u.this_pointer;da[j+dvii]=pnnt;}mcell_ran4(&sead,dscr,dv,2*DELD(prty,poty));for(j=0;j<dv;j++){db[j+dvii]=dscr[j]+DELM(prty,poty)-DELD(prty,poty);if(db[j+dvii]<0)db[j+dvii]=-db[j+dvii];}dvii+=dv;}}gsort2(db,da,dvt,dbs,das);ip->del=dbs;ip->dvi=das;ip->dvt=dvt;ip->syns=(char*)calloc(dvt,sizeof(char));ip->sprob=(unsignedchar*)malloc(dvt*sizeof(char*));for(i=0;i<dvt;i++)ip->sprob[i]=1;free(da);free(db);}ENDVERBATIM}PROCEDUREpatha2b(){VERBATIMinti;doubleidty,*x;staticPoint_process*_pnt;staticid0*ip0;ip=IDP;pg=ip->pg;pathbeg=*getarg(1);pathidtarg=*getarg(2);pathtytarg=-1;PATHMEASURE=1;pathlen=stopoq=0;for(i=0;i<pg->cesz;i++){lop(pg->ce,i);if((i==pathbeg||i==pathidtarg)&&qp->inhib){pid();printf("Checkingtoorfrominhibcell\n");hxe();}qp->flag=qp->vinflg=0;}hoc_call_func(hoc_lookup("finitialize"),0);cvode_fadvance(1000.0);ENDVERBATIM}FUNCTIONpathgrps(){VERBATIMinti,j,k,na,nb,flag;doubleidty,*a,*b,*x,sum;staticPoint_process*_pnt;staticid0*ip0;Symbol*s;char**pfl;ip=IDP;pg=ip->pg;x=0x0;s=hoc_lookup("finitialize");if(ifarg(2)){na=vector_arg_px(1,&a);nb=vector_arg_px(2,&b);if(ifarg(3))x=vector_newsize(vector_arg(3),na*nb);}else{na=nb=pg->cesz;if(ifarg(1))x=vector_newsize(vector_arg(1),na*nb);}pfl=(char**)malloc(pg->cesz*(unsigned)sizeof(char*));for(i=0;i<pg->cesz;i++){lop(pg->ce,i);scr[i]=qp->inhib;pfl[i]=&qp->flag;}pathtytarg=-1;PATHMEASURE=1;pathlen=stopoq=0;for(k=0,sum=0;k<na;k++){pathbeg=a[k];if(scr[(int)pathbeg]){if(x)for(j=0;j<nb;j++)x[k*nb+j]=0.;continue;}for(j=0;j<nb;j++){pathidtarg=b[j];if(scr[(int)pathidtarg]){if(x)x[k*nb+j]=0.;continue;}for(i=0;i<pg->cesz;i++)*pfl[i]=0;hoc_call_func(s,0);cvode_fadvance(1000.0);sum+=pathlen;if(x)x[k*nb+j]=pathlen;}}PATHMEASURE=0;free(pfl);_lpathgrps=sum/na/nb;ENDVERBATIM}FUNCTIONgetdvi(){VERBATIM{inti,j,k,iarg,av1,a2,a3,a4,a6,a7,dvt,getactive=0,idx=0,*pact,prty,poty,sy,ii;double*dbs,*x,*x1,*x2,*x3,*x4,*x5,*x6,*x7,idty,y[2],flag;IvocVect*voi,*voi2,*voi3;Point_process**das;ip=IDP;pg=ip->pg;getactive=a2=a3=a4=0;if(ip->dead)return0.0;dvt=ip->dvt;dbs=ip->del;das=ip->dvi;_lgetdvi=(double)dvt;if(!ifarg(1))return_lgetdvi;iarg=1;if(hoc_is_double_arg(iarg)){av1=2;flag=*getarg(iarg++);getactive=(int)flag;flag-=(double)getactive;if(flag!=0)flag=floor(flag*10+hoc_epsilon);}elseav1=1;voi=vector_arg(iarg++);if(flag==2){x1=vector_newsize(voi,CTYPi);for(i=0;i<CTYPi;i++)x1[i]=0;}elsex1=vector_newsize(voi,dvt);if(ifarg(iarg)){voi=vector_arg(iarg++);x2=vector_newsize(voi,dvt);a2=1;}if(ifarg(iarg)){voi=vector_arg(iarg++);x3=vector_newsize(voi,dvt);a3=1;}if(ifarg(iarg)){voi=vector_arg(iarg++);x4=vector_newsize(voi,dvt);a4=1;voi=vector_arg(iarg++);x5=vector_newsize(voi,dvt);}if(ifarg(iarg)){voi=vector_arg(iarg++);x6=vector_newsize(voi,dvt);a6=1;}elsea6=0;if(ifarg(iarg)){voi=vector_arg(iarg++);x7=vector_newsize(voi,dvt);a7=1;}elsea7=0;idty=(double)(FOFFSET+ip->id)+1e-2*(double)ip->type+1e-3*(double)ip->inhib+1e-4;prty=ip->type;sy=ip->inhib?GA:AM;for(i=0,j=0;i<dvt;i++){qp=id0ptr(das[i]->_prop);if(getactive&&(qp->dead||ip->sprob[i]==0))continue;if(flag==1){x1[j]=(double)qp->type;}elseif(flag==2){x1[qp->type]++;}elseif(flag==3){x1[j]=(double)qp->col;}elsex1[j]=(double)qp->id;if(a2)x2[j]=dbs[i];if(a3)x3[j]=(double)ip->sprob[i];if(a4){if(ip->inhib){sy=ip->syns[i]?GA2:GA;}else{sy=ip->syns[i]?AM2:AM;}poty=qp->type;if(wsetting==1){y[0]=ip->syw1[i];y[1]=ip->syw2[i];}else{if(seadsetting==2||seadsetting==3){for(ii=0;ii<2;ii++)y[ii]=WMAT(prty,poty,sy+ii)*WD0(prty,poty,sy+ii);}else{if(seadsetting==1){sead=(unsignedint)(FOFFSET+ip->id)*qp->id*seedstep;}else{hsh[0]=(double)(FOFFSET+ip->id);hsh[1]=(double)(qp->id);hsh[2]=seedstep;sead=hashseed2(3,hsh);}mcell_ran4(&sead,y,2,1.);for(ii=0;ii<2;ii++){y[ii]=2*WVAR*(y[ii]+0.5/WVAR-0.5)*WMAT(prty,poty,sy+ii)*WD0(prty,poty,sy+ii);}}}x4[j]=y[0];x5[j]=y[1];}if(a6)x6[j]=ip->syns[i];if(a7&&ip->wgain)x7[j]=ip->wgain[i];j++;}if(flag!=2&&j!=dvt)for(i=av1;i<iarg;i++)vector_resize(vector_arg(i),j);_lgetdvi=(double)j;}ENDVERBATIM}FUNCTIONgetconv(){VERBATIM{intiarg,i,j,k,dvt,sz,prfl,getactive;double*x,flag;IvocVect*voi;Point_process**das;id0*pp;ip=IDP;pg=ip->pg;sz=ip->dvt;getactive=0;if(ifarg(iarg=1)&&hoc_is_double_arg(iarg)){flag=*getarg(iarg++);getactive=(int)flag;flag-=(double)getactive;if(flag!=0)flag=floor(flag*10+hoc_epsilon);}if(!ifarg(iarg))prfl=0;else{prfl=1;voi=vector_arg(iarg);if(flag==2.){x=vector_newsize(voi,CTYPi);for(i=0;i<CTYPi;i++)x[i]=0;}elsex=vector_newsize(voi,sz);}for(i=0,k=0;i<pg->cesz;i++){lop(pg->ce,i);if(getactive&&qp->dead)continue;dvt=qp->dvt;das=qp->dvi;for(j=0;j<dvt;j++){if(getactive&&qp->sprob[j]==0)continue;if(ip==id0ptr(das[j]->_prop)){if(prfl){if(flag!=2.0&&k>=sz)x=vector_newsize(voi,sz*=2);if(flag==1.0){x[k]=(double)qp->type;}elseif(flag==2.0){x[qp->type]++;}elsex[k]=(double)qp->id;}k++;break;}}}if(prfl&&flag!=2)vector_resize(voi,k);_lgetconv=(double)k;}ENDVERBATIM}FUNCTIONadjlist(){VERBATIMObject*pList=*hoc_objgetarg(1);ip=IDP;pg=ip->pg;intiListSz=ivoc_list_count(pList),iCell,iStartID=ifarg(2)?*getarg(2):0,\iEndID=ifarg(3)?*getarg(3):pg->cesz-1;intskipinhib=ifarg(4)?*getarg(4):0,i,j,nv,*pused=(int*)calloc(pg->cesz,sizeof(int)),iSyns=0;double**vvo=(double**)malloc(sizeof(double*)*iListSz),\*psyns=(double*)calloc(pg->cesz,sizeof(double));id0*rp;for(iCell=iStartID;iCell<=iEndID;iCell++){if(verbose&&iCell%1000==0)printf("%d",iCell);lop(pg->ce,iCell);if(!qp->dvt||(skipinhib&&qp->inhib)){list_vector_resize(pList,iCell,0);continue;}iSyns=0;for(j=0;j<qp->dvt;j++){rp=id0ptr(qp->dvi[j]->_prop);if(skipinhib&&rp->inhib)continue;if(!rp->dead&&qp->sprob[j]>0.&&!pused[rp->id]){pused[rp->id]=1;psyns[iSyns++]=rp->id;}}list_vector_resize(pList,iCell,iSyns);list_vector_px(pList,iCell,&vvo[iCell]);memcpy(vvo[iCell],psyns,sizeof(double)*iSyns);for(j=0;j<iSyns;j++)pused[(int)psyns[j]]=0;}free(vvo);free(pused);free(psyns);if(verbose)printf("\n");return1.0;ENDVERBATIM}FUNCTIONrddvi(){VERBATIMPoint_process*pnnt;FILE*fp;inti,iCell;unsignedintiOutID;Object*lb;fp=hoc_obj_file_arg(1);ip=IDP;pg=ip->pg;printf("reading:");for(iCell=0;iCell<pg->cesz;iCell++){if(iCell%1000==0)printf("%d",iCell);lop(pg->ce,iCell);intret;ret=fread(&qp->id,sizeof(unsignedint),1,fp);ret=fread(&qp->type,sizeof(unsignedchar),1,fp);ret=fread(&qp->col,sizeof(unsignedint),1,fp);ret=fread(&qp->dead,sizeof(unsignedchar),1,fp);ret=fread(&qp->dvt,sizeof(unsignedint),1,fp);if(qp->del){free(qp->del);free(qp->dvi);free(qp->sprob);qp->dvt=0;qp->dvi=(Point_process**)0x0;qp->del=(double*)0x0;qp->sprob=(unsignedchar*)0x0;}if(!qp->dvt)continue;qp->dvi=(Point_process**)malloc(sizeof(Point_process*)*qp->dvt);for(i=0;i<qp->dvt;i++){ret=fread(&iOutID,sizeof(unsignedint),1,fp);if(!(lb=ivoc_list_item(pg->ce,iOutID))){printf("INTF6:callback%dexceeds%dforlistce\n",iOutID,pg->cesz);hxe();}qp->dvi[i]=(Point_process*)lb->u.this_pointer;}qp->del=(double*)malloc(sizeof(double)*qp->dvt);ret=fread(qp->del,sizeof(double),qp->dvt,fp);qp->sprob=(unsignedchar*)malloc(sizeof(unsignedchar)*qp->dvt);ret=fread(qp->sprob,sizeof(unsignedchar),qp->dvt,fp);}printf("\n");return1.0;ENDVERBATIM}FUNCTIONsvdvi(){VERBATIMPoint_process*pnnt;FILE*fp;inti,iCell;fp=hoc_obj_file_arg(1);ip=IDP;pg=ip->pg;printf("writing:");for(iCell=0;iCell<pg->cesz;iCell++){if(iCell%1000==0)printf("%d",iCell);lop(pg->ce,iCell);fwrite(&qp->id,sizeof(unsignedint),1,fp);fwrite(&qp->type,sizeof(unsignedchar),1,fp);fwrite(&qp->col,sizeof(unsignedint),1,fp);fwrite(&qp->dead,sizeof(unsignedchar),1,fp);fwrite(&qp->dvt,sizeof(unsignedint),1,fp);if(!qp->dvt)continue;for(i=0;i<qp->dvt;i++){pnnt=qp->dvi[i];fwrite(&(id0ptr(pnnt->_prop)->id),sizeof(unsignedint),1,fp);}fwrite(qp->del,sizeof(double),qp->dvt,fp);fwrite(qp->sprob,sizeof(unsignedchar),qp->dvt,fp);}printf("\n");return1.0;ENDVERBATIM}FUNCTIONsetdvir(){VERBATIMListVec*pListWires,*pListDels;inti,dn,flag,dvt,idvfl,iCell,iStartID,iEndID,nidv,end;double*y,*d,*idvec;unsignedcharpdead;ip=IDP;pg=ip->pg;pListWires=AllocListVec(*hoc_objgetarg(1));idvfl=flag=0;iStartID=0;iEndID=pg->cesz-1;if(!pListWires){printf("setalldviERRA:probleminitializingwireslistarg!\n");hxe();}pListDels=AllocListVec(*hoc_objgetarg(2));if(!pListDels){printf("setalldviERRA:probleminitializingdelayslistarg!\n");FreeListVec(&pListWires);hxe();}if(ifarg(3)&&!ifarg(4)){flag=(int)*getarg(3);}elseif(hoc_is_double_arg(3)){iStartID=(int)*getarg(3);iEndID=(int)*getarg(4);if(ifarg(5))flag=(int)*getarg(5);}else{nidv=vector_arg_px(3,&idvec);idvfl=1;if(ifarg(4))flag=(int)*getarg(4);}end=idvfl?nidv:(iEndID-iStartID+1);for(i=0;i<end;i++){if(i%1000==0)printf("%d",i/1000);iCell=idvfl?idvec[i]:(iStartID+i);lop(pg->ce,iCell);if(qp->dead)continue;y=pListWires->pv[i];dvt=pListWires->plen[i];if(!dvt)continue;d=pListDels->pv[i];dn=pListDels->plen[i];if(dn!=dvt){printf("setdvir()ERRvecsizesforwire,delaylistentriesnotequal%d:%d%d\n",i,dvt,dn);hxe();}setdvi2(y,d,0x0,dvt,flag,0x0,0x0);}FreeListVec(&pListWires);FreeListVec(&pListDels);return1.0;ENDVERBATIM}PROCEDUREclrdvi(){VERBATIMinti;ip=IDP;pg=ip->pg;for(i=0;i<pg->cesz;i++){lop(pg->ce,i);if(qp->dvt!=0x0){free(qp->dvi);free(qp->del);free(qp->sprob);qp->dvt=0;qp->dvi=(Point_process**)0x0;qp->del=(double*)0x0;qp->sprob=(unsignedchar*)0x0;if(wsetting==1)freesywv(qp);}}ENDVERBATIM}PROCEDUREsetdviv(){VERBATIMinti,j,k,l,nprv,dvt,*scr;double*prv,*pov,*dlv,x,*ds,*w1,*w2;char*s;ip=IDP;pg=ip->pg;nprv=vector_arg_px(1,&prv);i=vector_arg_px(2,&pov);j=vector_arg_px(3,&dlv);if(ifarg(4)){s=(char*)calloc((l=vector_arg_px(4,&ds)),sizeof(char));for(k=0;k<l;k++)s[k]=ds[k];k=0;}elses=0x0;if(nprv!=i||i!=j||j!=l){printf("intf:setdvivERRA:%d%d%d%d\n",nprv,i,j,l);hxe();}if(wsetting==1){i=vector_arg_px(5,&w1);j=vector_arg_px(6,&w2);if(nprv!=i||i!=j){printf("intf:setdvivERRB:%d%d%d\n",nprv,i,j);hxe();}}scr=(int*)ecalloc(pg->cesz,sizeof(int));for(i=0;i<pg->cesz;i++)scr[i]=0;for(i=0,j=-1;i<nprv;i++){if((int)prv[i]<j){printf("intf:setdvivERRCvecsshouldbesortedbypridvec\n");hxe();}j=(int)prv[i];scr[j]++;}if(ip->dbx>1)for(i=0;i<pg->cesz;i++)printf("%d",scr[i]);for(i=-1,k=0;k<nprv;k+=dvt){if(i%1000==0)printf(".");if((int)prv[k]==i){printf("intf:setdvivERRDnumberrepeated%g%d%d\n",prv[k],i,k);hxe();}i=(int)prv[k];lop(pg->ce,i);dvt=scr[i];if(ip->dbx>0)printf("DBA:%d,%d,%d",i,dvt,k);if(qp->dead)continue;if(dvt>0){if(wsetting==1){setdvi3(pov+k,dlv+k,s+k,dvt,w1+k,w2+k);}else{setdvi2(pov+k,dlv+k,s?s+k:0x0,dvt,1,0x0,0x0);}}}if(s)free(s);ENDVERBATIM}VERBATIMvoidsetupsywv(id0*p,intsz){p->syw1=p->syw1!=0x0?(double*)realloc((double*)p->syw1,sz*sizeof(double)):(double*)calloc(sz,sizeof(double));p->syw2=p->syw2!=0x0?(double*)realloc((double*)p->syw2,sz*sizeof(double)):(double*)calloc(sz,sizeof(double));}voidfreesywv(id0*p){if(p->syw1)free(p->syw1);p->syw1=0x0;if(p->syw2)free(p->syw2);p->syw2=0x0;}ENDVERBATIMFUNCTIONsetsywv(){VERBATIMintsz,n1,n2;double*psyw1,*psyw2;id0*ip;ip=IDP;pg=ip->pg;sz=ip->dvt;if((n1=vector_arg_px(1,&psyw1))!=sz||(n2=vector_arg_px(2,&psyw2))!=sz){printf("setsywvERRA:makesureweightvectorsizes(%d,%d)samesizeasdiv(%d)\n",n1,n2,sz);return0.0;}setupsywv(ip,sz);memcpy(ip->syw1,psyw1,sizeof(double)*sz);memcpy(ip->syw2,psyw2,sizeof(double)*sz);returnsz;ENDVERBATIM}FUNCTIONgetsywv(){VERBATIMintsz,n1,n2;double*psyw1,*psyw2;id0*ip;ip=IDP;pg=ip->pg;sz=ip->dvt;if(!ip->syw1||!ip->syw2){printf("getsywvERRA:syw1,syw2wereneverinitializedwithsetsywv!\n");return0.0;}if((n1=vector_arg_px(1,&psyw1))!=sz||(n2=vector_arg_px(2,&psyw2))!=sz){printf("getsywvERRB:makesureweightvectorsizes(%d,%d)samesizeasdiv(%d)\n",n1,n2,sz);return0.0;}memcpy(psyw1,ip->syw1,sizeof(double)*sz);memcpy(psyw2,ip->syw2,sizeof(double)*sz);returnsz;ENDVERBATIM}VERBATIMint*getpeconv(id0*ip,int*psz){Point_process**das;int*pfrom;inti,j,k,dvt;*psz=ip->dvt>0?ip->dvt:16;pg=ip->pg;pfrom=(int*)calloc(psz[0],sizeof(int));for(i=0,k=0;i<pg->cesz;i++){lop(pg->ce,i);if(qp->inhib)continue;dvt=qp->dvt;das=qp->dvi;for(j=0;j<dvt;j++){if(ip==id0ptr(das[j]->_prop)){if(k>=*psz){psz[0]*=2;pfrom=(int*)realloc((void*)pfrom,psz[0]*sizeof(int));}pfrom[k]=qp->id;k++;break;}}}*psz=k;returnpfrom;}int*getpiconv(id0*ip,int*psz){Point_process**das;int*pfrom;inti,j,k,dvt;*psz=ip->dvt>0?ip->dvt:16;pg=ip->pg;pfrom=(int*)calloc(psz[0],sizeof(int));for(i=0,k=0;i<pg->cesz;i++){lop(pg->ce,i);if(!qp->inhib)continue;dvt=qp->dvt;das=qp->dvi;for(j=0;j<dvt;j++){if(ip==id0ptr(das[j]->_prop)){if(k>=*psz){psz[0]*=2;pfrom=(int*)realloc((void*)pfrom,psz[0]*sizeof(int));}pfrom[k]=qp->id;k++;break;}}}*psz=k;returnpfrom;}intmyfindidx(id0*ppre,intpoid){inti;Point_process**das;id0*ppo;das=ppre->dvi;for(i=0;i<ppre->dvt;i++){ppo=id0ptr(das[i]->_prop);if(ppo->id==poid)returni;}return-1;}staticvoidapplyEDOPE(id0*pcell,doublemyspkt){intpoid,prid,sz,i,idx;postgrp*pg;doubled,inc,tmp,pinc,tau,maxw;id0*ppre,*ppo;if(seadsetting!=3.)return;poid=pcell->id;pg=pcell->pg;if(pcell->dbx<-1)printf("applyEDOPE:pcell=%p\n",pcell);if(FORWELIGTR){for(i=0;i<pcell->econvsz;i++){prid=pcell->peconv[i];if(pg->lastspk[prid]<0)continue;if((d=myspkt-pg->lastspk[prid])>maxplastt)continue;if(verbose>2)printf("spk%d:%g,spk%d:%g,d=%g\n",prid,pg->lastspk[prid],poid,pg->lastspk[poid],d);ppre=getlp(pg->ce,prid);idx=myfindidx(ppre,poid);if(idx<0){printf("****applyEDOPEERR:badidx=%d!!!!!!!!!\n",idx);return;}if(!(inc=ppre->pplastinc[idx]))continue;ppre->pdope[idx]=t;if(verbose>2)printf("EDOPEA:ppre->inhib=%d,pcell->inhib=%d,d=%g,tau=%g,d/tau=%g,%d->%d\n",ppre->inhib,pcell->inhib,d,tau,d/tau,prid,poid);}}if(BACKELIGTR){if(pcell->inhib)return;for(i=0;i<pcell->dvt;i++){ppo=id0ptr(pcell->dvi[i]->_prop);poid=ppo->id;if(pg->lastspk[poid]<0)continue;if((d=myspkt-pg->lastspk[poid])<=maxplastt){if(!(inc=pcell->pplastinc[i]))continue;pcell->pdope[i]=-t;if(verbose>2)printf("EDOPEB:ppo->inhib=%d,d=%g,tau=%g,d/tau=%g,%d->%d\n",ppo->inhib,d,tau,d/tau,prid,poid);}}}}staticvoidapplyIDOPE(id0*pcell,doublemyspkt){intpoid,prid,sz,i,idx;postgrp*pg;doubled,inc,tmp,pinc,tau,maxw;id0*ppre,*ppo;if(seadsetting!=3.)return;poid=pcell->id;pg=pcell->pg;if(pcell->dbx<-1)printf("applyplast:pcell=%p\n",pcell);if(FORWELIGTR){for(i=0;i<pcell->iconvsz;i++){prid=pcell->piconv[i];if(pg->lastspk[prid]<0)continue;if((d=myspkt-pg->lastspk[prid])>maxplastt)continue;if(verbose>2)printf("spk%d:%g,spk%d:%g,d=%g\n",prid,pg->lastspk[prid],poid,pg->lastspk[poid],d);ppre=getlp(pg->ce,prid);idx=myfindidx(ppre,poid);if(idx<0){printf("****applyISSTDPERR:badidx=%d!!!!!!!!!\n",idx);return;}if(!(inc=ppre->pplastinc[idx]))continue;ppre->pdope[idx]=t;if(verbose>2)printf("IDOPEA:ppre->inhib=%d,pcell->inhib=%d,d=%g,tau=%g,d/tau=%g,%d->%d\n",ppre->inhib,pcell->inhib,d,tau,d/tau,prid,poid);}}if(BACKELIGTR){if(!pcell->inhib)return;for(i=0;i<pcell->dvt;i++){ppo=id0ptr(pcell->dvi[i]->_prop);poid=ppo->id;if(pg->lastspk[poid]<0)continue;if((d=myspkt-pg->lastspk[poid])<=maxplastt){if(!(inc=pcell->pplastinc[i]))continue;pcell->pdope[i]=-t;if(verbose>2)printf("IDOPEB:ppo->inhib=%d,d=%g,tau=%g,d/tau=%g,%d->%d\n",ppo->inhib,d,tau,d/tau,prid,poid);}}}}staticvoidapplyEXSTDP(id0*pcell,doublemyspkt){intpoid,prid,sz,i,idx;postgrp*pg;doubled,inc,tmp,pinc,tau,maxw;id0*ppre,*ppo;if(seadsetting!=3.)return;poid=pcell->id;pg=pcell->pg;if(pcell->dbx<-1)printf("applyEXSTDP:pcell=%p\n",pcell);for(i=0;i<pcell->econvsz;i++){prid=pcell->peconv[i];if(pg->lastspk[prid]<0)continue;if((d=myspkt-pg->lastspk[prid])>maxplastt)continue;if(verbose>2)printf("spk%d:%g,spk%d:%g,d=%g\n",prid,pg->lastspk[prid],poid,pg->lastspk[poid],d);ppre=getlp(pg->ce,prid);idx=myfindidx(ppre,poid);if(idx<0){printf("****applyEXSTDPERR:badidx=%d!!!!!!!!!\n",idx);return;}if(!(inc=ppre->pplastinc[idx]))continue;tau=ppre->pplasttau[idx];maxw=ppre->pplastmaxw[idx];tmp=ppre->wgain[idx];if(SOFTSTDP)inc*=(1.0-tmp/maxw);ppre->wgain[idx]+=EPOTW*inc*exp(-d/tau);if(ppre->wgain[idx]<0.)ppre->wgain[idx]=0.;elseif(!SOFTSTDP&&ppre->wgain[idx]>maxw)ppre->wgain[idx]=maxw;if(verbose>2)printf("PLAST:ppre->inhib=%d,pcell->inhib=%d,d=%g,tau=%g,d/tau=%g,%d->%d:inc=%g,wgA=%g,wgB=%g\n",ppre->inhib,pcell->inhib,d,tau,d/tau,prid,poid,inc,tmp,ppre->wgain[idx]);}if(pcell->inhib)return;for(i=0;i<pcell->dvt;i++){ppo=id0ptr(pcell->dvi[i]->_prop);poid=ppo->id;if(pg->lastspk[poid]<0)continue;if((d=myspkt-pg->lastspk[poid])<maxplastt){if(!(inc=pcell->pplastinc[i]))continue;tau=pcell->pplasttau[i];maxw=pcell->pplastmaxw[i];tmp=pcell->wgain[i];if(SOFTSTDP)inc*=(tmp/maxw);pcell->wgain[i]-=EDEPW*inc*exp(-d/tau);if(pcell->wgain[i]<0.)pcell->wgain[i]=0.;elseif(!SOFTSTDP&&pcell->wgain[i]>maxw)pcell->wgain[i]=maxw;if(verbose>2)printf("DEP:ppo->inhib=%d,d=%g,tau=%g,d/tau=%g,%d->%d:inc=%g,wgA=%g,wgB=%g\n",ppo->inhib,d,tau,d/tau,prid,poid,inc,tmp,pcell->wgain[i]);}}}staticvoidapplyIXSTDP(id0*pcell,doublemyspkt){intpoid,prid,sz,i,idx;postgrp*pg;doubled,inc,tmp,pinc,tau,maxw;id0*ppre,*ppo;if(seadsetting!=3.)return;poid=pcell->id;pg=pcell->pg;if(pcell->dbx<-1)printf("applyplast:pcell=%p\n",pcell);for(i=0;i<pcell->iconvsz;i++){prid=pcell->piconv[i];if(pg->lastspk[prid]<0)continue;if((d=myspkt-pg->lastspk[prid])>maxplastt)continue;if(verbose>2)printf("spk%d:%g,spk%d:%g,d=%g\n",prid,pg->lastspk[prid],poid,pg->lastspk[poid],d);ppre=getlp(pg->ce,prid);idx=myfindidx(ppre,poid);if(idx<0){printf("****applyISSTDPERR:badidx=%d!!!!!!!!!\n",idx);return;}if(!(inc=ppre->pplastinc[idx]))continue;tau=ppre->pplasttau[idx];maxw=ppre->pplastmaxw[idx];tmp=ppre->wgain[idx];if(SOFTSTDP)inc*=(tmp/maxw);ppre->wgain[idx]-=IDEPW*inc*exp(-d/tau);if(ppre->wgain[idx]<0.)ppre->wgain[idx]=0.;elseif(!SOFTSTDP&&ppre->wgain[idx]>maxw)ppre->wgain[idx]=maxw;if(verbose>2)printf("DEP:ppre->inhib=%d,pcell->inhib=%d,d=%g,tau=%g,d/tau=%g,%d->%d:inc=%g,wgA=%g,wgB=%g\n",ppre->inhib,pcell->inhib,d,tau,d/tau,prid,poid,inc,tmp,ppre->wgain[idx]);}if(!pcell->inhib)return;for(i=0;i<pcell->dvt;i++){ppo=id0ptr(pcell->dvi[i]->_prop);poid=ppo->id;if(pg->lastspk[poid]<0)continue;if((d=myspkt-pg->lastspk[poid])<maxplastt){if(!(inc=pcell->pplastinc[i]))continue;tau=pcell->pplasttau[i];maxw=pcell->pplastmaxw[i];tmp=pcell->wgain[i];if(SOFTSTDP)inc*=(1.0-tmp/maxw);pcell->wgain[i]+=IPOTW*inc*exp(-d/tau);if(pcell->wgain[i]<0.)pcell->wgain[i]=0.;elseif(!SOFTSTDP&&pcell->wgain[i]>maxw)pcell->wgain[i]=maxw;if(verbose>2)printf("PLAST:ppo->inhib=%d,d=%g,tau=%g,d/tau=%g,%d->%d:inc=%g,wgA=%g,wgB=%g\n",ppo->inhib,d,tau,d/tau,prid,poid,inc,tmp,pcell->wgain[i]);}}}ENDVERBATIMFUNCTIONgeteconv(){VERBATIMinti;double*x;IvocVect*voi;ip=IDP;pg=ip->pg;if(!ip->peconv)ip->peconv=getpeconv(ip,&ip->econvsz);voi=vector_arg(1);x=vector_newsize(voi,ip->econvsz);for(i=0;i<ip->econvsz;i++)x[i]=(double)ip->peconv[i];returnip->econvsz;ENDVERBATIM}FUNCTIONgeticonv(){VERBATIMinti;double*x;IvocVect*voi;ip=IDP;pg=ip->pg;if(!ip->piconv)ip->piconv=getpiconv(ip,&ip->iconvsz);voi=vector_arg(1);x=vector_newsize(voi,ip->iconvsz);for(i=0;i<ip->iconvsz;i++)x[i]=(double)ip->piconv[i];returnip->iconvsz;ENDVERBATIM}VERBATIMstaticvoidfinishdvi2(structID0*p){Point_process**da,**das;double*db,*dbs,*w1,*w1s,*w2,*w2s;char*syns,*synss;inti,dvt;db=p->del;da=p->dvi;dvt=p->dvt;syns=p->syns;dbs=(double*)malloc(dvt*sizeof(double));das=(Point_process**)malloc(dvt*sizeof(Point_process*));synss=(char*)malloc(dvt*sizeof(char));if(wsetting==1&&p->syw1&&p->syw2){w1=p->syw1;w2=p->syw2;w1s=(double*)malloc(dvt*sizeof(double));w2s=(double*)malloc(dvt*sizeof(double));gsort5(db,da,syns,w1,w2,dvt,dbs,das,synss,w1s,w2s);p->syw1=w1s;p->syw2=w2s;free(w1);free(w2);}elsegsort3(db,da,syns,dvt,dbs,das,synss);p->del=dbs;p->dvi=das;p->syns=synss;free(db);free(da);free(syns);p->sprob=(unsignedchar*)realloc((void*)p->sprob,(size_t)dvt*sizeof(char));for(i=0;i<dvt;i++)p->sprob[i]=1;p->wgain=(double*)realloc((void*)p->wgain,(size_t)dvt*sizeof(double));for(i=0;i<dvt;i++)p->wgain[i]=1.0;p->peconv=getpeconv(p,&p->econvsz);p->piconv=getpiconv(p,&p->iconvsz);if(seadsetting==3){p->pplasttau=(double*)realloc((void*)p->pplasttau,(size_t)dvt*sizeof(double));p->pplastinc=(double*)realloc((void*)p->pplastinc,(size_t)dvt*sizeof(double));p->pplastmaxw=(double*)realloc((void*)p->pplastmaxw,(size_t)dvt*sizeof(double));if(DOPE)p->pdope=(double*)realloc((void*)p->pdope,(size_t)dvt*sizeof(double));}}ENDVERBATIMPROCEDUREfinishdvir(){VERBATIMintiCell;ip=IDP;pg=ip->pg;for(iCell=0;iCell<pg->cesz;iCell++){lop(pg->ce,iCell);finishdvi2(qp);}ENDVERBATIM}PROCEDUREfinishdvi(){VERBATIMfinishdvi2(IDP);ENDVERBATIM}FUNCTIONsetplast(){VERBATIMdouble*wgain,*pplasttau,*pplastinc,*pplastmaxw;if(seadsetting!=3){printf("setplastERR0:seadsettingmustbe3,plastmodeoff!\n");return0;}ip=IDP;pg=ip->pg;if(vector_arg_px(1,&wgain)!=ip->dvt||vector_arg_px(2,&pplasttau)!=ip->dvt||vector_arg_px(3,&pplastinc)!=ip->dvt||vector_arg_px(4,&pplastmaxw)!=ip->dvt){printf("setplastERR1:inputvectorsmusthavesize%d!\n",ip->dvt);return0;}memcpy(ip->wgain,wgain,sizeof(double)*ip->dvt);memcpy(ip->pplasttau,pplasttau,sizeof(double)*ip->dvt);memcpy(ip->pplastinc,pplastinc,sizeof(double)*ip->dvt);memcpy(ip->pplastmaxw,pplastmaxw,sizeof(double)*ip->dvt);return0.0;ENDVERBATIM}FUNCTIONgetplast(){VERBATIMdouble*wgain,*pplasttau,*pplastinc,*pplastmaxw;if(seadsetting!=3){printf("getplastERR0:seadsettingmustbe3,plastmodeoff!\n");return0;}ip=IDP;pg=ip->pg;ip=IDP;pg=ip->pg;if(vector_arg_px(1,&wgain)!=ip->dvt||vector_arg_px(2,&pplasttau)!=ip->dvt||vector_arg_px(3,&pplastinc)!=ip->dvt||vector_arg_px(4,&pplastmaxw)!=ip->dvt){printf("getplastERR1:outputvectorsmusthavesize%d!\n",ip->dvt);return0;}memcpy(wgain,ip->wgain,sizeof(double)*ip->dvt);memcpy(pplasttau,ip->pplasttau,sizeof(double)*ip->dvt);memcpy(pplastinc,ip->pplastinc,sizeof(double)*ip->dvt);memcpy(pplastmaxw,ip->pplastmaxw,sizeof(double)*ip->dvt);return1.0;ENDVERBATIM}PROCEDUREsetdvi(){VERBATIM{inti,j,k,dvt,flag;double*d,*y,*ds,*w1,*w2;char*s;if(!ifarg(1)){printf("setdvi(v1,v2[,v3,flag]):v1:cell#s;v2:delays;v3:distalsynapses\n");return0;}ip=IDP;pg=ip->pg;if(ip->dead)return0;dvt=vector_arg_px(1,&y);i=vector_arg_px(2,&d);s=ifarg(3)?(char*)calloc((j=vector_arg_px(3,&ds)),sizeof(char)):0x0;if(s)for(k=0;k<j;k++)s[k]=(char)ds[k];if(ifarg(4))flag=(int)*getarg(4);elseflag=0;if(i!=dvt||i==0||(j>0&&j!=i)){printf("setdvi()ERRvecsizes:%d%d%d\n",dvt,i,j);hxe();}w1=w2=0x0;if(ifarg(5)&&wsetting!=1){printf("setdviERR:onlyuseweightvecswhenwsetting==1!\n");hxe();}if(ifarg(5)&&dvt!=vector_arg_px(5,&w1)){printf("setdviERR:wrongsizeforw1vector!\n");hxe();}if(ifarg(6)&&dvt!=vector_arg_px(6,&w2)){printf("setdviERR:wrongsizeforw2vector!\n");hxe();}setdvi2(y,d,s,dvt,flag,w1,w2);}return0;ENDVERBATIM}VERBATIMstaticvoidsetdvi2(double*y,double*d,char*s,intdvt,intflag,double*w1,double*w2){inti,j,ddvi;double*db,*dbs,*w1s,*w2s;unsignedcharpdead;unsignedintb,e;char*syns;Object*lb;Point_process*pnnt,**da,**das;ddvi=(int)DEAD_DIV;ip=IDP;pg=ip->pg;if(wsetting==1&&(!w1||!w2)){printf("setdvi2ERR:wsetting==1,mustprovidew1,w2arrays!\n");hxe();}if(flag==0){b=0;e=dvt;if(ip->dvi){free(ip->dvi);free(ip->del);free(ip->sprob);free(ip->syns);ip->dvt=0;ip->dvi=(Point_process**)0x0;ip->del=(double*)0x0;ip->sprob=(unsignedchar*)0x0;ip->syns=(char*)0x0;if(ip->wgain){free(ip->wgain);ip->wgain=0x0;}if(ip->peconv){free(ip->peconv);ip->peconv=0x0;}if(ip->piconv){free(ip->piconv);ip->piconv=0x0;}if(ip->pplasttau){free(ip->pplasttau);ip->pplasttau=0x0;}if(ip->pplastinc){free(ip->pplastinc);ip->pplastinc=0x0;}if(ip->pplastmaxw){free(ip->pplastmaxw);ip->pplastmaxw=0x0;}if(ip->pdope){free(ip->pdope);ip->pdope=0x0;}if(wsetting==1)freesywv(ip);}}else{if(ip->dvt==0){ip->dvi=(Point_process**)0x0;ip->del=(double*)0x0;ip->sprob=(unsignedchar*)0x0;ip->syns=(char*)0x0;ip->wgain=0x0;ip->peconv=0x0;ip->piconv=0x0;ip->pplasttau=0x0;ip->pplastinc=0x0;ip->pplastmaxw=0x0;ip->pdope=0x0;if(wsetting==1)freesywv(ip);}b=ip->dvt;e=ip->dvt+dvt;}da=(Point_process**)realloc((void*)ip->dvi,(size_t)(e*sizeof(Point_process*)));db=(double*)realloc((void*)ip->del,(size_t)(e*sizeof(double)));syns=(char*)realloc((void*)ip->syns,(size_t)(e*sizeof(char)));if(wsetting==1){w1s=(double*)realloc((void*)ip->syw1,(size_t)(e*sizeof(double)));w2s=(double*)realloc((void*)ip->syw2,(size_t)(e*sizeof(double)));}for(i=b,j=0;j<dvt;j++){if(!(lb=ivoc_list_item(pg->ce,(unsignedint)y[j]))){printf("INTF6:callback%gexceeds%dforlistce\n",y[j],pg->cesz);hxe();}pnnt=(Point_process*)lb->u.this_pointer;if(ddvi==1||!(pdead=id0ptr(pnnt->_prop)->dead)){da[i]=pnnt;db[i]=d[j];syns[i]=s?s[j]:0;if(wsetting==1){w1s[i]=w1[j];w2s[i]=w2[j];}i++;}}if((dvt=i)<e){da=(Point_process**)realloc((void*)da,(size_t)(dvt*sizeof(Point_process*)));db=(double*)realloc((void*)db,(size_t)(dvt*sizeof(double)));syns=(char*)realloc((void*)syns,(size_t)(dvt*sizeof(char)));if(wsetting==1){w1s=(double*)realloc((void*)w1s,(size_t)(dvt*sizeof(double)));w2s=(double*)realloc((void*)w2s,(size_t)(dvt*sizeof(double)));}}ip->dvt=dvt;ip->del=db;ip->dvi=da;ip->syns=syns;if(wsetting==1){ip->syw1=w1s;ip->syw2=w2s;}if(flag!=1)finishdvi2(ip);}ENDVERBATIMVERBATIMstaticvoidsetdvi3(double*y,double*d,char*s,intdvt,double*w1,double*w2){inti,j,ddvi;double*db,*dbs,*w1s,*w2s;unsignedcharpdead;unsignedintb,e;char*syns;Object*lb;Point_process*pnnt,**da,**das;ddvi=(int)DEAD_DIV;ip=qp;pg=ip->pg;e=dvt;da=(Point_process**)realloc((void*)ip->dvi,(size_t)(e*sizeof(Point_process*)));db=(double*)realloc((void*)ip->del,(size_t)(e*sizeof(double)));syns=(char*)realloc((void*)ip->syns,(size_t)(e*sizeof(char)));w1s=(double*)realloc((void*)ip->syw1,(size_t)(e*sizeof(double)));w2s=(double*)realloc((void*)ip->syw2,(size_t)(e*sizeof(double)));for(i=0,j=0;j<dvt;i++,j++){if(!(lb=ivoc_list_item(pg->ce,(unsignedint)y[j]))){printf("INTF6:callback%gexceeds%dforlistce\n",y[j],pg->cesz);hxe();}pnnt=(Point_process*)lb->u.this_pointer;if(ddvi==1||!(pdead=id0ptr(pnnt->_prop)->dead)){da[i]=pnnt;db[i]=d[j];syns[i]=s?s[j]:0;w1s[i]=w1[j];w2s[i]=w2[j];}}ip->dvt=dvt;ip->del=db;ip->dvi=da;ip->syns=syns;ip->syw1=w1s;ip->syw2=w2s;finishdvi2(ip);}ENDVERBATIMPROCEDUREprune(){VERBATIM{id0*ppost;double*x,p;intnx,j,potype;ip=IDP;pg=ip->pg;if(hoc_is_double_arg(1)){p=*getarg(1);if(p<0||p>1){printf("INTF6:pruneERR0:need#[0,1]toprune[ALL,NONE]:%g\n",p);hxe();}if(p==1.)printf("INTF6pruneWARNING:pruning100%%ofcell%d\n",ip->id);if(verbose&&ip->dvt>dscrsz){printf("INTF6pruneB:Divexceedsdscrsz:%d>%d\n",ip->dvt,dscrsz);hxe();}if(p==0.){for(j=0;j<ip->dvt;j++)ip->sprob[j]=1;return0;}potype=ifarg(2)?(int)*getarg(2):-1;sead=(ifarg(3))?(unsignedint)*getarg(3):GetDVIDSeedVal(ip->id);mcell_ran4(&sead,dscr,ip->dvt,1.0);if(potype==-1){for(j=0;j<ip->dvt;j++)if(dscr[j]<p)ip->sprob[j]=0;}else{for(j=0;j<ip->dvt;j++){ppost=id0ptr(ip->dvi[j]->_prop);if(ppost->type==potype&&dscr[j]<p)ip->sprob[j]=0;}}}else{if(verbose)printf("INTF6WARNINGprune(vec)deprecated:useintf.sprob(vec)instead\n");nx=vector_arg_px(1,&x);if(nx!=ip->dvt){printf("INTF6:pruneERRA:Wrongsizevector:%d!=%d\n",nx,ip->dvt);hxe();}for(j=0;j<ip->dvt;j++)ip->sprob[j]=(unsignedchar)x[j];}}return0;ENDVERBATIM}PROCEDUREsprob(){VERBATIM{double*x;intnx,j;ip=IDP;pg=ip->pg;nx=vector_arg_px(1,&x);if(nx!=ip->dvt){printf("INTF6:pruneERRA:Wrongsizevector:%d!=%d\n",nx,ip->dvt);hxe();}if(ifarg(2)){if(!hoc_is_str_arg(2)){printf("INTF6sprob()ERRA:onlylegit2ndargis'GET'\n");hxe();}elsefor(j=0;j<ip->dvt;j++)x[j]=(double)ip->sprob[j];}else{for(j=0;j<ip->dvt;j++)ip->sprob[j]=(unsignedchar)x[j];}}ENDVERBATIM}PROCEDUREturnoff(){VERBATIM{intnx,ny,i,j,k,dvt;doublepoid,*x,*y;Point_process**das;unsignedcharoff;ip=IDP;pg=ip->pg;nx=vector_arg_px(1,&x);ny=vector_arg_px(2,&y);if(ifarg(3))off=(unsignedchar)*getarg(3);elseoff=0;for(i=0;i<nx;i++){lop(pg->ce,(unsignedint)x[i]);dvt=qp->dvt;das=qp->dvi;for(j=0;j<dvt;j++){ip=id0ptr(das[j]->_prop);poid=(double)ip->id;for(k=0;k<ny;k++){if(poid==y[k]){qp->sprob[j]=off;break;}}}}}ENDVERBATIM}VERBATIMvoidgsort2(double*db,Point_process**da,intdvt,double*dbs,Point_process**das){inti;scr=scrset(dvt);for(i=0;i<dvt;i++)scr[i]=i;nrn_mlh_gsort(db,(int*)scr,dvt,cmpdfn);for(i=0;i<dvt;i++){dbs[i]=db[scr[i]];das[i]=da[scr[i]];}}voidgsort3(double*db,Point_process**da,char*syns,intdvt,double*dbs,Point_process**das,char*synss){inti;scr=scrset(dvt);for(i=0;i<dvt;i++)scr[i]=i;nrn_mlh_gsort(db,(int*)scr,dvt,cmpdfn);for(i=0;i<dvt;i++){dbs[i]=db[scr[i]];das[i]=da[scr[i]];synss[i]=syns[scr[i]];}}voidgsort5(double*db,Point_process**da,char*syns,double*w1,double*w2,intdvt,double*dbs,Point_process**das,char*synss,double*w1s,double*w2s){inti;scr=scrset(dvt);for(i=0;i<dvt;i++)scr[i]=i;nrn_mlh_gsort(db,(int*)scr,dvt,cmpdfn);for(i=0;i<dvt;i++){dbs[i]=db[scr[i]];das[i]=da[scr[i]];synss[i]=syns[scr[i]];w1s[i]=w1[scr[i]];w2s[i]=w2[scr[i]];}}staticvoidfreedvi2(structID0*jp){if(jp->dvi){free(jp->dvi);free(jp->del);free(jp->sprob);free(jp->syns);if(jp->wgain){free(jp->wgain);jp->wgain=0x0;}if(jp->peconv){free(jp->peconv);jp->peconv=0x0;}if(jp->piconv){free(jp->piconv);jp->piconv=0x0;}if(ip->pplasttau){free(ip->pplasttau);ip->pplasttau=0x0;}if(ip->pplastinc){free(ip->pplastinc);ip->pplastinc=0x0;}if(ip->pplastmaxw){free(ip->pplastmaxw);ip->pplastmaxw=0x0;}if(ip->pdope){free(ip->pdope);ip->pdope=0x0;}jp->dvt=0;jp->dvi=(Point_process**)0x0;jp->del=(double*)0x0;jp->sprob=(unsignedchar*)0x0;jp->syns=(char*)0x0;}}ENDVERBATIMPROCEDUREfreedvi(){VERBATIM{id0*jp;jp=IDP;freedvi2(jp);}ENDVERBATIM}FUNCTIONqstats(){VERBATIM{doublestt[3];intlct,flag;FILE*tfo;if(ifarg(1)){tfo=hoc_obj_file_arg(1);flag=1;}elseflag=0;lct=cty[IDP->type];_lqstats=nrn_event_queue_stats(stt);printf("SPIKES:%d(%ld:%ld)\n",IDP->spkcnt,spikes[lct],blockcnt[lct]);printf("QUEUE:Inserted%g;removed%g\n",stt[0],stt[2]);if(flag){fprintf(tfo,"SPIKES:%d(%ld:%ld);",IDP->spkcnt,spikes[lct],blockcnt[lct]);fprintf(tfo,"QUEUE:Inserted%g;removed%gremaining:%g\n",stt[0],stt[2],_lqstats);}}ENDVERBATIM}FUNCTIONqsz(){VERBATIM{doublestt[3];_lqsz=nrn_event_queue_stats(stt);}ENDVERBATIM}PROCEDUREqclr(){VERBATIM{clear_event_queue();}ENDVERBATIM}FUNCTIONmywmat(){VERBATIM{inti,j,k;i=(int)*getarg(1);if(i<0||i>=CTYPi){printf("mywmatERR:arg1=%doutofbounds(0,%d]\n",i,CTYPi);return-1;}j=(int)*getarg(2);if(j<0||j>=CTYPi){printf("mywmatERR:arg2=%doutofbounds(0,%d]\n",j,CTYPi);return-1;}k=(int)*getarg(3);if(k<0||k>=STYPi){printf("mywmatERR:arg3=%doutofbounds(0,%d]\n",k,STYPi);return-1;}returnWMAT(i,j,k);}ENDVERBATIM}PROCEDUREmywmatpr(){VERBATIM{doublewm;inti,j,k;char*ct1,*ct2;ip=IDP;pg=ip->pg;for(i=0;i<CTYPi;i++)if(ctt(i,&ct1)!=0){for(j=0;j<CTYPi;j++)if(ctt(j,&ct2)!=0){for(k=0;k<STYPi;k++){if((wm=WMAT(i,j,k))>0){printf("wmat[%s][%s][%d]=%g\n",ct1,ct2,k,wm);}}}}}ENDVERBATIM}PROCEDUREcinit(){VERBATIM{Symbol*sym;inti,j;unsignedintsz,colid;char*name;pg=(postgrp*)calloc(1,sizeof(postgrp));colid=(int)*getarg(2);if(ppg==0x0){ippgbufsz=5;ppg=(postgrp**)calloc(ippgbufsz,sizeof(postgrp*));inumcols=1;}elseinumcols++;if(inumcols>=ippgbufsz){ippgbufsz*=2;ppg=(postgrp**)realloc((void*)ppg,(size_t)ippgbufsz*sizeof(postgrp*));}ppg[inumcols-1]=pg;pg->col=colid;pg->ce=*hoc_objgetarg(1);sym=hoc_lookup("CTYP");CTYP=(*(hoc_objectdata[sym->u.oboff].pobj));if(installed==2.0){sz=ivoc_list_count(pg->ce);if(sz==pg->cesz&&colid==0)printf("\t****INTF6WARNINGceszunchanged:INTF6(s)createdoff-list****\n");}elseinstalled=2.0;pg->cesz=ivoc_list_count(pg->ce);if(verbose)printf("cesz=%d\n",pg->cesz);pg->lastspk=(double*)calloc(pg->cesz,sizeof(double));CTYPi=HVAL("CTYPi");STYPi=HVAL("STYPi");dscrsz=HVAL("scrsz");dscr=HPTR("scr");pg->ix=hoc_pgetarg(3);pg->ixe=hoc_pgetarg(4);pg->numc=hoc_pgetarg(5);if(verbose){printf("CTYPi=%d\n",CTYPi);for(i=0;i<CTYPi;i++)printf("ix[%d]=%g,ixe[%d]=%g\n",i,pg->ix[i],i,pg->ixe[i]);}if(!pg->ce){printf("INTF6cinit()ERRA:cenotfound\n");hxe();}if(ivoc_list_count(CTYP)!=CTYPi){printf("INTF6cinit()ERRB:%d%d\n",ivoc_list_count(CTYP),CTYPi);hxe();}for(i=0;i<pg->cesz;i++){lop(pg->ce,i);qp->pg=pg;}printf("Checkingforpossiblesegerrorindoublearrays:CTYPi==%d:",CTYPi);printf("%d%g\n",dscrsz,dscr[dscrsz-1]);for(i=0,j=0;i<CTYPi;i++)if(ctt(i,&name)!=0){cty[j]=i;CNAME[j]=strdup(name);ctymap[i]=j;j++;if(j>=CTYPp){printf("jitcondiv()INTERRA\n");hxe();}}CTYN=j;for(i=0;i<CTYN;i++)printf("%s(%d)=%g",CNAME[i],cty[i],NUMC(cty[i]));printf("\n%dcelltypesbeingusedincol%d\n",CTYN,colid);}ENDVERBATIM}PROCEDUREjitcondiv(){VERBATIM{Symbol*sym;inti,j;unsignedintsz,colid;char*name;pg=(postgrp*)calloc(1,sizeof(postgrp));colid=(int)*getarg(2);if(ppg==0x0){ippgbufsz=5;ppg=(postgrp**)calloc(ippgbufsz,sizeof(postgrp*));inumcols=1;}elseinumcols++;if(inumcols>=ippgbufsz){ippgbufsz*=2;ppg=(postgrp**)realloc((void*)ppg,(size_t)ippgbufsz*sizeof(postgrp*));}ppg[inumcols-1]=pg;pg->col=colid;pg->ce=*hoc_objgetarg(1);sym=hoc_lookup("CTYP");CTYP=(*(hoc_objectdata[sym->u.oboff].pobj));if(installed==2.0){sz=ivoc_list_count(pg->ce);if(sz==pg->cesz&&colid==0)printf("\t****INTF6WARNINGceszunchanged:INTF6(s)createdoff-list****\n");}elseinstalled=2.0;pg->cesz=ivoc_list_count(pg->ce);if(verbose)printf("cesz=%d\n",pg->cesz);pg->lastspk=(double*)calloc(pg->cesz,sizeof(double));CTYPi=HVAL("CTYPi");STYPi=HVAL("STYPi");dscrsz=HVAL("scrsz");dscr=HPTR("scr");pg->ix=hoc_pgetarg(3);pg->ixe=hoc_pgetarg(4);if(verbose){printf("CTYPi=%d\n",CTYPi);for(i=0;i<CTYPi;i++)printf("ix[%d]=%g,ixe[%d]=%g\n",i,pg->ix[i],i,pg->ixe[i]);}pg->dvg=hoc_pgetarg(5);pg->numc=hoc_pgetarg(6);pg->wmat=hoc_pgetarg(7);pg->wd0=hoc_pgetarg(8);pg->delm=hoc_pgetarg(9);pg->deld=hoc_pgetarg(10);if(!pg->ce){printf("INTF6jitcondivERRA:cenotfound\n");hxe();}if(ivoc_list_count(CTYP)!=CTYPi){printf("INTF6jitcondivERRB:%d%d\n",ivoc_list_count(CTYP),CTYPi);hxe();}for(i=0;i<pg->cesz;i++){lop(pg->ce,i);qp->pg=pg;}printf("Checkingforpossiblesegerrorindoublearrays:CTYPi==%d:",CTYPi);printf("%d%d%d",DVG(CTYPi-1,CTYPi-1),(int)pg->ix[CTYPi-1],(int)pg->ixe[CTYPi-1]);printf("%g%g",WMAT(CTYPi-1,CTYPi-1,STYPi-1),WD0(CTYPi-1,CTYPi-1,STYPi-1));printf("%g%g",DELM(CTYPi-1,CTYPi-1),DELD(CTYPi-1,CTYPi-1));printf("%d%g\n",dscrsz,dscr[dscrsz-1]);for(i=0,j=0;i<CTYPi;i++)if(ctt(i,&name)!=0){cty[j]=i;CNAME[j]=strdup(name);ctymap[i]=j;j++;if(j>=CTYPp){printf("jitcondiv()INTERRA\n");hxe();}}CTYN=j;for(i=0;i<CTYN;i++)printf("%s(%d)=%g",CNAME[i],cty[i],NUMC(cty[i]));printf("\n%dcelltypesbeingusedincol%d\n",CTYN,colid);}ENDVERBATIM}PROCEDUREjitrec(){VERBATIM{inti;ip=IDP;pg=ip->pg;if(verbose>1)printf("jitrecfromcol%d,ip=%p,pg=%p\n",ip->col,ip,pg);if(!ifarg(2)){pg->jrmax=0;pg->jridv=0x0;pg->jrtvv=0x0;return0;}i=vector_arg_px(1,&pg->jrid);pg->jrmax=vector_arg_px(2,&pg->jrtv);pg->jridv=vector_arg(1);pg->jrtvv=vector_arg(2);pg->jrmax=vector_buffer_size(pg->jridv);if(pg->jrmax!=vector_buffer_size(pg->jrtvv)){printf("jitrec()ERRA:notsamesize:%d%d\n",i,pg->jrmax);pg->jrmax=0;hxe();}pg->jri=pg->jrj=0;}return0;ENDVERBATIM}FUNCTIONscsv(){VERBATIM{intty=4;inti,j;unsignedintcnt=0;ip=IDP;pg=ip->pg;name=gargstr(1);if(!(wf1=fopen(name,"w"))){printf("Can'topen%s\n",name);hxe();}fwrite(&pg->cesz,sizeof(int),1,wf1);fwrite(&ty,sizeof(int),1,wf1);for(i=0,j=0;i<pg->cesz;i++,j++){lop(pg->ce,i);if(qp->spkcnt){dscr[j]=(double)(qp->spkcnt);cnt++;}elsedscr[j]=0.0;if(j>=dscrsz){fwrite(dscr,(size_t)sizeof(double),(size_t)dscrsz,wf1);fflush(wf1);j=0;}}if(j>0)fwrite(dscr,(size_t)sizeof(double),(size_t)j,wf1);fclose(wf1);_lscsv=(double)cnt;}ENDVERBATIM}FUNCTIONspkcnt(){VERBATIM{intnx,ny,i,j,ix,c,min,max,flag;unsignedintsum;double*y,*x;ip=IDP;pg=ip->pg;nx=ny=min=max=flag=0;i=1;if(ifarg(i)){if(hoc_is_object_arg(i)){ny=vector_arg_px(i,&y);i++;}elseif(ifarg(i+1)){min=(int)*getarg(i);max=(int)*getarg(i+1);i+=2;}}while(ifarg(i)){if(hoc_is_object_arg(i)){nx=vector_arg_px(i,&x);}elseflag=(int)*getarg(i);i++;}if(ny)max=ny;elseif(max==0)max=pg->cesz;elsemax+=1;if(nx&&nx!=max-min){printf("INTF6spkcnt()ERR:Vectorsnotsamesize%d%d\n",nx,max-min);hxe();}for(i=min,sum=0;i<max;i++){if(ny)lop(pg->ce,(int)y[i]);elselop(pg->ce,i);if(flag==2)sum+=(c=qp->blkcnt);elsesum+=(c=qp->spkcnt);if(nx)x[i]=(double)c;if(flag==1)qp->spkcnt=qp->blkcnt=0;}_lspkcnt=(double)sum;}ENDVERBATIM}PROCEDUREprobejcd(){VERBATIM{inti,a[4];ip=IDP;pg=ip->pg;for(i=1;i<=3;i++)a[i]=(int)*getarg(i);printf("CTYPi:%d,STYPi:%d,",CTYPi,STYPi);printf("wmat:%g,wd0:%g\n",WMAT(a[1],a[2],a[3]),WD0(a[1],a[2],a[3]));}ENDVERBATIM}PROCEDURErandspk(){VERBATIMip=IDP;pg=ip->pg;if(ip->rvi>ip->rve){ip->input=0;}elseif(t==0){nxt=pg->vsp[ip->rvi];EXSY=pg->sysp[ip->rvi];WEX=pg->wsp[ip->rvi++];}else{while((nxt=pg->vsp[ip->rvi++]-t)<=1e-6){if(ip->rvi-1>ip->rve){printf("randspk()ERRA:");chk(2.);hxe();}}EXSY=pg->sysp[ip->rvi-1];WEX=pg->wsp[ip->rvi-1];}ENDVERBATIM}PROCEDUREvers(){printf("$Id}VERBATIMvoidval(doublexx,doubleta){vii[1]=VAM*EXP(-(xx-ta)/tauAM);vii[2]=VNM*EXP(-(xx-ta)/tauNM);vii[3]=VGA*EXP(-(xx-ta)/tauGA);vii[5]=AHP*EXP(-(xx-ta)/tauahp);vii[8]=VAM2*EXP(-(xx-ta)/tauAM2);vii[9]=VNM2*EXP(-(xx-ta)/tauNM2);vii[10]=VGA2*EXP(-(xx-ta)/tauGA2);vii[6]=vii[1]+vii[2]+vii[3]+vii[4]+vii[5]+vii[8]+vii[9]+vii[10];vii[7]=VTH+(VTHR-VTH)*EXP(-(xx-trrs)/tauRR)-RMP;}ENDVERBATIMVERBATIMvoidvalps(doublexx,doubleta){vii[1]=VAM*EXP(-(xx-ta)/tauAM);vii[2]=VNM*EXP(-(xx-ta)/tauNM);vii[3]=VGA*EXP(-(xx-ta)/tauGA);vii[8]=VAM2*EXP(-(xx-ta)/tauAM2);vii[9]=VNM2*EXP(-(xx-ta)/tauNM2);vii[10]=VGA2*EXP(-(xx-ta)/tauGA2);vii[6]=vii[1]+vii[2]-vii[3]+vii[8]+vii[9]-vii[10];}ENDVERBATIMPROCEDURErecord(){VERBATIM{inti,j,k,nz;doubleti;vp=SOP;if(!vp){printf("****recordERRA:vp=NULL!\n");return0;}if(tg>=t)return0;if(ip->record==1){while((int)vp->p>=(int)vp->size-(int)((t-tg)/vdt)-10){vp->size*=2;for(k=0;k<NSV;k++)if(vp->vv[k]!=0x0)vp->vvo[k]=vector_newsize(vp->vv[k],vp->size);}}elseif((int)vp->p>(int)vp->size-(int)((t-tg)/vdt)){nz=(int)((t-tg)/vdt);for(k=0;k<NSV;k++)if(vp->vv[k]!=0x0){if(nz>vp->size){pid();printf("RecordWARNING:vectooshort:%d%d\n",nz,vp->size);vp->p=0;}else{for(i=nz,j=0;i<vp->size;i++,j++)vp->vvo[k][j]=vp->vvo[k][i];vp->p=vp->size-nz;}}}for(ti=tg;ti<=t&&vp->p<vp->size;ti+=vdt,vp->p++){val(ti,tg);if(vp->vvo[0]!=0x0)vp->vvo[0][vp->p]=ti;for(k=1;k<NSV-1;k++)if(vp->vvo[k]!=0x0){vp->vvo[k][vp->p]=vii[k]+RMP;}for(;k<NSV;k++)if(vp->vvo[k]!=0x0){vp->vvo[k][vp->p]=vii[k];}}tg=t;}ENDVERBATIM}PROCEDURErecspk(x){VERBATIM{vp=SOP;record();if(vp->p>vp->size||vp->vvo[6]==0)return0;if(vp->p>0){if(vp->vvo[0]!=0x0)vp->vvo[0][vp->p-1]=_lx;vp->vvo[6][vp->p-1]=spkht;}else{if(vp->vvo[0]!=0x0)vp->vvo[0][0]=_lx;vp->vvo[6][0]=spkht;}tg=_lx;}ENDVERBATIM}PROCEDURErecclr(){VERBATIM{intk;if(IDP->record){if(SOP!=nil){vp=SOP;vp->size=0;vp->p=0;for(k=0;k<NSV;k++){vp->vv[k]=nil;vp->vvo[k]=nil;}}elseprintf("INTF6recclrERR:nilpointer\n");}IDP->record=0;}ENDVERBATIM}PROCEDURErecfree(){VERBATIMif(SOP!=nil){free(SOP);SOP=nil;}elseprintf("INTF6recfreeERR:nilpointer\n");IDP->record=0;ENDVERBATIM}PROCEDUREinitvspks(){VERBATIM{intmax,i,err;doublelast,lstt;ip=IDP;pg=ip->pg;if(!ifarg(1)){printf("Returninitvspks(indices,times,weights,syntypes)\n");return0.;}if(verbose>1)printf("initvspks:col=%d,ip=%p,pg=%p,pg->isp=%p\n",ip->col,ip,pg,pg->isp);if(pg->isp!=NULL)clrvspks();ip=IDP;pg=ip->pg;err=0;i=vector_arg_px(1,&pg->isp);max=vector_arg_px(2,&pg->vsp);if(max!=i){err=1;printf("initvspksERR:vecsofdifferentsize\n");}if(max==0){err=1;printf("initvspksERR:vecnotinitialized\n");}max=vector_arg_px(3,&pg->wsp);if(max!=i){err=1;printf("initvspksERR:3rdvecisofdifferentsize\n");}max=vector_arg_px(4,&pg->sysp);if(max!=i){err=1;printf("initvspksERR:4thvecisofdifferentsize\n");}pg->vspn=max;if(!pg->ce){printf("Needglobalceforinitvspks()sinceintf.mod501\n");hxe();}for(i=0,last=-1;i<max;){if(pg->isp[i]!=last){lop(pg->ce,(unsignedint)pg->isp[i]);qp->rvb=qp->rvi=i;qp->vinflg=qp->input=1;last=pg->isp[i];lstt=pg->vsp[i];i++;}for(;i<max&&pg->isp[i]==last;i++){if(pg->vsp[i]<=lstt){pg->vsp[i]=lstt+0.00001;printf("initvspksERR:nonmonotonicforcell#%d:%g%g\n",qp->id,lstt,pg->vsp[i]);}lstt=pg->vsp[i];}qp->rve=i-1;if(subsvint>0){pg->vsp[qp->rve]=pg->vsp[qp->rvb]+subsvint;pg->wsp[qp->rve]=pg->wsp[qp->rvb];}if(err){qp->rve=0;hxe();}}}ENDVERBATIM}PROCEDUREshock(){VERBATIM{intmax,i,err;doublelast,lstt,*isp,*vsp,*wsp;printf("WARNING:Thisroutineappearstobedefunct--pleasecheckcodeinintf6.mod\n");if(!ifarg(1)){printf("Returnshock(ivspks,vspks,wvspks)\n");return0.;}ip=IDP;pg=ip->pg;err=0;i=vector_arg_px(1,&isp);max=vector_arg_px(2,&vsp);if(max!=i){err=1;printf("shockERR:vecsofdifferentsize\n");}if(max==0){err=1;printf("shockERR:vecnotinitialized\n");}max=vector_arg_px(3,&wsp);if(max!=i){err=1;printf("shockERR:3rdvecisofdifferentsize\n");}pg->vspn=max;if(!pg->ce){printf("Needglobalceforshock()\n");hxe();}for(i=0,last=-1;i<max;){if(isp[i]!=last){lop(pg->ce,(unsignedint)isp[i]);WEX=-1e9;EXSY=AM;#ifdefined(t)net_send((void**)0x0,wts,pmt,t+vsp[i],2.0);#elsenet_send((void**)0x0,wts,pmt,vsp[i],2.0);#endifi++;}}}ENDVERBATIM}PROCEDUREclrvspks(){VERBATIM{unsignedinti;ip=IDP;pg=ip->pg;if(verbose>1)printf("clrvspks:col=%d,ip=%p,pg=%p,pg->isp=%p\n",ip->col,ip,pg,pg->isp);for(i=0;i<pg->cesz;i++){lop(pg->ce,i);qp->vinflg=0;}}ENDVERBATIM}PROCEDUREtrvsp(){VERBATIMinti,flag;doubleind,local_t0;ip=IDP;pg=ip->pg;flag=(int)*getarg(1);if(subsvint==0.){printf("trvsp");return(0.);}ind=pg->isp[0];local_t0=pg->vsp[0];if(flag==1){for(i=0;i<pg->vspn;i++){if(pg->isp[i]!=ind){pg->vsp[i-1]=1.e9;ind=pg->isp[i];}}pg->vsp[pg->vspn-1]=1.e9;}elseif(flag==2){for(i=0;i<pg->vspn;i++){if(pg->isp[i]!=ind){pg->vsp[i-1]=local_t0+subsvint;ind=pg->isp[i];local_t0=pg->vsp[i];}}pg->vsp[pg->vspn-1]=local_t0+subsvint;}else{printf("trvspflag%dnotrecognized\n",flag);hxe();}ENDVERBATIM}PROCEDUREinitjttr(){VERBATIM{intmax,i,err=0;ip=IDP;pg=ip->pg;pg->jtpt=0;if(!ifarg(1)){printf("Returninitjttr(vec)\n");return(0.);}max=vector_arg_px(1,&jsp);if(max==0){err=1;printf("initjttrERR:vecnotinitialized\n");}for(i=0;i<max;i++)if(jsp[i]<=0){err=1;printf("initjttrERR:vecshouldbe>0:%g\n",jsp[i]);}if(err){jsp=nil;pg->jtmax=0.;return(0.);}if(max!=pg->jtmax){printf("WARNING:resettingjtmax_INTF6to%d\n",max);pg->jtmax=max;}}ENDVERBATIM}VERBATIMstaticid0*getlp(Object*ob,unsignedinti){Object*lb;id0*myp;lb=ivoc_list_item(ob,i);if(!lb){printf("INTF6:getlp%dexceeds%dforlistce\n",i,pg->cesz);hxe();}pmt=ob2pntproc(lb);myp=id0ptr(pmt->_prop);returnmyp;}staticid0*lop(Object*ob,unsignedinti){Object*lb;lb=ivoc_list_item(ob,i);if(!lb){printf("INTF6:lop%dexceeds%dforlistce\n",i,pg->cesz);hxe();}pmt=ob2pntproc(lb);qp=id0ptr(pmt->_prop);returnqp;}staticid0*lopr(Object*ob,unsignedinti){id0*myp;myp=lop(ob,i);_hoc_setdata(pmt);returnmyp;}voidstoppo(){}staticintctt(unsignedinti,char**name){Object*lb;if(NUMC(i)==0)return0;lb=ivoc_list_item(CTYP,i);if(!lb){printf("INTF6:ctt%dexceeds%dforlistCTYP\n",i,CTYPi);hxe();}{*name=*(lb->u.dataspace->ppstr);}return(int)NUMC(i);}ENDVERBATIMPROCEDUREtest(){VERBATIMchar*str;intx;x=ctt(7,&str);printf("%s(%d)\n",str,x);ENDVERBATIM}PROCEDURElof(){VERBATIM{Object*ob;intnum,i,ii,j,k,si,nx;double*vvo[7],*par;IvocVect*vv[7];ob=*(hoc_objgetarg(1));si=(int)*getarg(2);num=ivoc_list_count(ob);if(num!=7){printf("INTF6lofERR%d>7\n",num);hxe();}for(i=0;i<num;i++){j=list_vector_px3(ob,i,&vvo[i],&vv[i]);if(i==0)nx=j;if(j!=nx){printf("INTF6lofERR%d%d\n",j,nx);hxe();}}}ENDVERBATIM}PROCEDUREinitinvl(){printf("initinvl()NOTBEINGUSED\n")}FUNCTIONinvlflag(){VERBATIMip=IDP;pg=ip->pg;if(ip->invl0==1&&invlp==nil){printf("INTF6invlflagERR:pointernotinitialized\n");hoc_execerror("",0);}_linvlflag=(double)ip->invl0;ENDVERBATIM}FUNCTIONshift(vl){VERBATIMdoubleexpand,tmp,min,max;if((t<(invlt-invl)+invl/2)&&invlt!=-1){_lshift=0.;}else{expand=-(_lvl-(-65))/20;if(expand>1.)expand=1.;if(expand<-1.)expand=-1.;if(expand>0.){max=1.5*invl;tmp=oinvl+0.8*expand*(max-oinvl);}else{min=0.5*invl;tmp=oinvl+0.8*expand*(oinvl-min);}if(invlt+tmp<t+2){_lshift=0.;}else{oinvl=tmp;_lshift=invlt+oinvl;}}ENDVERBATIM}PROCEDURErecini(){VERBATIM{intk;if(SOP==nil){printf("INTF6recordERR:pointernotinitialized\n");hoc_execerror("",0);}else{vp=SOP;vp->p=0;for(k=0;k<NSV;k++)if(vp->vvo[k]!=0)vector_resize(vp->vv[k],vp->size);}}ENDVERBATIM}PROCEDUREfini(){VERBATIM{intk;IDP->rvi=IDP->rvb;if(IDP->wrec){wrecord(1e9);}if(IDP->record){record();for(k=0;k<NSV;k++)if(vp->vvo[k]!=0){vector_resize(vp->vv[k],vp->p);}}}ENDVERBATIM}PROCEDUREchk(f){VERBATIM{inti,lfg;lfg=(int)_lf;ip=IDP;pg=ip->pg;printf("ID:%d;typ:%d;rec:%dwrec:%dinp:%djtt:%dinvl:%d\n",ip->id,ip->type,ip->record,ip->wrec,ip->input,ip->jttr,ip->invl0);if(lfg==1){if(SOP!=nil){vp=SOP;printf("p%dsize%dtg%g\n",vp->p,vp->size,tg);for(i=0;i<NSV;i++)if(vp->vv[i])printf("%d%p%p;",i,vp->vv[i],vp->vvo[i]);}elseprintf("Recordingpointersnotinitialized");}if(lfg==2){printf("Globalvectorsforinputandjitter(jttr):\n");if(pg->vsp!=nil)printf("VSP:%p(%d/%d-%d)\n",pg->vsp,ip->rvi,ip->rvb,ip->rve);elseprintf("noVSP\n");if(jsp!=nil)printf("JSP:%p(%d/%d)\n",jsp,pg->jtpt,pg->jtmax);elseprintf("noJSP\n");}if(lfg==3){if(pg->vsp!=nil){printf("VSP:(%d/%d-%d)\n",ip->rvi,ip->rvb,ip->rve);for(i=ip->rvb;i<=ip->rve;i++)printf("%d:%g",i,pg->vsp[i]);printf("\n");}elseprintf("noVSP\n");}if(lfg==4){}if(lfg==5){printf("wwpt%dwwsz%d\nWWvecs:",wwpt,wwsz);printf("wwwid%gwwht%dnsw%g\nWWvecs:",wwwid,(int)wwht,nsw);for(i=0;i<NSW;i++)printf("%d%p%p;",i,ww[i],wwo[i]);}}ENDVERBATIM}FUNCTIONpid(){VERBATIMprintf("INTF6%d(%d/%d@%g)",IDP->id,IDP->type,IDP->col,t);_lpid=(double)IDP->id;ENDVERBATIM}FUNCTIONid(){VERBATIMif(ifarg(1))IDP->id=(unsignedint)*getarg(1);_lid=(double)IDP->id;ENDVERBATIM}FUNCTIONtype(){VERBATIMif(ifarg(1))IDP->type=(unsignedchar)*getarg(1);_ltype=(double)IDP->type;ENDVERBATIM}FUNCTIONcol(){VERBATIMip=IDP;if(ifarg(1))ip->col=(unsignedint)*getarg(1);_lcol=(double)ip->col;ENDVERBATIM}FUNCTIONgid(){VERBATIMip=IDP;if(ifarg(1))ip->gid=(unsignedint)*getarg(1);_lgid=(double)ip->gid;ENDVERBATIM}FUNCTIONdbx(){VERBATIMip=IDP;if(ifarg(1))ip->dbx=(unsignedchar)*getarg(1);_ldbx=(double)ip->dbx;ENDVERBATIM}PROCEDUREinitrec(){VERBATIM{inti;name=gargstr(1);if(SOP==nil){IDP->record=1;SOP=(vpt*)ecalloc(1,sizeof(vpt));SOP->size=0;}if(IDP->record==0){recini();IDP->record=1;}vp=SOP;i=(int)varnum();if(i==-1){printf("INTF6recordERR%snotrecognized\n",name);hoc_execerror("",0);}vp->vv[i]=vector_arg(2);vector_arg_px(2,&(vp->vvo[i]));if(vp->size==0){vp->size=(unsignedint)vector_buffer_size(vp->vv[i]);}elseif(vp->size!=(unsignedint)vector_buffer_size(vp->vv[i])){printf("INTF6initrecERRvectorsnotallsamesize:%dvs%d",vp->size,vector_buffer_size(vp->vv[i]));hoc_execerror("",0);}}ENDVERBATIM}FUNCTIONvarnum(){LOCALii=-1VERBATIMif(strcmp(name,"time")==0){_li=0.;}elseif(strcmp(name,"VAM")==0){_li=1.;}elseif(strcmp(name,"VNM")==0){_li=2.;}elseif(strcmp(name,"VGA")==0){_li=3.;}elseif(strcmp(name,"AHP")==0){_li=5.;}elseif(strcmp(name,"V")==0){_li=6.;}elseif(strcmp(name,"VM")==0){_li=6.;}elseif(strcmp(name,"VTHC")==0){_li=7.;}elseif(strcmp(name,"VAM2")==0){_li=8.;}elseif(strcmp(name,"VNM2")==0){_li=9.;}elseif(strcmp(name,"VGA2")==0){_li=10.;}ENDVERBATIMvarnum=i}PROCEDUREvecname(){VERBATIMinti;i=(int)*getarg(1);if(i==0)printf("time\n");elseif(i==1)printf("VAM\n");elseif(i==2)printf("VNM\n");elseif(i==3)printf("VGA\n");elseif(i==5)printf("AHP\n");elseif(i==6)printf("V\n");elseif(i==7)printf("VTHC\n");elseif(i==8)printf("VAM2\n");elseif(i==9)printf("VNM2\n");elseif(i==10)printf("VGA2\n");ENDVERBATIM}PROCEDUREinitwrec(){VERBATIM{inti,k,num,cap;Object*ob;ob=*hoc_objgetarg(1);num=ivoc_list_count(ob);if(num>NSW){printf("INTF6initwrec()WARN:canonlystore%dwwvecs\n",NSW);hxe();}nsw=(double)num;for(k=0;k<num;k++){cap=list_vector_px2(ob,k,&wwo[k],&ww[k]);if(k==0)wwsz=cap;elseif(wwsz!=cap){printf("INTF6initwrecERRw-vecssizeerr:%d,%d,%d",k,wwsz,cap);hxe();}}}ENDVERBATIM}PROCEDUREpopspk(x){TABLEPskDEPENDwwwid,wwhtFROM-40TO40WITH81Psk=-wwht*exp(-2.*x*x/wwwid/wwwid)}PROCEDUREpskshowtable(){VERBATIMintj;printf("_tmin_popspk:%g-_tmin_popspk:%g\n",_tmin_popspk,-_tmin_popspk);for(j=0;j<=-2*(int)_tmin_popspk+1;j++)printf("%g",_t_Psk[j]);printf("\n");ENDVERBATIM}PROCEDUREwrecord(te){VERBATIM{inti,j,k,max,wrp;doubleti,scale;for(i=0;i<WRNUM&&(wrp=(int)IDP->wreci[i])>-1;i++){scale=(double)IDP->wscale[i];if(_lte<1.e9){if(scale>0){max=(int)_tmin_popspk;k=-(int)floor((_lte-rebeg)/vdt+0.5);for(j=-max;j<=max&&k+j>0&&k+j<wwsz;j++){wwo[wrp][k+j]+=scale*_t_Psk[j+max];}}}elseif(twg>=t){return0;}else{for(ti=twg,k=(int)floor((twg-rebeg)/vdt+0.5);ti<=t&&k<wwsz;ti+=vdt,k++){valps(ti,twg);wwo[wrp][k]+=vii[6]*lfpscale;if(IDP->dbx==-1)printf("%g:%g",vii[6],wwo[wrp][k]);}}}if(_lte==1.e9)twg=ti;}return0;ENDVERBATIM}FUNCTIONwrec(){VERBATIM{intk,ix;ip=IDP;if(ifarg(1)){ix=(int)*getarg(1);if(ix>=1){if(ix-1>=nsw){printf("Attempttosaveintoww[%d]butonlyhave%d\n",ix-1,(int)nsw);hxe();}ip->wrec=1;ip->wreci[0]=(char)ix-1;ip->wscale[0]=1.;if(ifarg(2))ip->wscale[0]=(float)*getarg(2);}elseif(ix<=0){ip->wrec=0;for(k=0;k<WRNUM;k++){ip->wreci[k]=-1;ip->wscale[k]=-1.0;}}else{printf("INTF6wrecERRflag(0/1)%d\n",ip->wrec);hxe();}}_lwrec=(double)ip->wrec;}ENDVERBATIM}FUNCTIONwrc(){VERBATIM{inti,ix;ip=IDP;if(ifarg(1)){ix=(int)*getarg(1);if(ix<0){ip->wrec=0;for(i=0;i<WRNUM;i++){ip->wreci[i]=-1;ip->wscale[i]=-1.0;}}else{for(i=0;i<WRNUM&&ip->wreci[i]!=-1&&ip->wreci[i]!=ix;i++){};if(i==WRNUM){pid();printf("INFTwrc()ERR:outofwrecipointers(max%d)\n",WRNUM);hxe();}if(ix>=nsw){printf("Attempttosaveintoww[%d]butonlyhave%d\n",ix,(int)nsw);hxe();}ip->wrec=1;ip->wreci[i]=ix;if(ifarg(2))ip->wscale[i]=(float)*getarg(2);elseip->wscale[i]=1.0;}}else{for(i=0;i<WRNUM;i++)printf("%d:%g",ip->wreci[i],ip->wscale[i]);printf("\n");}_lwrc=(double)ip->wrec;}ENDVERBATIM}FUNCTIONwwszset(){VERBATIMif(ifarg(1))wwsz=(unsignedint)*getarg(1);_lwwszset=(double)wwsz;ENDVERBATIM}FUNCTIONwwfree(){VERBATIMintk;IDP->wrec=0;wwsz=0;wwpt=0;nsw=0.;for(k=0;k<NSW;k++){ww[k]=nil;wwo[k]=nil;}ENDVERBATIM}FUNCTIONjttr(){VERBATIMip=IDP;pg=ip->pg;if(pg->jtmax>0&&pg->jtpt>=pg->jtmax){pg->jtpt=0;printf("Warning,cyclingthroughjttrvectoratt=%g\n",t);}if(pg->jtmax>0)_ljttr=jsp[pg->jtpt++];else_ljttr=0;ENDVERBATIM}PROCEDUREglobal_init(){popspk(0)VERBATIM{inti,j,k,c;doublestt[3];if(nsw>0.&&wwo[0]!=0){printf("Initializingwwtorecordfor%g(%g)\n",vdt*wwsz,vdt);wwpt=0;for(k=0;k<(int)nsw;k++){vector_resize(ww[k],wwsz);for(j=0;j<wwsz;j++)wwo[k][j]=0.;}}errflag=0;for(i=0;i<CTYN;i++)blockcnt[cty[i]]=spikes[cty[i]]=0;for(c=0;c<inumcols;c++){pg=ppg[c];if(!pg)continue;if(pg->jridv){pg->jri=pg->jrj=0;vector_resize(pg->jridv,pg->jrmax);vector_resize(pg->jrtvv,pg->jrmax);}pg->spktot=0;pg->jtpt=0;pg->eventtot=0;}}ENDVERBATIM}PROCEDUREglobal_fini(){VERBATIMintc,k;for(k=0;k<(int)nsw;k++)vector_resize(ww[k],(int)floor(t/vdt+0.5));for(c=0;c<inumcols;c++){pg=ppg[c];if(!pg)continue;if(pg->jridv&&pg->jrj<pg->jrmax){vector_resize(pg->jridv,pg->jrj);vector_resize(pg->jrtvv,pg->jrj);}}ENDVERBATIM}FUNCTIONfflag(){fflag=1}FUNCTIONthrh(){thrh=VTH-RMP}FUNCTIONrecflag(){VERBATIM_lrecflag=(double)IDP->record;ENDVERBATIM}FUNCTIONvinflag(){VERBATIMip=IDP;pg=ip->pg;if(ip->vinflg==0&&pg->vsp==nil){}elseif(ip->vinflg==1&&ip->rve==-1){printf("INTF6vinflagERR:pointernotinitialized\n");hoc_execerror("",0);}elseif(ip->rve>=0){if(pg->vsp==nil){printf("INTF6vinflagERR1:pointernotinitialized\n");hoc_execerror("",0);}ip->rvi=ip->rvb;ip->input=1;}_lvinflag=(double)ip->vinflg;ENDVERBATIM}FUNCTIONflag(){VERBATIMchar*sf;staticintix,fi,setfl,nx;staticunsignedcharval;staticdouble*x,delt;ip=IDP;pg=ip->pg;if(FLAG==OK){FLAG=0.;if(stoprun){slowset=0;return0.0;}if(IDP->dbx==-1)printf("slowsetfi:%dix:%dss:%gdelt:%gt:%g\n",fi,ix,slowset,delt,t);if(t>slowset||ix>=pg->cesz){printf("Slow-settingofflag%dfinishedat%g:(%d,%g,%g)\n",fi,t,ix,delt,slowset);slowset=0.;return0.0;}if(ix<pg->cesz){lop(pg->ce,ix);(&qp->type)[fi]=((fi>=iflneg)?(char)x[ix]:(unsignedchar)x[ix]);ix++;#ifdefined(t)net_send((void**)0x0,wts,tpnt,t+delt,OK);#elsenet_send((void**)0x0,wts,tpnt,delt,OK);#endif}return0.0;}if(slowset>0&&ifarg(3)){printf("INTF6flag()slowsetERR;attemptedsetduringslowset:fi:%dix:%dss:%gdelt:%gt:%g",\fi,ix,slowset,delt,t);return0.0;}ip=IDP;setfl=ifarg(3);if(ifarg(4)){slowset=*getarg(4);delt=slowset/pg->cesz;slowset+=t;}sf=gargstr(1);for(fi=0;fi<iflnum&&strncmp(sf,&iflags[fi*4],3)!=0;fi++);if(fi==iflnum){printf("INTF6ERR:%snotfoundasaflag(%s)\n",sf,iflags);hxe();}if(ifarg(2)){if(hoc_is_double_arg(2)){val=(unsignedchar)*getarg(2);if(slowset){printf("NOTIMPLEMENTED\n");}elseif(setfl){for(ix=0;ix<pg->cesz;ix++){lop(pg->ce,ix);(&qp->type)[fi]=val;}}else{(&ip->type)[fi]=((fi>=iflneg)?(char)val:val);}}else{nx=vector_arg_px(2,&x);if(nx!=pg->cesz){if(setfl){printf("INTF6flagERR:vecszmismatch:%d%d\n",nx,pg->cesz);hxe();}elsex=vector_newsize(vector_arg(2),pg->cesz);}if(setfl&&slowset){ix=0;lop(pg->ce,ix);(&qp->type)[fi]=((fi>=iflneg)?(char)x[ix]:(unsignedchar)x[ix]);ix++;#ifdefined(t)net_send((void**)0x0,wts,tpnt,t+delt,OK);#elsenet_send((void**)0x0,wts,tpnt,delt,OK);#endif}elsefor(ix=0;ix<pg->cesz;ix++){lop(pg->ce,ix);if(setfl){(&qp->type)[fi]=((fi>=iflneg)?(char)x[ix]:(unsignedchar)x[ix]);}else{x[ix]=(double)((fi>=iflneg)?(char)(&qp->type)[fi]:(unsignedchar)(&qp->type)[fi]);}}}}_lflag=(double)((fi>=iflneg)?(char)(&ip->type)[fi]:(unsignedchar)(&ip->type)[fi]);ENDVERBATIM}FUNCTIONallspck(){VERBATIMinti;double*x,sum;IvocVect*voi;ip=IDP;pg=ip->pg;voi=vector_arg(1);x=vector_newsize(voi,pg->cesz);for(i=0,sum=0;i<pg->cesz;i++){lopr(pg->ce,i);x[i]=spck;sum+=spck;}_lallspck=sum;ENDVERBATIM}PROCEDUREresetall(){VERBATIMintii,i;unsignedcharval;ip=IDP;pg=ip->pg;if(verbose>1)printf("resetall:ip=%p,col=%d,pg=%p\n",ip,pg->col,pg);for(i=0;i<pg->cesz;i++){lopr(pg->ce,i);Vm=RMP;VAM=0;VNM=0;VGA=0;AHP=0;invlt=-1;VAM2=0;VNM2=0;VGA2=0;t0=t;trrs=t;twg=t;cbur=0;spck=0;refractory=0;VTHC=VTHR=VTH;}ENDVERBATIM}FUNCTIONfloc(){VERBATIMdoublex,y,z,r,min,rad,*ix,*dd,*tdy;intii,i,n,cnt,ty,tvf;IvocVect*voi,*vod,*voty;cnt=0;n=1000;r=0;z=ty=1e9;tvf=0;ip=IDP;pg=ip->pg;x=*getarg(1);y=*getarg(2);i=3;if(ifarg(i))if(hoc_is_double_arg(i)){z=*getarg(3);i++;}if(ifarg(i)){voi=vector_arg(i++);ix=vector_newsize(voi,n);vod=vector_arg(i++);dd=vector_newsize(vod,n);r=*getarg(i++);}if(ifarg(i))if(hoc_is_double_arg(i))ty=*getarg(7);else{tvf=1;voty=vector_arg(i++);tdy=vector_newsize(voty,n);}r*=r;for(i=0,min=1e9,ii=-1;i<pg->cesz;i++){qp=lopr(pg->ce,i);if(ty!=1e9&&((ty>=0&&ty!=qp->type)||(ty==-1&&qp->inhib==1)||(ty==-2&&qp->inhib==0)))continue;rad=(x-xloc)*(x-xloc)+(y-yloc)*(y-yloc)+(z==1e9?0.:((z-zloc)*(z-zloc)));if(r>0&&rad<r){if(cnt>=n){ix=vector_newsize(voi,n*=2);dd=vector_newsize(vod,n);if(tvf)tdy=vector_newsize(voty,n);}ix[cnt]=(double)i;dd[cnt]=sqrt(rad);if(tvf)tdy[cnt]=(double)qp->type;cnt++;}elseif(rad<min){min=rad;ii=i;}}if(r>0){ix=vector_newsize(voi,cnt);dd=vector_newsize(vod,cnt);if(tvf)tdy=vector_newsize(voty,cnt);_lfloc=(double)cnt;}else{_lfloc=(double)ii;}ENDVERBATIM}FUNCTIONinvlset(){VERBATIMip=IDP;if(ifarg(1))ip->invl0=(unsignedchar)*getarg(1);_linvlset=(double)ip->invl0;ENDVERBATIM}FUNCTIONvinset(){VERBATIMip=IDP;if(ifarg(1))ip->vinflg=(unsignedchar)*getarg(1);if(ip->vinflg==1){ip->input=1;ip->rvi=ip->rvb;}_lvinset=(double)ip->vinflg;ENDVERBATIM}PROCEDUREEXPo(x){TABLERESFROM-20TO0WITH5000RES=exp(x)}FUNCTIONEXP(x){EXPo(x)EXP=RES}PROCEDUREESINo(x){TABLEESINFROM0TO2*PIWITH3000ESIN=sin(x)}FUNCTIONrates(vv){rates=maxnmc/(1+exp(0.062(/mV)*-vv)*((mg/mg0)))}FUNCTIONdopelearn(){VERBATIMPoint_process*pnnt;inti,iCell,pot;doubletmp,maxw,inc,d,tau,pdopet;if(seadsetting!=3.)return0.0;pot=(int)*getarg(1);ip=IDP;pg=ip->pg;for(iCell=0;iCell<pg->cesz;iCell++){lop(pg->ce,iCell);if(!qp->dvt)continue;for(i=0;i<qp->dvt;i++){pdopet=fabs(qp->pdope[i]);d=t-pdopet;if(qp->pdope[i]>-1e9&&d<=maxeligtrdur){tmp=qp->wgain[i];maxw=qp->pplastmaxw[i];tau=qp->pplasttau[i];if(!(inc=qp->pplastinc[i]))continue;if(pot>0){if(qp->pdope[i]>=0){if(SOFTSTDP)inc*=(1.0-tmp/maxw);if(EXPELIGTR)qp->wgain[i]+=EPOTW*inc*exp(-d/tau);elseqp->wgain[i]+=EPOTW*inc;}else{if(SOFTSTDP)inc*=(tmp/maxw);if(EXPELIGTR)qp->wgain[i]-=EDEPW*inc*exp(-d/tau);elseqp->wgain[i]-=EDEPW*inc;}}else{if(qp->pdope[i]>=0){if(SOFTSTDP)inc*=(tmp/maxw);if(EXPELIGTR)qp->wgain[i]-=EDEPW*inc*exp(-d/tau);elseqp->wgain[i]-=EDEPW*inc;}else{if(SOFTSTDP)inc*=(1.0-tmp/maxw);if(EXPELIGTR)qp->wgain[i]+=EPOTW*inc*exp(-d/tau);elseqp->wgain[i]+=EPOTW*inc;}}if(qp->wgain[i]<0.)qp->wgain[i]=0.;elseif(!SOFTSTDP&&qp->wgain[i]>maxw)qp->wgain[i]=maxw;if(reseteligtr)qp->pdope[i]=-1e9;}}}return1.0;ENDVERBATIM}PROCEDUREsetdeletion(){VERBATIMdoublex=*getarg(1);if(x<=0){dynamicdel=0;}else{dynamicdel=1;delspeed=x;printf("Setdynamicdeletionrateconstant=%e\n",delspeed);}ENDVERBATIM}VERBATIMvoiddynamicdelete(doubletime){mcell_ran4(&sead,dscr,1,1.0);doublep=dscr[0];doubledifference=ip->activity/ip->goal_activity;doublex=difference-2.0;if(x<0){x=0;}doublethreshold=x*x*delspeed*((time-ip->lastupdate)/1000.0);if(p<threshold){printf("p=%e,threshold=%efromx^2*delspeed*timegap:\nx=%e,x^2=%e,delspeed=%e,x^2*delspeed=%e,timegap(s)=%e\n",p,threshold,x,x*x,delspeed,x*x*delspeed,(time-ip->lastupdate)/1000.0);ip->dead=1;printf("Cell%dhasjustdied(scalefactor=%f)\n\n",ip->id,ip->scalefactor);}}ENDVERBATIMVERBATIMdoubleget_avg_activity(){returnip->spkcnt/t;}ENDVERBATIMVERBATIMvoidraise_activity_sensor(doubletime){ip->activity=ip->activity+(-ip->activity+1.0)/activitytau;}ENDVERBATIMVERBATIMvoiddecay_activity_sensor(doubletime){ip->activity=ip->activity*exp(-activityoneovertau*(time-ip->lastupdate));}ENDVERBATIMVERBATIMvoidupdate_scale_factor(doubletime){doubleerr=ip->goal_activity-ip->activity;ip->scalefactor+=(activitybeta*ip->scalefactor*err+activitygamma*ip->scalefactor*ip->activity_integral_err);if(ip->scalefactor>ip->max_scale){ip->scalefactor=ip->max_scale;}doubletimecorrection=time-ip->lastupdate;ip->activity_integral_err+=(err*timecorrection);}ENDVERBATIMFUNCTIONscalefactor(){VERBATIMif(ifarg(1))IDP->scalefactor=*getarg(1);returnIDP->scalefactor;ENDVERBATIM}FUNCTIONactivity(){VERBATIMif(ifarg(1))IDP->activity=*getarg(1);returnIDP->activity;ENDVERBATIM}FUNCTIONgoalactivity(){VERBATIMif(ifarg(1))IDP->goal_activity=*getarg(1);returnIDP->goal_activity;ENDVERBATIM}FUNCTIONisdead(){VERBATIMreturnIDP->dead;ENDVERBATIM}