COMMENTThismechanismemitsspikeeventsatthetimesgiveninasuppliedVector.Exampleusageobjrefvsvs=newVecStim(.5)vs.play(spikevec)Thisisamodifiedversionoftheoriginalvecstim.mod(authorunknown?)whichallowsmultiplevectorstobeusedsequentially.Thissavesmemoryinalongsimulation,asthesamestoragecanbereused.Themechanismchecksatintervals`ping`whetheranewvectorhasbeenprovidedusingtheplay()procedureandifsoresetsitspointertothefirstelementinthenewvector.Notethatanyspikesremaininginthefirstvectorwillbelost.Anyspiketimesinthenewvectorthatareearlierthanthecurrenttimeareignored.Themechanismactuallychecksslightlyafterthepinginterval,toavoidplay()andthepingcheckoccurringatthesametimestepbutinthewrongorder.ExtractsfromthecommentsontheoriginalvecstimTheidiomforgettingaVectorargumentinamodeldescriptionisencapsulatedinthe"play"procedure.TherearepotentiallymanyVecStiminstancesandsotheVectorpointermustbestoredinthespaceallocatedfortheparticularinstancewhen"play"iscalled.Theassignedvariable"space"givesusspaceforadoubleprecisionnumber,64bits,whichissufficienttostoreanopaquepointer.The"element"procedureusesthisopaquepointertomakesurethattherequested"index"elementiswithinthesizeofthevectorandassignsthe"etime"doubleprecisionvariabletothevalueofthatelement.SinceindexisdefinedatthemodeldescriptionlevelitisadoubleprecisionvariableaswellandmustbetreatedassuchintheVERBATIMblock.Anindexvalueof-1meansthatnofurthereventsshouldbesentfromthisinstance.Fortunately,spaceformodeldataisclearedwhenitisfirstallocated.Soifplayisnotcalled,thepointerwillbe0andthetestintheelementprocedurewouldturnofftheVecStimbysettingindexto-1.Also,becausetheexistenceofthefirstargumentischeckedinthe"play"procedure,onecanturnofftheVecStimwithvs.play()Nocheckingisdoneifthestimvecisdestroyed(whenthereferencecountfortheunderlyingVectorbecomes0).ContinueduseoftheVecStiminstanceinthiscasewouldcauseamemoryerror.Soitisuptotheusertocallvs.play()ortodestroytheVecStiminstancebeforerunninganothersimulation.ThestrategyoftheINITIALandNET_RECEIVEblocksistosendaselfevent(withflag1)tobedeliveredatthetimespecifiedbytheindexoftheVectorstartingatindex0.WhentheselfeventisdeliveredtotheNET_RECEIVEblock,itcausesanimmediateinputeventoneveryNetConwhichhasthisVecStimasitssource.Theseevents,wouldthenbedeliveredtotheirtargetsaftertheappropriatedelayspecifiedforeachNetCon.ENDCOMMENT:VectorstreamofeventsNEURON{ARTIFICIAL_CELLVecStimRANGEping}PARAMETER{ping=1(ms)}ASSIGNED{indexetime(ms)space}INITIAL{index=0element()if(index>0){net_send(etime-t,1)}if(ping>0){net_send(ping,2)}}NET_RECEIVE(w){if(flag==1){net_event(t)element()if(index>0){if(etime<t){printf("WarninginVecStim:spiketime(%gms)beforecurrenttime(%gms)\n",etime,t)}else{net_send(etime-t,1)}}}elseif(flag==2){:ping-resetindexto0:printf("flag=2,etime=%g,t=%g,ping=%g,index=%g\n",etime,t,ping,index)if(index==-2){:play()hasbeencalled:printf("Detectednewvector\n")index=0:thefollowingloopensuresthatifthevector:containsspiketimesearlierthanthecurrent:time,theyareignored.while(etime<t&&index>=0){element():printf("element():index=%g,etime=%g,t=%g\n",index,etime,t)}if(index>0){net_send(etime-t,1)}}net_send(ping,2)}}VERBATIMexterndouble*vector_vec();externintvector_capacity();externvoid*vector_arg();ENDVERBATIMPROCEDUREelement(){VERBATIM{void*vv;inti,size;double*px;i=(int)index;if(i>=0){vv=*((void**)(&space));if(vv){size=vector_capacity(vv);px=vector_vec(vv);if(i<size){etime=px[i];index+=1.;}else{index=-1.;}}else{index=-1.;}}}ENDVERBATIM}PROCEDUREplay(){VERBATIMvoid**vv;vv=(void**)(&space);*vv=(void*)0;if(ifarg(1)){*vv=vector_arg(1);}index=-2;ENDVERBATIM}