UNITS{(mA)=(milliamp)(mV)=(millivolt)(S)=(siemens)}NEURON{SUFFIXKIUSEIONkREADekWRITEikRANGEgkbar,NK,scale_a,R,stsum,en,an,bn,N,seGLOBALgu_KTHREADSAFE}PARAMETER{se=-1gkbar=.004(S/cm2)<0,1e9>gu_K=20e-12(S)scale_a=1.0}STATE{n0n1n2n3n4}ASSIGNED{NKarea(micron2)v(mV)celsius(degC)ek(mV)dt(ms)ik(mA/cm2)an(/ms)bn(/ms)stsumNR[4](/ms)en[5]}BREAKPOINT{SOLVEstatesMETHODeulerik=gkbar*n4*(v-ek)}INITIAL{rates(v)NK=floor((1e-8)*gkbar*area/gu_K+0.5)if(se>=0){set_seed(se)}N=an/bnstsum=(1+N)^4n0=1/stsumn1=4*N/stsumn2=6*N^2/stsumn3=4*N^3/stsumn4=N^4/stsumfijaerror()}DERIVATIVEstates{rates(v)n0'=-4*an*n0+bn*n1+R[0]+en[0]/dtn1'=(-3*an-bn)*n1+4*an*n0+2*bn*n2-R[0]+R[1]+en[1]/dtn2'=(-2*an-2*bn)*n2+3*an*n1+3*bn*n3-R[1]+R[2]+en[2]/dtn3'=(-an-3*bn)*n3+2*an*n2+4*bn*n4-R[2]+R[3]+en[3]/dtn4'=-4*bn*n4+an*n3-R[3]+en[4]/dtntrunca()}PROCEDUREntrunca(){LOCALN[5],i,j,k,l,nsum,nsumN,ps,aux,aux2,pos,pos2[5],en_aux[5]UNITSOFFnsum=n0+n1+n2+n3+n4N[0]=n0/nsumN[1]=n1/nsumN[2]=n2/nsumN[3]=n3/nsumN[4]=n4/nsumnsumN=1aux=0aux2=0l=0FROMi=0TO4{if(N[i]>1){aux=1pos=iVERBATIMbreak;ENDVERBATIM}if(N[i]<0){aux=2pos2[l]=il=l+1}}if(aux==0){FROMl=0TO4{en[l]=0}}if(aux==1){aux2=N[pos]FROMj=0TO4{en[j]=N[j]N[j]=0}en[pos]=aux2-1N[pos]=1}if(aux==2){FROMn=0TO(l-1){ps=pos2[n]en_aux[n]=N[ps]aux2=aux2+N[ps]}FROMk=0TO4{en[k]=N[k]*(1-1/(nsumN-aux2))N[k]=N[k]/(nsumN-aux2)}FROMn=0TO(l-1){ps=pos2[n]en[ps]=en_aux[n]N[ps]=0}}n0=N[0]n1=N[1]n2=N[2]n3=N[3]n4=N[4]UNITSON}PROCEDUREfijaerror(){UNITSOFFFROMk=0TO4{en[k]=0}UNITSON}PROCEDURErates(v(mV)){UNITSOFFan=scale_a*.01*vtrap(-(v+55),10)bn=scale_a*.125*exp(-(v+65)/80)FROMii=0TO3{R[ii]=normrand(0,1/sqrt(NK*dt))}R[0]=R[0]*sqrt(4*an*n0+bn*n1)R[1]=R[1]*sqrt(3*an*n1+2*bn*n2)R[2]=R[2]*sqrt(2*an*n2+3*bn*n3)R[3]=R[3]*sqrt(an*n3+4*bn*n4)}FUNCTIONvtrap(x,y){if(fabs(x/y)<1e-6){vtrap=y*(1-x/y/2)}else{vtrap=x/(exp(x/y)-1)}}UNITSON