NEURON{ARTIFICIAL_CELLIntFire4rRANGEtaue,taui1,taui2,taum,e,i1,i2,m,ae,ai2,ai1RANGEnself,nexcite,ninhibitGLOBALeps,taueps}PARAMETER{taue=5(ms)<0,1e9>taui1=10(ms)<0,1e9>taui2=20(ms)<0,1e9>taum=50(ms)<0,1e9>ib=0eps=1e-6<1e-9,0.01>taueps=0.01<1e-9,1e9>}ASSIGNED{ei1i2menewi1newi2newmnewt0(ms)nselfnexciteninhibitke(1/ms)ki1(1/ms)ki2(1/ms)km(1/ms)ae(1/ms)ai1(1/ms)ai2(1/ms)bebi1bi2abtau_swap(ms)flag(1)}PROCEDUREnewstates(d(ms)){LOCALee,ei1,ei2,emee=exp(-ke*d)ei1=exp(-ki1*d)ei2=exp(-ki2*d)em=exp(-km*d)enew=e*eei1new=i1*ei1i2new=i2*ei2+bi1*i1*(ei2-ei1)mnew=m*em+be*e*(em-ee)+(bi2*i2+a*i1)*(em-ei2)-b*i1*(em-ei1)}FUNCTIONM(){newstates(t-t0)M=mnew}FUNCTIONE(){newstates(t-t0)E=ae*enew}FUNCTIONI(){newstates(t-t0)I=ai2*i2new}PROCEDUREupdate(){e=enewi1=i1newi2=i2newm=mnewt0=t}PROCEDUREfixprecondition(){if(taui2<4*taueps){taui2=4*taueps}if(taui1<3*taueps){taui1=3*taueps}if(taue<2*taueps){taue=2*taueps}if(taue>taui2){tau_swap=tauetaue=taui2-tauepsprintf("Warning}elseif(taui2-taue<taueps){taue=taui2-taueps}if(taui1>taui2){tau_swap=taui2taui2=taui1taui1=tau_swapprintf("Warning}if(taui2-taui1<taueps){taui1=taui2-taueps}if(taum<=taui2){if(taui2-taum<taueps){taum=taui2-taueps}if(fabs(taui1-taum)<taueps){taum=taui1-taueps}if(fabs(taui1-taum)<taueps){if(taui1-taum<0){taum=taui1-taueps}else{taui1=taum-taueps}}if(fabs(taue-taum)<taueps){if(taue-taum<0){taum=taue-taueps}else{taue=taum-taueps}}if(fabs(taui1-taum)<taueps){taum=taui1-taueps}}elseif(taum-taui2<taueps){taum=taui2+taueps}}PROCEDUREfactors(){LOCALtpke=1/taueki1=1/taui1ki2=1/taui2km=1/taumtp=log(km/ke)/(km-ke)be=1/(exp(-km*tp)-exp(-ke*tp))ae=be*(ke-km)tp=log(ki2/ki1)/(ki2-ki1)bi1=1/(exp(-ki2*tp)-exp(-ki1*tp))ai1=bi1*(ki1-ki2)e=0i1=1i2=0m=0bi2=1ai2=bi2*(ki2-km)a=bi2*bi1b=a*(ki2-km)/(ki1-km)tp=search()newstates(tp)bi2=1/mnewai2=bi2*(ki2-km)a=bi2*bi1b=a*(ki2-km)/(ki1-km)newstates(tp)i1=0}FUNCTIONderiv(d(ms))(/ms2){deriv=(-km*exp(-d*km)+ki2*exp(-d*ki2))/(ki2-km)-((-km*exp(-d*km)+ki1*exp(-d*ki1)))/(ki1-km)}FUNCTIONsearch()(ms){LOCALx,t1,t2t1=1flag=0if(deriv(t1)<0){while(deriv(t1)<0&&t1>1e-9){t2=t1t1=t1/10}if(deriv(t1)<0){printf("Errorwrongderiv(t1)flag=1search=1e-9}}else{t2=t1while(deriv(t2)>0&&t2<1e9){t1=t2t2=t2*10}if(deriv(t2)>0){printf("Errorwrongderiv(t2)flag=1search=1e9}}while(t2-t1>1e-6&&flag==0){search=(t1+t2)/2x=deriv(search)if(x>0){t1=search}else{t2=search}}}INITIAL{fixprecondition()factors()e=0i1=0i2=0m=0t0=tnet_send(firetimebound(),1)nself=0nexcite=0ninhibit=0}NET_RECEIVE(w){newstates(t-t0)update()if(m>1-eps){net_event(t)m=0}if(flag==1){nself=nself+1net_send(firetimebound(),1)}else{if(w>0){nexcite=nexcite+1e=e+w}else{ninhibit=ninhibit+1i1=i1+w}net_move(firetimebound()+t)}}FUNCTIONfiretimebound()(ms){LOCALslopeslope=-km*m+ae*e+ai2*i2if(slope<=1e-9){firetimebound=1e9}else{firetimebound=(1-m)/slope}}