NEURON{SUFFIXcharge_USEIONnaREADinaUSEIONkREADikRANGEvmax,vmin,tmax,tminRANGEna_ch,na_ch_overl,overlRANGEna_ch_before_peakRANGEna_ch_after_peakRANGEna_ch_excess_ratioRANGEpeak_reachedRANGEpeak_time}PARAMETER{tStart(ms)tEnd(ms)peak_tolerance(mV)peak_lowest(mV)}ASSIGNED{v(millivolt)vmin(millivolt)tmin(ms)vmax(millivolt)tmax(ms)na_ch(milliamp/cm2)na_ch_overl(milliamp/cm2)na_ch_overl_tmp(milliamp/cm2)overlna_ch_excess_rationa_ch_before_peakna_ch_after_peakpeak_reachedpeak_timeina(milliamp/cm2)ik(milliamp/cm2)}INITIAL{vmin=1e6tmin=0vmax=-1e6tmax=0peak_reached=0peak_time=0na_ch=0na_ch_before_peak=0na_ch_after_peak=0na_ch_excess_ratio=0na_ch_overl=0overl=0}BREAKPOINT{VERBATIMif(t>tStart){if(t<tEnd){if(v<vmin){vmin=v;tmin=t;}if(v>vmax){vmax=v;tmax=t;}na_ch=na_ch+ina;na_ch_overl_tmp=ina;if(-ik>ina){na_ch_overl_tmp=-ik;}na_ch_overl=na_ch_overl+na_ch_overl_tmp;if(na_ch!=0){overl=(na_ch-na_ch_overl)/na_ch;}if((v<vmax-peak_tolerance)&&(v>peak_lowest)&&(peak_reached==0)){peak_reached=1;peak_time=t;}if(peak_reached==0){na_ch_before_peak=na_ch_before_peak+ina;}else{na_ch_after_peak=na_ch_after_peak+ina;}if(na_ch_before_peak!=0){na_ch_excess_ratio=(na_ch_before_peak+na_ch_after_peak)/na_ch_before_peak;}}}ENDVERBATIM}