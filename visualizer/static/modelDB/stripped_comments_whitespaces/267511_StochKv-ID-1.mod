INDEPENDENT{tFROM0TO1WITH1(ms)}NEURON{SUFFIXStochKvTHREADSAFEUSEIONkREADekWRITEikRANGEN,eta,gk,gamma,deterministic,gkbar,ikRANGEninf,ntau,a,b,P_a,P_bGLOBALRa,RbGLOBALvmin,vmax,q10,tempRANGEtadjBBCOREPOINTERrng}UNITS{(mA)=(milliamp)(mV)=(millivolt)(pS)=(picosiemens)(S)=(siemens)(um)=(micron)}PARAMETER{v(mV)dt(ms)area(um2)gamma=30(pS)eta(1/um2)gkbar=.75(S/cm2)tha=-40(mV)qa=9Ra=0.02(/ms)Rb=0.002(/ms)celsius(degC)temp=23(degC)q10=2.3deterministic=0vmin=-120(mV)vmax=100(mV)}ASSIGNED{a(/ms)b(/ms)ik(mA/cm2)gk(S/cm2)ek(mV)ninfntau(ms)tadjNscale_dens(pS/um2)P_aP_brngusingR123n0_n1_new}STATE{nN0N1n0_n1n1_n0}VERBATIM#include"nrnran123.h"#include<stdlib.h>#include<stdio.h>#include<math.h>#ifndefCORENEURON_BUILDdoublenrn_random_pick(void*r);void*nrn_random_arg(intargpos);#endifENDVERBATIMINITIAL{VERBATIMif(usingR123){nrnran123_setseq((nrnran123_State*)_p_rng,0,0);}ENDVERBATIMeta=gkbar/gammatrates(v)n=ninfscale_dens=gamma/areaN=floor(eta*area+0.5)N1=floor(n*N+0.5)N0=N-N1n0_n1=0n1_n0=0}BREAKPOINT{SOLVEstatesgk=(strap(N1)*scale_dens*tadj)ik=1e-4*gk*(v-ek)}PROCEDUREstates(){trates(v)P_a=strap(a*dt)P_b=strap(b*dt)ChkProb(P_a)ChkProb(P_b)n0_n1=BnlDev(P_a,N0)n1_n0=BnlDev(P_b,N1)N0=strap(N0-n0_n1+n1_n0)N1=N-N0}PROCEDUREtrates(v(mV)){TABLEntau,ninf,a,b,tadjDEPENDdt,Ra,Rb,tha,qa,q10,temp,celsiusFROMvminTOvmaxWITH199tadj=q10^((celsius-temp)/(10(K)))a=SigmoidRate(v,tha,Ra,qa)a=a*tadjb=SigmoidRate(-v,-tha,Rb,qa)b=b*tadjntau=1/(a+b)ninf=a*ntau}FUNCTIONSigmoidRate(v(mV),th(mV),a(1/ms),q)(1/ms){UNITSOFFif(fabs(v-th)>1e-6){SigmoidRate=a*(v-th)/(1-exp(-(v-th)/q))UNITSON}else{SigmoidRate=a*q}}FUNCTIONstrap(x){if(x<0){strap=0VERBATIMfprintf(stderr,"skv.mod:strap:negativestate");ENDVERBATIM}else{strap=x}}PROCEDUREChkProb(p){if(p<0.0||p>1.0){VERBATIMENDVERBATIM}}PROCEDUREsetRNG(){VERBATIM#ifndefCORENEURON_BUILDusingR123=0;if(ifarg(1)&&hoc_is_double_arg(1)){nrnran123_State**pv=(nrnran123_State**)(&_p_rng);uint32_ta2=0;uint32_ta3=0;if(*pv){nrnran123_deletestream(*pv);*pv=(nrnran123_State*)0;}if(ifarg(2)){a2=(uint32_t)*getarg(2);}if(ifarg(3)){a3=(uint32_t)*getarg(3);}*pv=nrnran123_newstream3((uint32_t)*getarg(1),a2,a3);usingR123=1;}elseif(ifarg(1)){void**pv=(void**)(&_p_rng);*pv=nrn_random_arg(1);}else{void**pv=(void**)(&_p_rng);*pv=(void*)0;}#endifENDVERBATIM}FUNCTIONurand(){VERBATIMdoublevalue;if(usingR123){value=nrnran123_dblpick((nrnran123_State*)_p_rng);}elseif(_p_rng){#ifndefCORENEURON_BUILDvalue=nrn_random_pick(_p_rng);#endif}else{value=0.5;}_lurand=value;ENDVERBATIM}FUNCTIONbrand(P,N){VERBATIMdoublevalue=0.0;inti;for(i=0;i<_lN;i++){if(urand(_threadargs_)<_lP){value=value+1;}}return(value);ENDVERBATIMbrand=value}VERBATIM#definePI3.141592654#definer_ia16807#definer_im2147483647#definer_am(1.0/r_im)#definer_iq127773#definer_ir2836#definer_ntab32#definer_ndiv(1+(r_im-1)/r_ntab)#definer_eps1.2e-7#definer_rnmx(1.0-r_eps)ENDVERBATIMVERBATIMstaticdoublegammln(doublexx){doublex,tmp,ser;staticdoublecof[6]={76.18009173,-86.50532033,24.01409822,-1.231739516,0.120858003e-2,-0.536382e-5};intj;x=xx-1.0;tmp=x+5.5;tmp-=(x+0.5)*log(tmp);ser=1.0;for(j=0;j<=5;j++){x+=1.0;ser+=cof[j]/x;}return-tmp+log(2.50662827465*ser);}ENDVERBATIMFUNCTIONBnlDev(ppr,nnr){VERBATIMintj;staticintnold=(-1);doubleam,em,g,angle,p,bnl,sq,bt,y;staticdoublepold=(-1.0),pc,plog,pclog,en,oldg;p=(_lppr<=0.5?_lppr:1.0-_lppr);am=_lnnr*p;if(_lnnr<25){bnl=0.0;for(j=1;j<=_lnnr;j++)if(urand(_threadargs_)<p)bnl+=1.0;}elseif(am<1.0){g=exp(-am);bt=1.0;for(j=0;j<=_lnnr;j++){bt*=urand(_threadargs_);if(bt<g)break;}bnl=(j<=_lnnr?j:_lnnr);}else{if(_lnnr!=nold){en=_lnnr;oldg=gammln(en+1.0);nold=_lnnr;}if(p!=pold){pc=1.0-p;plog=log(p);pclog=log(pc);pold=p;}sq=sqrt(2.0*am*pc);do{do{angle=PI*urand(_threadargs_);angle=PI*urand(_threadargs_);y=tan(angle);em=sq*y+am;}while(em<0.0||em>=(en+1.0));em=floor(em);bt=1.2*sq*(1.0+y*y)*exp(oldg-gammln(em+1.0)-gammln(en-em+1.0)+em*plog+(en-em)*pclog);}while(urand(_threadargs_)>bt);bnl=em;}if(p!=_lppr)bnl=_lnnr-bnl;returnbnl;ENDVERBATIMBnlDev=bnl}VERBATIMstaticvoidbbcore_write(double*x,int*d,int*xx,int*offset,_threadargsproto_){if(d){uint32_t*di=((uint32_t*)d)+*offset;if(!_p_rng){di[0]=0;di[1]=0,di[2]=0;}else{nrnran123_State**pv=(nrnran123_State**)(&_p_rng);nrnran123_getids3(*pv,di,di+1,di+2);charwhich;nrnran123_getseq(*pv,di+3,&which);di[4]=(int)which;}}*offset+=5;}staticvoidbbcore_read(double*x,int*d,int*xx,int*offset,_threadargsproto_){assert(!_p_rng);uint32_t*di=((uint32_t*)d)+*offset;if(di[0]!=0||di[1]!=0||di[2]!=0){nrnran123_State**pv=(nrnran123_State**)(&_p_rng);*pv=nrnran123_newstream3(di[0],di[1],di[2]);nrnran123_setseq(*pv,di[3],(char)di[4]);}*offset+=5;}ENDVERBATIMFUNCTIONbbsavestate(){bbsavestate=0VERBATIM#ifndefCORENEURON_BUILDdouble*xdir,*xval,*hoc_pgetarg();longnrn_get_random_sequence(void*r);voidnrn_set_random_sequence(void*r,intval);xdir=hoc_pgetarg(1);xval=hoc_pgetarg(2);if(_p_rng){if(*xdir==-1.){if(usingR123){*xdir=2.0;}else{*xdir=1.0;}return0.0;}elseif(*xdir==0.){if(usingR123){uint32_tseq;charwhich;nrnran123_getseq((nrnran123_State*)_p_rng,&seq,&which);xval[0]=(double)seq;xval[1]=(double)which;}else{xval[0]=(double)nrn_get_random_sequence(_p_rng);}}else{if(usingR123){nrnran123_setseq((nrnran123_State*)_p_rng,(uint32_t)xval[0],(char)xval[1]);}else{nrn_set_random_sequence(_p_rng,(long)(xval[0]));}}}#endifENDVERBATIM}