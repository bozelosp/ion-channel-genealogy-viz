NEURON{THREADSAFEPOINT_PROCESSProbAMPANMDA_EMSGLOBALtau_r_AMPARANGEtau_d_AMPA,g_AMPA,i_AMPAGLOBALtau_r_NMDA,tau_d_NMDARANGEg_NMDA,i_NMDARANGEUse,u,Dep,Fac,u0,mg,tsynRANGEunoccupied,occupied,NrrpRANGEg,NMDA_ratioRANGEA_AMPA_step,B_AMPA_step,A_NMDA_step,B_NMDA_stepGLOBALeNONSPECIFIC_CURRENTiBBCOREPOINTERrngRANGEsynapseID,selected_for_report,verboseLevel}PARAMETER{tau_r_AMPA=0.2(ms)tau_d_AMPA=1.7(ms)tau_r_NMDA=0.29(ms)tau_d_NMDA=43(ms)Use=1.0(1)Dep=100(ms)Fac=10(ms)e=0(mV)mg=1(mM)gmax=.001(uS)u0=0Nrrp=1(1)synapseID=0verboseLevel=0selected_for_report=0NMDA_ratio=0.71(1)}VERBATIM#include<stdlib.h>#include<stdio.h>#include<math.h>#include"nrnran123.h"doublenrn_random_pick(void*r);void*nrn_random_arg(intargpos);ENDVERBATIMASSIGNED{v(mV)i(nA)i_AMPA(nA)i_NMDA(nA)g_AMPA(uS)g_NMDA(uS)g(uS)factor_AMPAfactor_NMDAA_AMPA_stepB_AMPA_stepA_NMDA_stepB_NMDA_steprngmggateusingR123unoccupied(1)occupied(1)tsyn(ms)u(1)}STATE{A_AMPAB_AMPAA_NMDAB_NMDA}INITIAL{LOCALtp_AMPA,tp_NMDAtsyn=0u=u0unoccupied=0occupied=NrrpA_AMPA=0B_AMPA=0A_NMDA=0B_NMDA=0tp_AMPA=(tau_r_AMPA*tau_d_AMPA)/(tau_d_AMPA-tau_r_AMPA)*log(tau_d_AMPA/tau_r_AMPA)tp_NMDA=(tau_r_NMDA*tau_d_NMDA)/(tau_d_NMDA-tau_r_NMDA)*log(tau_d_NMDA/tau_r_NMDA)factor_AMPA=-exp(-tp_AMPA/tau_r_AMPA)+exp(-tp_AMPA/tau_d_AMPA)factor_AMPA=1/factor_AMPAfactor_NMDA=-exp(-tp_NMDA/tau_r_NMDA)+exp(-tp_NMDA/tau_d_NMDA)factor_NMDA=1/factor_NMDAA_AMPA_step=exp(dt*((-1.0)/tau_r_AMPA))B_AMPA_step=exp(dt*((-1.0)/tau_d_AMPA))A_NMDA_step=exp(dt*((-1.0)/tau_r_NMDA))B_NMDA_step=exp(dt*((-1.0)/tau_d_NMDA))VERBATIMif(usingR123){nrnran123_setseq((nrnran123_State*)_p_rng,0,0);}ENDVERBATIM}BREAKPOINT{SOLVEstatemggate=1/(1+exp(0.062(/mV)*-(v))*(mg/3.57(mM)))g_AMPA=gmax*(B_AMPA-A_AMPA)g_NMDA=gmax*(B_NMDA-A_NMDA)*mggateg=g_AMPA+g_NMDAi_AMPA=g_AMPA*(v-e)i_NMDA=g_NMDA*(v-e)i=i_AMPA+i_NMDA}PROCEDUREstate(){A_AMPA=A_AMPA*A_AMPA_stepB_AMPA=B_AMPA*B_AMPA_stepA_NMDA=A_NMDA*A_NMDA_stepB_NMDA=B_NMDA*B_NMDA_step}NET_RECEIVE(weight,weight_AMPA,weight_NMDA,Psurv){LOCALresult,ves,occuweight_AMPA=weightweight_NMDA=weight*NMDA_ratioINITIAL{}if(weight<=0||t<0){VERBATIMreturn;ENDVERBATIM}if(Fac>0){u=u*exp(-(t-tsyn)/Fac)}else{u=Use}if(Fac>0){u=u+Use*(1-u)}FROMcounter=0TO(unoccupied-1){Psurv=exp(-(t-tsyn)/Dep)result=urand()if(result>Psurv){occupied=occupied+1if(verboseLevel>0){UNITSOFFprintf("Recovered!%fattime%gUNITSON}}}ves=0occu=occupied-1FROMcounter=0TOoccu{result=urand()if(result<u){occupied=occupied-1ves=ves+1}}unoccupied=Nrrp-occupiedtsyn=tif(ves>0){A_AMPA=A_AMPA+ves/Nrrp*weight_AMPA*factor_AMPAB_AMPA=B_AMPA+ves/Nrrp*weight_AMPA*factor_AMPAA_NMDA=A_NMDA+ves/Nrrp*weight_NMDA*factor_NMDAB_NMDA=B_NMDA+ves/Nrrp*weight_NMDA*factor_NMDAif(verboseLevel>0){UNITSOFFprintf("Release!%fattime%gUNITSON}}else{if(verboseLevel>0){UNITSOFFprintf("||SYN_IDUNITSON}}}PROCEDUREsetRNG(){VERBATIM#ifndefCORENEURON_BUILDusingR123=0;if(ifarg(1)&&hoc_is_double_arg(1)){nrnran123_State**pv=(nrnran123_State**)(&_p_rng);uint32_ta2=0;uint32_ta3=0;if(*pv){nrnran123_deletestream(*pv);*pv=(nrnran123_State*)0;}if(ifarg(2)){a2=(uint32_t)*getarg(2);}if(ifarg(3)){a3=(uint32_t)*getarg(3);}*pv=nrnran123_newstream3((uint32_t)*getarg(1),a2,a3);usingR123=1;}elseif(ifarg(1)){void**pv=(void**)(&_p_rng);*pv=nrn_random_arg(1);}else{void**pv=(void**)(&_p_rng);*pv=(void*)0;}#endifENDVERBATIM}FUNCTIONurand(){VERBATIMdoublevalue=0.0;if(usingR123){value=nrnran123_dblpick((nrnran123_State*)_p_rng);}elseif(_p_rng){#ifndefCORENEURON_BUILDvalue=nrn_random_pick(_p_rng);#endif}else{value=0.0;}_lurand=value;ENDVERBATIM}FUNCTIONbbsavestate(){bbsavestate=0VERBATIM#ifndefCORENEURON_BUILDdouble*xdir,*xval,*hoc_pgetarg();longnrn_get_random_sequence(void*r);voidnrn_set_random_sequence(void*r,intval);xdir=hoc_pgetarg(1);xval=hoc_pgetarg(2);if(_p_rng){if(*xdir==-1){if(usingR123){*xdir=2.0;}else{*xdir=1.0;}return0.0;}elseif(*xdir==0){if(usingR123){uint32_tseq;charwhich;nrnran123_getseq((nrnran123_State*)_p_rng,&seq,&which);xval[0]=(double)seq;xval[1]=(double)which;}else{xval[0]=(double)nrn_get_random_sequence(_p_rng);}}else{if(usingR123){nrnran123_setseq((nrnran123_State*)_p_rng,(uint32_t)xval[0],(char)xval[1]);}else{nrn_set_random_sequence(_p_rng,(long)(xval[0]));}}}#endifENDVERBATIM}FUNCTIONtoggleVerbose(){verboseLevel=1-verboseLevel}VERBATIMstaticvoidbbcore_write(double*x,int*d,int*xx,int*offset,_threadargsproto_){if(d){uint32_t*di=((uint32_t*)d)+*offset;nrnran123_State**pv=(nrnran123_State**)(&_p_rng);nrnran123_getids3(*pv,di,di+1,di+2);charwhich;nrnran123_getseq(*pv,di+3,&which);di[4]=(int)which;}*offset+=5;}staticvoidbbcore_read(double*x,int*d,int*xx,int*offset,_threadargsproto_){assert(!_p_rng);uint32_t*di=((uint32_t*)d)+*offset;if(di[0]!=0||di[1]!=0||di[2]!=0){nrnran123_State**pv=(nrnran123_State**)(&_p_rng);*pv=nrnran123_newstream3(di[0],di[1],di[2]);unsignedcharwhich=(unsignedchar)di[4];nrnran123_setseq(*pv,di[3],which);}*offset+=5;}ENDVERBATIM