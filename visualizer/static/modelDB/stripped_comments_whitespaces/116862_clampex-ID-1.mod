NEURON{POINT_PROCESSClampExData}ASSIGNED{pointer}VERBATIMexterndoublechkarg();#ifndefNRN_VERSION_GTEQ_8_2_0double*hoc_pgetarg();#endiftypedefstructCEXData{#if1charheader[1024];#elsefloatparm_[80];charcomment_[77];charlabels[5][16];charreserve1[35];charcond_pulse[64];longparm_extension[16];floatadc_ext_offset[16];floatadc_ext_gain[16];floatadc_disp_amp[16];floatadc_disp_offset[16];charadc_units[16][8];#endifshort*data;}CEXData;#defineCEXDCEXData*cexd=(CEXData*)((unsignedlong)pointer);staticvoidreverse(char*b,intn){inti,j,v_;for(i=0,j=n-1;i<j;++i,--j){v_=b[i];b[i]=b[j];b[j]=v_;}}staticvoidheader_endian(char*h){char*b;inti;b=h;for(i=0;i<80;++i){reverse(b,4);b+=4;}b+=(77+80+35+64);for(i=0;i<16;++i){reverse(b,4);b+=4;}for(i=0;i<64;++i){reverse(b,4);b+=4;}}staticdoubleget_parm(inti,char*h){char*b;float*f;long*n;b=h;if(i<=80){f=(float*)b;return(double)f[i-1];}b+=320+77+80+35+64;if(i<=96){f=(float*)b;return(double)f[i-81];}b+=64;if(i<=160){f=(float*)b;return(double)f[i-97];}return0.;}ENDVERBATIMCONSTRUCTOR{VERBATIMFILE*fin;intendian=0;intsamples,episodes;CEXData*cexd;char*fname;fname=gargstr(2);fin=fopen(fname,"rb");if(!fin){printf("can'topen%sforreading\n",fname);}cexd=(CEXData*)emalloc(sizeof(CEXData));pointer=(double)((unsignedlong)cexd);fread(cexd->header,1024,1,fin);cexd->data=0;if(get_parm(1,cexd->header)!=1.){header_endian(cexd->header);endian=1;}if(get_parm(1,cexd->header)!=1.){printf("%sisnotaCLAMPEXfile\n",fname);}samples=(int)get_parm(3,cexd->header);episodes=(int)get_parm(4,cexd->header);cexd->data=(short*)emalloc(samples*episodes*sizeof(short));fread(cexd->data,samples*episodes,sizeof(short),fin);fclose(fin);if(endian){inti;for(i=0;i<samples*episodes;++i){reverse((char*)(cexd->data+i),2);}}ENDVERBATIM}DESTRUCTOR{VERBATIMCEXDif(cexd->data){free(cexd->data);}free(cexd);ENDVERBATIM}FUNCTIONparm(){VERBATIMCEXDinti;i=(int)chkarg(1,1.,160.);_lparm=get_parm(i,cexd->header);ENDVERBATIM}PROCEDUREdatavec(){VERBATIMintntrace,trace,i,length;double*pd;short*tr;CEXDlength=(int)get_parm(3,cexd->header);ntrace=(int)get_parm(4,cexd->header);trace=(int)chkarg(1,0.,(double)(ntrace-1));tr=cexd->data+length*trace;pd=hoc_pgetarg(2);for(i=0;i<length;++i){pd[i]=(double)tr[i];}ENDVERBATIM}FUNCTIONtimestep(){VERBATIMCEXD_ltimestep=get_parm(14,cexd->header)*.001;ENDVERBATIM}FUNCTIONgain(){VERBATIMCEXD_lgain=get_parm(113,cexd->header);ENDVERBATIM}PROCEDUREget_comment(){VERBATIMcharbuf[80];CEXDstrncpy(buf,cexd->header+320,77);buf[77]='\0';printf("%s\n",buf);ENDVERBATIM}PROCEDUREget_label(){VERBATIMcharbuf[80];CEXDinti=(int)chkarg(1,1.,5.);strncpy(buf,cexd->header+(320+77+(i-1)*16),16);buf[16]='\0';printf("%s\n",buf);ENDVERBATIM}PROCEDUREget_cpulse(){VERBATIMcharbuf[80];CEXDstrncpy(buf,cexd->header+320+77+80+35,64);buf[64]='\0';printf("%s\n",buf);ENDVERBATIM}PROCEDUREget_adcunit(){VERBATIMcharbuf[80];CEXDinti=(int)chkarg(1,1.,16.);strncpy(buf,cexd->header+(320+77+80+35+6*64+(i-1)*8),8);buf[8]='\0';printf("%s\n",buf);ENDVERBATIM}