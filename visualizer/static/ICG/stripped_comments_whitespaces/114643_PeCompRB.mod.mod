VERBATIM#definekernel_filename"kernel.txt"ENDVERBATIMINDEPENDENT{tFROM0TO1WITH1(ms)}NEURON{POINT_PROCESSeCompRBPOINTERvcell,i_outRANGEactive,active_pulsesRANGEvr,vr10,vr50,ue,ue10,ue50RANGEkernelRANGEksizeRANGEimaxRANGEt_startRANGEg_e,g_i,g_eout,g_iout,del,dur,i0,amp_ge,amp_gi,pfreq,pdur,E_e,E_iUSEIONzREADezWRITEizVALENCE1}UNITS{(nA)=(nanoamp)(mV)=(millivolt)(umho)=(micromho)}PARAMETER{active=0active_pulses=0t_start=0(ms)ksize=20imax=2(nA)del=0(ms)dur=10000(ms)E_e=0(mV)E_i=-75(mV)amp_ge=0(umho)amp_gi=0(umho)pfreq=10(Hz)pdur=500(ms)}ASSIGNED{vcell(mV)vr(mV)vr10(mV)vr50(mV)ue(mV)ue10(mV)ue50(mV)i_out(nA)kernel[500]previous_i[500](nA)iz(nA)ez(mV)Npulsespstart(ms)pstop(ms)g_e(umho)g_i(umho)g_eout(umho)g_iout(umho)}INITIAL{FROMk=0TO499{previous_i[k]=0}vr=vcellvr10=10*vrvr50=50.4*vrg_e=0g_i=0Npulses=0pstart=delpstop=pstart+pduriz=0}BREAKPOINT{SOLVEcompensate}PROCEDUREcompensate(){if(active&&(i_out>imax||i_out<-imax)){i_out=0}vr=vcellif(active==1&&t>t_start){VERBATIM{intk,kmax;double*pi;double*kern;kmax=(int)ksize;pi=&(previous_i[kmax-1]);kern=&(kernel[kmax-1]);for(k=1;k<kmax;k++){vr-=(*pi=*(pi-1))*(*kern);pi--;kern--;}vr+=i_out*(*kern);}*previous_i=-i_out;ENDVERBATIM}vr10=vr*10vr50=vr*50.4ue=vcell-vrue10=ue*10ue50=ue*50if(active_pulses){if((t>=pstart)&&(t<dur)){g_e=amp_geNpulses=Npulses+1pstart=del+Npulses*1000/pfreqif(1000/pfreq<=pdur){pstop=del+dur}}elseif(t>=pstop){g_e=0pstop=pstart+pdur}}else{g_e=0}iz=g_e*(vr-E_e)g_eout=50000.0*g_e}