NEURON{ARTIFICIAL_CELLINTFRANGEVAM,VNM,VGA,VGB,AHPRANGEtauAM,tauNM,tauGA,tauGB,tauahp,ahpwtRANGEVGBdel,tGB,VGBa,rebound,rebob,offsetGBRANGERMP,VTH,Vm,Vblock,refractoryRANGEtaum,invl,oinvl,WINV,invltRANGEt0,tg,twg,tGB,refrac,VbrefracRANGEnbur,tbur,cbur,AHP2REF,WEXPOINTERsopGLOBALAMdec,NMdec,GAdec,GBdecGLOBALvdt,next,mg,RES,ESIN,Bb,PskGLOBALtauGBGP,wGBGP,GPkd,GnGLOBALEAM,ENM,EGA,EGB,spkhtGLOBALprnum,wwwid,wwht,nsw,rebegGLOBALsubsvint}PARAMETER{tauAM=10(ms)tauNM=300(ms)tauGA=10(ms)tauGB=300(ms)tauGBGP=50(ms)taum=10(ms)invl=100(ms)WINV=0wGBGP=1(ms)GPkd=100ahpwt=0tauahp=10(ms)refrac=5(ms)Vbrefrac=20(ms)wwwid=10wwht=10VTH=-45Vblock=-20vdt=0.1mg=1sop=0AMdec=1NMdec=1GAdec=1GBdec=1nbur=1tbur=2VGBdel=0rebound=0.01offsetGB=0RMP=-65EAM=65ENM=90EGA=-15EGB=-30spkht=50prnum=-1nsw=0AHP2REF=0.1rebeg=0subsvint=0}ASSIGNED{VAMVNMVGAVGBVGBaAHPt0(ms)tGB(ms)tg(ms)twg(ms)refractorynextWEXRESESINGnBbPskcburVminvltoinvlrebob}CONSTRUCTOR{VERBATIM{intlid,lty,lco;if(ifarg(1)){lid=(int)*getarg(1);}else{lid=UINT_MAX;}if(ifarg(2)){lty=(int)*getarg(2);}else{lty=-1;}if(ifarg(3)){lco=(int)*getarg(3);}else{lco=-1;}_p_sop=(void*)ecalloc(1,sizeof(id0));ip=IDP;ip->id=lid;ip->type=lty;ip->col=lco;ip->invl0=ip->record=ip->jitter=ip->input=0;ip->vbr=0;ip->rve=-1;}ENDVERBATIM}DESTRUCTOR{VERBATIM{free(IDP);}ENDVERBATIM}INITIAL{VAM=0VNM=0VGA=0VGB=0VGBa=0t0=ttGB=ttg=0twg=0offsetGB=0AHP=0rebob=-1e9invlt=-1VERBATIMjtpt=0;errflag=0;ENDVERBATIMrefractory=0if(vinflag()){randspk()net_send(next,2)}if(recflag()){recini()}rebeg=0}NET_RECEIVE(wAM,wNM,wGA,wGB,wflg){LOCALtmpINITIAL{wNM=wNMwGA=wGAwGB=wGBwflg=0}VERBATIMip=IDP;ENDVERBATIMVERBATIMif(ip->dbx>2)ENDVERBATIM{pid()printf("DB0if(flag==0){printf("(%g%g%g%g%g)",wAM,wNM,wGA,wGB,wflg)}printf("\n")}if(flag==4){cbur=cbur-1if(cbur>0){net_send(tbur,4)}else{net_send(refrac-AHP*AHP2REF,3)}tmp=tVERBATIMif(ip->jitter)ENDVERBATIM{tmp=t+jitter()/10}net_event(tmp)VERBATIMif(ip->dbx>0)ENDVERBATIM{pid()printf("DBAVERBATIMif(ip->record)ENDVERBATIM{recspk(tmp)}VERBATIMif(ip->wrec)ENDVERBATIM{wrecord(t)}}elseif(flag==0&&wGB==0&&wflg==1){VERBATIMip->input=1;ENDVERBATIMwflg=2randspk()net_send(next,2)}elseif(flag==0&&wGB==0&&wflg==2){VERBATIMip->input=0;ENDVERBATIMwflg=1}else{VERBATIMif(ip->record)ENDVERBATIM{record()}VERBATIMif(ip->wrec)ENDVERBATIM{wrecord(1e9)}if(VAM>hoc_epsilon){VAM=VAM*EXP(-(t-t0)/tauAM)}else{VAM=0}if(VNM>hoc_epsilon){VNM=VNM*EXP(-(t-t0)/tauNM)}else{VNM=0}if(VGA<-hoc_epsilon){VGA=VGA*EXP(-(t-t0)/tauGA)}else{VGA=0}if(VGBdel>0){VGB=esinr(t-tGB)}else{if(VGB<-hoc_epsilon){VGB=VGB*EXP(-(t-t0)/tauGB)}else{VGB=0}}if(AHP<-hoc_epsilon){AHP=AHP*EXP(-(t-t0)/tauahp)}else{AHP=0}t0=tVm=VAM+VNM+VGA+VGB+AHPif(Vm>100||Vm<-60){pid()printf("ERR_Astoprun=1}if(flag==0){if(wAM>0){if(rebob!=1e9&&rebob!=-1e9){VERBATIMcbur=floor(rebound*rebob/EGB);ENDVERBATIMVERBATIMif(ip->dbx==-1)ENDVERBATIM{pid()printf("Cnet_send(tbur,4)rebob=1e9}if(VAM<EAM){tmp=wAM*(1-Vm/EAM)VAM=VAM+tmp}}if(wNM>0&&VNM<ENM){rates(RMP+Vm)tmp=wNM*Bb*(1-Vm/ENM)VNM=VNM+tmp}if(VNM>1.2*ENM){pid()printf("ERR_Bstoprun=1}if(wGA>0&&VGA>EGA){tmp=wGA*(1-Vm/EGA)VGA=VGA-tmp}if(wGB>1e-6){if(VGBdel>0){net_send(VGBdel,5)}else{wflg=wflg*EXP(-(t-tGB)/tauGBGP)+wGBGPcoop(wflg)tmp=wGB*(1-Vm/EGB)*GnVGB=VGB-tmpif(VGB<rebob&&rebob!=1e9&&rebob!=-1e9){rebob=VGB}}}VERBATIMif(ip->invl0)ENDVERBATIM{Vm=RMP+VAM+VNM+VGA+VGB+AHPif(invlt==-1){if(Vm>RMP){oinvl=invlinvlt=tnet_send(invl,1)}}else{tmp=shift(Vm)if(tmp!=0){net_move(tmp)if(id()<prnum){pid()printf("****MOVEt=%gto%gVm=%g%g,%g\n",t,tmp,Vm,invlt,oinvl)}}}}}elseif(flag==5){offsetGB=VGBwflg=wflg*EXP(-(t-tGB)/tauGBGP)+wGBGPcoop(wflg)if(VGB>EGB){tmp=wGB*(1-Vm/EGB)*GnVGB=VGB-tmp}VGBa=VGBtGB=t}elseif(flag==2){VERBATIMif(ip->input==0)ENDVERBATIM{flag=-1}if(flag==2){{pid()printf("DBBaif(WEX<0){net_event(t)VERBATIMif(ip->dbx>0)ENDVERBATIM{pid()printf("DBBif(WEX<-1){cbur=-WEXnet_send(tbur,4)}VERBATIMif(ip->record)ENDVERBATIM{recspk(t)}VERBATIMif(ip->wrec)ENDVERBATIM{wrecord(t)}}elseif(WEX>0){tmp=WEX*(1-Vm/EAM)VAM=VAM+tmp}randspk()if(next>0){net_send(next,2)}}}elseif(flag==1){if(WINV<0){net_event(t)VERBATIMif(ip->dbx>0)ENDVERBATIM{pid()printf("DBCVERBATIMif(ip->record)ENDVERBATIM{recspk(t)}VERBATIMif(ip->wrec)ENDVERBATIM{wrecord(t)}}else{tmp=WINV*(1-Vm/EAM)VAM=VAM+tmp}oinvl=invlinvlt=tnet_send(invl,1)}elseif(flag==3){refractory=0}Vm=VAM+VNM+VGA+VGB+RMP+AHPif(refractory==0&&Vm>VTH){VERBATIMif(!ip->vbr&&Vm>Vblock)return;ENDVERBATIMAHP=AHP-ahpwttmp=tVERBATIMif(ip->jitter)ENDVERBATIM{tmp=t+jitter()}net_event(tmp)VERBATIMif(ip->dbx>0)ENDVERBATIM{pid()printf("DBDVERBATIMif(ip->record)ENDVERBATIM{recspk(tmp)}VERBATIMif(ip->wrec)ENDVERBATIM{wrecord(tmp)}VAM=VAM*AMdecVNM=VNM*NMdecVGA=VGA*GAdecVGB=VGB*GBdecif(nbur>1){cbur=nbur-1net_send(tbur,4)VERBATIMreturn;ENDVERBATIM}elseif(rebob==1e9){rebob=0}refractory=1VERBATIMif(ip->vbr&&Vm>Vblock)ENDVERBATIM{net_send(Vbrefrac,3)VERBATIMif(ip->dbx>0)ENDVERBATIM{pid()printf("DBEVERBATIMreturn;ENDVERBATIM}net_send(refrac-AHP*AHP2REF,3)}}}PROCEDURErandspk(){VERBATIMip=IDP;if(ip->rvi>ip->rve){ip->input=0;next=-1.;}else{while((next=vsp[ip->rvi++]-t)<=1e-6)if(ip->rvi>ip->rve){printf("randspk()ERRA:");chk(2.);hxe();}WEX=wsp[ip->rvi-1];if(ip->dbx==-1){printf("randspk()DBXA:%d%g%g",ip->rvi,next,WEX);chk(2.);}}ENDVERBATIM}PROCEDUREvers(){printf("$Id}VERBATIMdoubleval(doublexx,doubleta){vii[1]=VAM*EXP(-(xx-ta)/tauAM);vii[2]=VNM*EXP(-(xx-ta)/tauNM);vii[3]=VGA*EXP(-(xx-ta)/tauGA);if(VGBdel>0){vii[4]=esinr(xx-tGB);}else{vii[4]=VGB*EXP(-(xx-ta)/tauGB);}vii[5]=AHP*EXP(-(xx-ta)/tauahp);vii[6]=vii[1]+vii[2]+vii[3]+vii[4]+vii[5];}ENDVERBATIMVERBATIMdoublevalps(doublexx,doubleta){vii[1]=VAM*EXP(-(xx-ta)/tauAM);vii[2]=VNM*EXP(-(xx-ta)/tauNM);vii[3]=VGA*EXP(-(xx-ta)/tauGA);vii[6]=vii[1]+vii[2]+vii[3];}ENDVERBATIMPROCEDURErecord(){VERBATIM{intk;doubleti;vp=SOP;if(tg>=t)return;if(vp->p>=vp->size){if(errflag)return;printf("****WARNINGoutofrecordingroomforINTFtype%did%dat%g****\n",IDP->type,IDP->id,t);printf("****************WARNING:NofurtherWARNINGS****************\n");errflag=1;return;}for(ti=tg;ti<=t&&vp->p<vp->size;ti+=vdt,vp->p++){val(ti,tg);vp->vvo[0][vp->p]=ti;for(k=1;k<NSV;k++)if(vp->vvo[k]!=0){vp->vvo[k][vp->p]=vii[k]+RMP;}}tg=t;}ENDVERBATIM}PROCEDURErecspk(x){VERBATIM{intk;vp=SOP;record();if(vp->p>=vp->size||vp->vvo[6]==0)return;vp->vvo[0][vp->p-1]=_lx;vp->vvo[6][vp->p-1]=spkht;tg=_lx;}ENDVERBATIM}PROCEDURErecclr(){VERBATIM{intk;if(IDP->record){if(SOP!=nil){vp=SOP;vp->size=0;vp->p=0;for(k=0;k<NSV;k++){vp->vv[k]=nil;vp->vvo[k]=nil;}}elseprintf("INTFrecclrERR:nilpointer\n");}IDP->record=0;}ENDVERBATIM}PROCEDURErecfree(){VERBATIMif(SOP!=nil){free(SOP);SOP=nil;}elseprintf("INTFrecfreeERR:nilpointer\n");IDP->record=0;ENDVERBATIM}PROCEDUREinitvspks(){VERBATIM{intmax,i,err;doublelast;if(!ifarg(1)){printf("Returninitvspks(ivspks,vspks,wvspks)\n");return0.;}ip=IDP;err=0;i=vector_arg_px(1,&isp);max=vector_arg_px(2,&vsp);if(max!=i){err=1;printf("initvspksERR:vecsofdifferentsize\n");}if(max==0){err=1;printf("initvspksERR:vecnotinitialized\n");}max=vector_arg_px(3,&wsp);if(max!=i){err=1;printf("initvspksERR:3rdvecisofdifferentsize\n");}vspn=max;ip->vinflg=1;for(i=0;i<max&&(int)isp[i]!=ip->id;i++);if(i==max){printf("initvspksWARN:%dnotfoundinivspks\n",ip->id);ip->vinflg=0;ip->rve=-1;return(0.);}ip->rvb=ip->rvi=i;last=vsp[i++];for(;i<max&&(int)isp[i]==ip->id;i++){if(vsp[i]<=last){err=1;printf("initvspksERR:nonmonotonicforcell#%d:%g%g\n",ip->id,last,vsp[i]);}last=vsp[i];}ip->rve=i-1;if(subsvint>0){vsp[ip->rve]=vsp[ip->rvb]+subsvint;wsp[ip->rve]=wsp[ip->rvb];}if(err){ip->rve=0;hoc_execerror("",0);}}ENDVERBATIM}PROCEDUREtrvsp(){VERBATIMinti,flag;doubleind,t0;ip=IDP;flag=(int)*getarg(1);if(subsvint==0.){printf("trvsp");return(0.);}ind=isp[0];t0=vsp[0];if(flag==1){for(i=0;i<vspn;i++){if(isp[i]!=ind){vsp[i-1]=1.e9;ind=isp[i];}}vsp[vspn-1]=1.e9;}elseif(flag==2){for(i=0;i<vspn;i++){if(isp[i]!=ind){vsp[i-1]=t0+subsvint;ind=isp[i];t0=vsp[i];}}vsp[vspn-1]=t0+subsvint;}else{printf("trvspflag%dnotrecognized\n",flag);hxe();}ENDVERBATIM}PROCEDUREinitjitter(){VERBATIM{intmax,i,err=0;jtpt=0;if(!ifarg(1)){printf("Returninitjitter(vec)\n");return(0.);}max=vector_arg_px(1,&jsp);if(max==0){err=1;printf("initjitterERR:vecnotinitialized\n");}for(i=0;i<max;i++)if(jsp[i]<=0){err=1;printf("initjitterERR:vecshouldbe>0:%g\n",jsp[i]);}if(err){jsp=nil;jitmax=0.;return(0.);}if(max!=jitmax){printf("WARNING:resettingjitmax_INTFto%d\n",max);jitmax=max;}}ENDVERBATIM}PROCEDUREinitinvl(){printf("initinvl()NOTBEINGUSED\n")}FUNCTIONinvlflag(){VERBATIMip=IDP;if(ip->invl0==1&&invlp==nil){printf("INTFinvlflagERR:pointernotinitialized\n");hoc_execerror("",0);}_linvlflag=(double)ip->invl0;ENDVERBATIM}FUNCTIONshift(vl){VERBATIMdoubleexpand,tmp,min,max;if((t<(invlt-invl)+invl/2)&&invlt!=-1){_lshift=0.;}else{expand=-(_lvl-(-65))/20;if(expand>1.)expand=1.;if(expand<-1.)expand=-1.;if(expand>0.){max=1.5*invl;tmp=oinvl+0.8*expand*(max-oinvl);}else{min=0.5*invl;tmp=oinvl+0.8*expand*(oinvl-min);}if(invlt+tmp<t+2){_lshift=0.;}else{oinvl=tmp;_lshift=invlt+oinvl;}}ENDVERBATIM}PROCEDURErecini(){VERBATIM{intk;if(SOP==nil){printf("INTFrecordERR:butpointernotinitialized\n");hoc_execerror("",0);}else{vp=SOP;vp->p=0;for(k=0;k<NSV;k++)if(vp->vvo[k]!=0)vector_resize(vp->vv[k],vp->size);}}ENDVERBATIM}PROCEDUREfini(){VERBATIM{intk;IDP->rvi=IDP->rvb;if(IDP->wrec){wrecord(1e9);}if(IDP->record){record();for(k=0;k<NSV;k++)if(vp->vvo[k]!=0){vector_resize(vp->vv[k],vp->p);}}}ENDVERBATIM}PROCEDUREchk(f){VERBATIM{inti,lfg;lfg=(int)_lf;ip=IDP;printf("ID:%d;typ:%d;rec:%dwrec:%dinp:%djit:%dinvl:%d\n",ip->id,ip->type,ip->record,ip->wrec,ip->input,ip->jitter,ip->invl0);if(lfg==1){if(SOP!=nil){vp=SOP;printf("p%dsize%dtg%g\n",vp->p,vp->size,tg);for(i=0;i<NSV;i++)printf("%d%x%x;",i,vp->vv[i],vp->vvo[i]);}elseprintf("Recordingpointersnotinitialized");}if(lfg==2){printf("Globalvectorsforinputandjitter:\n");if(vsp!=nil)printf("VSP:%x(%d/%d-%d)\n",vsp,ip->rvi,ip->rvb,ip->rve);elseprintf("noVSP\n");if(jsp!=nil)printf("JSP:%x(%d/%d)\n",jsp,jtpt,jitmax);elseprintf("noJSP\n");}if(lfg==3){if(vsp!=nil){printf("VSP:(%d/%d-%d)\n",ip->rvi,ip->rvb,ip->rve);for(i=ip->rvb;i<=ip->rve;i++)printf("%d:%g",i,vsp[i]);printf("\n");}elseprintf("noVSP\n");}if(lfg==4){}if(lfg==5){printf("wwpt%dwwsz%d\nWWvecs:",wwpt,wwsz);printf("wwwid%gwwht%dnsw%g\nWWvecs:",wwwid,(int)wwht,nsw);for(i=0;i<NSW;i++)printf("%d%x%x;",i,ww[i],wwo[i]);}}ENDVERBATIM}FUNCTIONpid(){VERBATIMprintf("INTF%d(%d/%d@%g)",IDP->id,IDP->type,IDP->col,t);_lpid=(double)IDP->id;ENDVERBATIM}FUNCTIONid(){VERBATIM_lid=(double)IDP->id;ENDVERBATIM}FUNCTIONtype(){VERBATIM_ltype=(double)IDP->type;ENDVERBATIM}FUNCTIONcol(){VERBATIMip=IDP;if(ifarg(1))ip->col=(unsignedchar)*getarg(1);_lcol=(double)ip->col;ENDVERBATIM}FUNCTIONdbx(){VERBATIMip=IDP;if(ifarg(1))ip->dbx=(unsignedchar)*getarg(1);_ldbx=(double)ip->dbx;ENDVERBATIM}PROCEDUREinitrec(){VERBATIM{inti;void*vv;name=gargstr(1);if(SOP==nil){IDP->record=1;SOP=(vpt*)ecalloc(1,sizeof(vpt));SOP->size=0;}if(IDP->record==0){recini();IDP->record=1;}vp=SOP;i=(int)varnum();if(i==-1){printf("INTFrecordERR%snotrecognized\n",name);hoc_execerror("",0);}vp->vv[i]=vector_arg(2);vector_arg_px(2,&(vp->vvo[i]));if(vp->size==0){vp->size=(unsignedint)vector_buffer_size(vp->vv[i]);}elseif(vp->size!=(unsignedint)vector_buffer_size(vp->vv[i])){printf("INTFinitrecERRvectorsnotallsamesize:%dvs%d",vp->size,vector_buffer_size(vp->vv[i]));hoc_execerror("",0);}}ENDVERBATIM}FUNCTIONvarnum(){LOCALii=-1VERBATIMif(strcmp(name,"time")==0){_li=0.;}elseif(strcmp(name,"VAM")==0){_li=1.;}elseif(strcmp(name,"VNM")==0){_li=2.;}elseif(strcmp(name,"VGA")==0){_li=3.;}elseif(strcmp(name,"VGB")==0){_li=4.;}elseif(strcmp(name,"AHP")==0){_li=5.;}elseif(strcmp(name,"V")==0){_li=6.;}elseif(strcmp(name,"VM")==0){_li=6.;}ENDVERBATIMvarnum=i}PROCEDUREvecname(){VERBATIMinti;i=(int)*getarg(1);if(i==0)printf("time\n");elseif(i==1)printf("VAM\n");elseif(i==2)printf("VNM\n");elseif(i==3)printf("VGA\n");elseif(i==4)printf("VGB\n");elseif(i==5)printf("AHP\n");elseif(i==6)printf("V\n");ENDVERBATIM}PROCEDURErebuild(){LOCALs0,w0,wwaz,ii,wflg,tmpVERBATIMintii,jj;doublei0,tstop;ip=IDP;vp=SOP;ip->record=1;ip->input=0;i0=wwo[1][0];initmodel();_lwwaz=wwaz;_lii=0.;tstop=(ifarg(1))?(*getarg(1)):0.;ENDVERBATIMWHILE(ii<wwaz){VERBATIMintii=(int)_lii;if(wwo[1][ii]!=i0){printf("ERRORwrongidat%d%gnot%g\n",ii,wwo[1][ii],i0);hoc_execerror("",0);}t=wwo[0][ii];_ls0=wwo[2][ii];_lw0=wwo[3][ii];ENDVERBATIMrecord()if(VAM>hoc_epsilon){VAM=VAM*EXP(-(t-t0)/tauAM)}else{VAM=0}if(VNM>hoc_epsilon){VNM=VNM*EXP(-(t-t0)/tauNM)}else{VNM=0}if(VGA<-hoc_epsilon){VGA=VGA*EXP(-(t-t0)/tauGA)}else{VGA=0}VGB=esinr(t-tGB)if(AHP<-hoc_epsilon){AHP=AHP*EXP(-(t-t0)/tauahp)}else{AHP=0}if(s0==0){VAM=VAM+w0}if(s0==1){VNM=VNM+w0}if(s0==2){VGA=VGA-w0}if(s0==3){offsetGB=VGBVGB=VGB-w0VGBa=VGBtGB=t}if(s0==-2){recspk(t)AHP=AHP-ahpwtVAM=VAM*AMdecVNM=VNM*NMdecVGA=VGA*GAdecVGB=VGB*GBdec}if(s0==-1){recspk(t)}t0=tii=ii+1}if(tstop>0){VERBATIMt=tstop;ENDVERBATIMrecord()}}PROCEDUREinitwrecOLD(){VERBATIM{intk;if(!ifarg(4)){wwsz=WSZ;wf1=hoc_obj_file_arg(1);wf2=hoc_obj_file_arg(2);}elseif(!ifarg(8)){if(WSW!=4){printf("INTFinitwrecERRw-vecscompiledfor4args\n");hoc_execerror("",0);}IDP->wrec=1;for(k=0;k<WSW;k++){ww[k]=vector_arg(k+1);wwaz=vector_arg_px(k+1,&(wwo[k]));}if(wwsz==0)wwsz=(unsignedint)vector_buffer_size(ww[0]);for(k=0;k<WSW;k++)if(wwsz!=(unsignedint)vector_buffer_size(ww[k])){printf("INTFinitwrecERRw-vecssizeerr:%d,%d,%d",k,wwsz,vector_buffer_size(ww[k]));}}else{if(WSW!=8){printf("INTFinitwrecERRw-vecscompiledfor8args\n");hoc_execerror("",0);}IDP->wrec=1;for(k=0;k<WSW;k++){ww[k]=vector_arg(k+1);wwaz=vector_arg_px(k+1,&(wwo[k]));}if(wwsz==0)wwsz=(unsignedint)vector_buffer_size(ww[0]);for(k=0;k<WSW;k++)if(wwsz!=(unsignedint)vector_buffer_size(ww[k])){printf("INTFinitwrecERRw-vecssizeerr:%d,%d,%d",k,wwsz,vector_buffer_size(ww[k]));}}}ENDVERBATIM}PROCEDUREinitwrec(){VERBATIM{inti,k,num,cap;Object*ob;ob=*hoc_objgetarg(1);num=ivoc_list_count(ob);if(num>NSW){printf("INTFinitwrec()WARN:canonlystore%dwwvecs\n",NSW);hxe();}nsw=(double)num;for(k=0;k<num;k++){cap=list_vector_px2(ob,k,&wwo[k],&ww[k]);if(k==0)wwsz=cap;elseif(wwsz!=cap){printf("INTFinitwrecERRw-vecssizeerr:%d,%d,%d",k,wwsz,cap);hxe();}}}ENDVERBATIM}PROCEDUREwrecordOLD(t,s0,w0){VERBATIM{intk;doubleid=(double)IDP->id;if(wwpt>=wwsz){wwpt=0;fprintf(wf1,"fwrite(&wwt,sizeof(float),WSZ,wf2);fwrite(&wwi,sizeof(int),WSZ,wf2);fwrite(&wws,sizeof(char),WSZ,wf2);fwrite(&www,sizeof(float),WSZ,wf2);}wwt[wwpt]=(float)_lt;wwi[wwpt]=(unsignedint)IDP->id;wws[wwpt]=(char)_ls0;www[wwpt]=(float)_lw0;wwpt++;}ENDVERBATIM}PROCEDUREpopspk(x){TABLEPskDEPENDwwwid,wwhtFROM-40TO40WITH81Psk=-wwht*exp(-2.*x*x/wwwid/wwwid)}PROCEDUREpskshowtable(){VERBATIMintj;printf("_tmin_popspk:%g-_tmin_popspk:%g\n",_tmin_popspk,-_tmin_popspk);for(j=0;j<=-2*(int)_tmin_popspk+1;j++)printf("%g",_t_Psk[j]);printf("\n");ENDVERBATIM}PROCEDUREwrecord(te){VERBATIM{intj,k,max,wrp;doubleti,scale;wrp=(int)IDP->wrec-1;scale=(double)IDP->wscale;if(_lte<1.e9){max=-(int)_tmin_popspk;k=(int)floor((_lte-rebeg)/vdt+0.5);for(j=-max;j<=max&&k+j>0&&k+j<wwsz;j++){wwo[wrp][k+j]+=scale*_t_Psk[j+max];}}elseif(twg>=t){return;}else{for(ti=twg,k=(int)floor((twg-rebeg)/vdt+0.5);ti<=t&&k<wwsz;ti+=vdt,k++){valps(ti,twg);wwo[wrp][k]+=scale*vii[6];}twg=ti;}}ENDVERBATIM}FUNCTIONwrec(){VERBATIMip=IDP;if(ifarg(1))ip->wrec=(unsignedchar)*getarg(1);if(ifarg(2))ip->wscale=(float)*getarg(2);elseip->wscale=1.;_lwrec=(double)ip->wrec;ENDVERBATIM}FUNCTIONwwszset(){VERBATIMif(ifarg(1))wwsz=(unsignedint)*getarg(1);_lwwszset=(double)wwsz;ENDVERBATIM}FUNCTIONwwfree(){VERBATIMintk;IDP->wrec=0;wwsz=0;wwpt=0;nsw=0.;for(k=0;k<NSW;k++){ww[k]=nil;wwo[k]=nil;}ENDVERBATIM}FUNCTIONjitter(){if(jitmax>0&&jtpt>=jitmax){jtpt=0printf("Warning,cyclingthroughjittervectoratt=%g\n",t)}if(jitmax>0){VERBATIM_ljitter=jsp[jtpt++];ENDVERBATIM}else{jitter=0}}PROCEDUREglobal_init(){popspk(0)VERBATIMintj,k;if(nsw>0.&&wwo[0]!=0){printf("Initializingwwtorecordfor%g(%g)\n",vdt*wwsz,vdt);wwpt=0;for(k=0;k<(int)nsw;k++){vector_resize(ww[k],wwsz);for(j=0;j<wwsz;j++)wwo[k][j]=0.;}}elseprintf("global_initWARNING:wrecnotinitialized\n");ENDVERBATIM}PROCEDUREglobal_fini(){VERBATIMintk;for(k=0;k<(int)nsw;k++)vector_resize(ww[k],(int)floor(t/vdt+0.5));ENDVERBATIM}PROCEDUREglobal_finiOLD(){VERBATIM{intk;if(IDP->wrec){if(wwo[0]!=0){for(k=0;k<WSW;k++)vector_resize(ww[k],wwpt);}else{fprintf(wf1,"fwrite(&wwt,sizeof(float),wwpt,wf2);fwrite(&wwi,sizeof(int),wwpt,wf2);fwrite(&wws,sizeof(char),wwpt,wf2);fwrite(&www,sizeof(float),wwpt,wf2);printf("Closingfilewithwwpt=%datlocation%d\n",wwpt,ftell(wf2));fclose(wf1);fclose(wf2);}}else{printf("WARNING:global_fini()calledfrom%d:%dwithnowrecpointers\n",IDP->type,IDP->id);}}ENDVERBATIM}FUNCTIONfflag(){fflag=1}FUNCTIONthresh(){thresh=VTH-RMP}FUNCTIONrecflag(){VERBATIM_lrecflag=(double)IDP->record;ENDVERBATIM}FUNCTIONvinflag(){VERBATIMip=IDP;if(ip->vinflg==0&&vsp==nil){}elseif(ip->vinflg==1&&ip->rve==-1){printf("INTFvinflagERR:pointernotinitialized\n");hoc_execerror("",0);}elseif(ip->rve>=0){if(vsp==nil){printf("INTFvinflagERR1:pointernotinitialized\n");hoc_execerror("",0);}ip->rvi=ip->rvb;ip->input=1;}_lvinflag=(double)ip->vinflg;ENDVERBATIM}FUNCTIONjitset(){VERBATIMip=IDP;if(ifarg(1))ip->jitter=(unsignedchar)*getarg(1);_ljitset=(double)ip->jitter;ENDVERBATIM}FUNCTIONflag(){VERBATIMchar*sf;intii;ip=IDP;sf=gargstr(1);for(ii=0;ii<iflnum&&strncmp(sf,&iflags[ii*4],3)!=0;ii++);if(ii==10){printf("INTFERR:%snotfoundasaflag(%s)\n",sf,iflags);hxe();}if(ifarg(2))(&ip->type)[ii]=(unsignedchar)*getarg(2);_lflag=(double)(unsignedchar)(&ip->type)[ii];ENDVERBATIM}FUNCTIONinvlset(){VERBATIMip=IDP;if(ifarg(1))ip->invl0=(unsignedchar)*getarg(1);_linvlset=(double)ip->invl0;ENDVERBATIM}FUNCTIONvinset(){VERBATIMip=IDP;if(ifarg(1))ip->vinflg=(unsignedchar)*getarg(1);if(ip->vinflg==1){ip->input=1;ip->rvi=ip->rvb;}_lvinset=(double)ip->vinflg;ENDVERBATIM}PROCEDUREEXPo(x){TABLERESFROM-20TO0WITH5000RES=exp(x)}FUNCTIONEXP(x){EXPo(x)EXP=RES}FUNCTIONesinr(x){ESINo(PI*x/tauGB)if(x<tauGB){esinr=(VGBa-offsetGB)*ESIN+offsetGB}elseif(x>2*tauGB){esinr=0}else{esinr=rebound*VGBa*ESIN}}PROCEDUREESINo(x){TABLEESINFROM0TO2*PIWITH3000ESIN=sin(x)}PROCEDURErates(vv){TABLEBbDEPENDmgFROM-100TO50WITH300Bb=1/(1+exp(0.062(/mV)*-vv)*(mg/3.57(mM)))}PROCEDUREcoop(x){TABLEGnDEPENDGPkdFROM0TO10WITH100Gn=(x^4)/(x^4+GPkd)}