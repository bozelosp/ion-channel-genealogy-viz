NEURON{ARTIFICIAL_CELLJitConPOINTERsop}PARAMETER{sop=0}ASSIGNED{}CONSTRUCTOR{VERBATIM{intlid,lty,lco,i;if(ifarg(1)){lid=(int)*getarg(1);}else{lid=UINT_MAX;}if(ifarg(2)){lty=(int)*getarg(2);}else{lty=-1;}if(ifarg(3)){lco=(int)*getarg(3);}else{lco=-1;}_p_sop=(void*)ecalloc(1,sizeof(id0));ip=IDP;ip->id=lid;ip->type=lty;ip->col=lco;ip->pg=0x0;ip->dvi=0x0;ip->sprob=0x0;ip->jcn=0;process=(int)getpid();CNAME[SU]="SU";CNAME[DP]="DP";CNAME[IN]="IN";}ENDVERBATIM}DESTRUCTOR{VERBATIM{free(IDP);}ENDVERBATIM}INITIAL{}NET_RECEIVE(w){LOCALtmp,jcnVERBATIMip=IDP;_ljcn=ip->jcn;tpnt=_pnt;if(!ip->jcn){net_event(tpnt,t);}elseif(_lflag==0){jitcon(t);}elseif(_lflag<0){callback(_lflag);}ENDVERBATIM}PROCEDUREjitcon(tm){VERBATIM{doublemindel,randel,idty,*x;intprty,poty,i,j,k,dv,dvt;Point_process*pnt;void*voi;ip=IDP;prty=(int)ip->type;if(ip->jcn==1){if(!pg){printf("Nonetworkdefined--mustrunjitcondiv()\n");hxe();}#ifdefined(t)if(ip->dvt>0)net_send((void**)0x0,wts,tpnt,ip->del[0]+t,-1.);#elseif(ip->dvt>0)net_send((void**)0x0,wts,tpnt,ip->del[0],-1.);#endif}elseif(ip->jcn==3){mkdvi();}elseif(ip->jcn==2){for(i=0,k=0,dvt=0;i<CTYN;i++){poty=cty[i];printf("%d:%d:%d",prty,poty,(int)DVG(prty,poty));dvt+=(int)DVG(prty,poty);}for(i=0,k=0,dvt=0;i<CTYN;i++){if(dv>0){mcell_ran4(&sead,&randel,1,2.*DELD(prty,poty));randel+=((_ltm-t)+DELM(prty,poty)-DELD(prty,poty));if(randel<=0)randel=-randel;if(dv>scrsz){printf("A:Divergenceexceedsscrsz:%d>%dfor%d->%d\n",dv,scrsz,prty,poty);hxe();}mcell_ran4(&sead,scr,dv,pg->ixe[poty]-pg->ix[poty]+1);if(ifarg(2)){voi=vector_arg(2);x=vector_newsize(voi,k+dv+1);x[k++]=-randel;for(j=0;j<dv;j++,k++)x[k]=floor(scr[j]+pg->ix[poty]);}elsefor(j=0;j<dv;j++){pnt=(Point_process*)(ivoc_list_item(ce,(int)(scr[j]+pg->ix[poty])))->u.this_pointer;idty=(double)(FOFFSET+ip->id)+0.1*(double)ip->type+0.01;#ifdefined(t)net_send((void**)0x0,wts,pnt,randel+t,idty);#elsenet_send((void**)0x0,wts,pnt,randel,idty);#endif}}}}}ENDVERBATIM}PROCEDUREcallback(fl){VERBATIM{intii,jj;doubleidty,del;doubleweed,prid,prty,poid,poty,w;unsignedintvalseed;ii=(unsignedint)((-_lfl)-1);ip=IDP;idty=(double)(FOFFSET+ip->id)+0.1*(double)ip->type+0.01;jj=ii+1;if(jj<ip->dvt){del=ip->del[jj]-ip->del[ii];#ifdefined(t)net_send((void**)0x0,wts,tpnt,del+t,(double)-(jj+1));#elsenet_send((void**)0x0,wts,tpnt,del,(double)-(jj+1));#endif}if(ip->sprob[ii]){poid=ip->dvi[ii]->_prop->param[3];poty=ip->dvi[ii]->_prop->param[4];prid=ip->dvi[ii]->_prop->param[5];prty=ip->dvi[ii]->_prop->param[6];if((((double)ip->type)!=prty)||(((double)ip->id)!=prid)){printf("callback()ERR:%g%g%g%g%g%g\n",\((double)ip->type),prty,((double)ip->id),prid,poty,poid);hxe();}weed=prty*allcells+poty*100+prid*10+poid;valseed=(unsignedint)weed;w=WMAT((int)prty,(int)poty);mcell_ran4(&valseed,&wts,1,2*0.01*w);wts[0]+=0.99*w;(*pnt_receive[ip->dvi[ii]->_prop->_type])(ip->dvi[ii],wts,0.0);}}ENDVERBATIM}PROCEDUREmkdvi(){VERBATIM{inti,j,k,prty,poty,dv,dvt,dvii;double*x,*db,*dbs;Object*lb;Point_process*pnnt,**da,**das;ip=IDP;ip->pg=pg;prty=ip->type;sead=((unsignedint)ip->id)*1e6;for(i=0,k=0,dvt=0;i<CTYN;i++){poty=cty[i];dvt+=DVG(prty,poty);}da=(Point_process**)malloc(dvt*sizeof(Point_process*));das=(Point_process**)malloc(dvt*sizeof(Point_process*));db=(double*)malloc(dvt*sizeof(double));dbs=(double*)malloc(dvt*sizeof(double));for(i=0,k=0,dvii=0;i<CTYN;i++){poty=cty[i];dv=DVG(prty,poty);if(dv>0){sead+=dv;if(dv>scrsz){printf("B:Divergenceexceedsscrsz:%d>%dfor%d->%d\n",dv,scrsz,prty,poty);hxe();}mcell_ran4(&sead,scr,dv,pg->ixe[poty]-pg->ix[poty]+1);for(j=0;j<dv;j++){if(!(lb=ivoc_list_item(ce,(unsignedint)floor(scr[j]+pg->ix[poty])))){printf("JitCon:callback%gexceeds%dforlistce\n",floor(scr[j]+pg->ix[poty]),cesz);hxe();}pnnt=(Point_process*)lb->u.this_pointer;da[j+dvii]=pnnt;}mcell_ran4(&sead,scr,dv,2*DELD(prty,poty));for(j=0;j<dv;j++){db[j+dvii]=scr[j]+DELM(prty,poty)-DELD(prty,poty);if(db[j+dvii]<0)db[j+dvii]=-db[j+dvii];}dvii+=dv;}}gsort2(db,da,dvt,dbs,das);ip->del=dbs;ip->dvi=das;ip->dvt=dvt;ip->sprob=(unsignedchar*)malloc(dvt*sizeof(char*));for(i=0;i<dvt;i++)ip->sprob[i]=1;free(da);free(db);}ENDVERBATIM}FUNCTIONgetdvi(){VERBATIM{intj,dvt;double*dbs,*x;void*voi;Point_process**das;ip=IDP;ip->pg=pg;dvt=ip->dvt;dbs=ip->del;das=ip->dvi;_lgetdvi=(double)dvt;if(!ifarg(1))return_lgetdvi;if(hoc_is_double_arg(1)){}voi=vector_arg(1);x=vector_newsize(voi,dvt);for(j=0;j<dvt;j++){x[j]=(double)das[j]->_prop->param[3];}voi=vector_arg(2);x=vector_newsize(voi,dvt);for(j=0;j<dvt;j++)x[j]=dbs[j];if(ifarg(3)){voi=vector_arg(3);x=vector_newsize(voi,dvt);for(j=0;j<dvt;j++)x[j]=(double)ip->sprob[j];}}ENDVERBATIM}PROCEDUREsetdvi(){VERBATIM{inti,j,k,dvt,dvu,ddvi,lbcnt;double*y,*db,*dbs,id;void*voi;Object*lb,*lc,*syo;Point_process*pnnt,**da,**das;ip=IDP;ip->pg=pg;id=(double)ip->id;dvt=vector_arg_px(1,&y);i=vector_arg_px(2,&db);if(i!=dvt){printf("setdvi()ERRvecsizes:%d%d\n",dvt,j);hxe();}if(ip->type==IN)syo=gal;elsesyo=aml;da=(Point_process**)malloc(dvt*sizeof(Point_process*));das=(Point_process**)malloc(dvt*sizeof(Point_process*));dbs=(double*)malloc(dvt*sizeof(double));for(j=0,i=0;j<dvt;j++){lb=ivoc_list_item(syo,(unsignedint)y[j]);if(!lb){printf("JitCon:callback%gexceeds%dforlistce\n",y[j],cesz);hxe();}lbcnt=ivoc_list_count(lb);for(k=0;k<lbcnt;k++){lc=ivoc_list_item(lb,k);if(((Point_process*)lc->u.this_pointer)->_prop->param[5]==id){da[j]=(Point_process*)lc->u.this_pointer;break;}}if(k==lbcnt){printf("setdvi()ERR:id%gnotfound\n",id);hxe();}}gsort2(db,da,dvt,dbs,das);ip->del=dbs;ip->dvi=das;ip->dvt=dvt;ip->sprob=(unsignedchar*)malloc(dvt*sizeof(char*));for(j=0;j<dvt;j++)ip->sprob[j]=1;free(da);}ENDVERBATIM}PROCEDUREprune(){VERBATIM{double*x,p;intnx,j;ip=IDP;ip->pg=pg;if(hoc_is_double_arg(1)){p=*getarg(1);if(p<0||p>1){printf("JitCon:pruneERR0:need#[0,1]toprune[ALL,NONE]:%g\n",p);hxe();}if(p==1.)printf("JitConpruneWARNING:pruning100%ofcell%d\n",ip->id);if(ip->dvt>scrsz){printf("JitConpruneB:Divexceedsscrsz:%d>%d\n",ip->dvt,scrsz);hxe();}for(j=0;j<ip->dvt;j++)ip->sprob[j]=1;if(p==0.)return;sead=(ifarg(2))?(unsignedint)*getarg(2):(unsignedint)ip->id*1e6;mcell_ran4(&sead,scr,ip->dvt,1.0);for(j=0;j<ip->dvt;j++)if(scr[j]<p)ip->sprob[j]=0;}else{nx=vector_arg_px(1,&x);if(nx!=ip->dvt){printf("JitCon:pruneERRA:Wrongsizevector:%d!=%d\n",nx,ip->dvt);hxe();}for(j=0;j<ip->dvt;j++)ip->sprob[j]=(unsignedchar)x[j];}}ENDVERBATIM}VERBATIMintgsort2(double*db,Point_process**da,intdvt,double*dbs,Point_process**das){unsignedint*scr,i;scr=scrset(dvt);for(i=0;i<dvt;i++)scr[i]=i;nrn_mlh_gsort(db,scr,dvt,cmpdfn);for(i=0;i<dvt;i++){dbs[i]=db[scr[i]];das[i]=da[scr[i]];}}ENDVERBATIMPROCEDUREfreedvi(){VERBATIM{inti,poty;id0*jp;jp=IDP;if(jp->dvi){free(jp->dvi);free(jp->del);jp->dvi=0x0;jp->del=0x0;}}ENDVERBATIM}FUNCTIONqstats(){VERBATIM{doublestt[3];intlct,flag;FILE*tf;if(ifarg(1)){tf=hoc_obj_file_arg(1);flag=1;}elseflag=0;lct=cty[IDP->type];_lqstats=nrn_event_queue_stats(&stt);printf("QUEUE:Inserted%g;removed%g\n",stt[0],stt[2]);if(flag){fprintf(tf,"QUEUE:Inserted%g;removed%gremaining:%g\n",stt[0],stt[2],_lqstats);}}ENDVERBATIM}FUNCTIONqsz(){VERBATIM{doublestt[3];_lqsz=nrn_event_queue_stats(&stt);}ENDVERBATIM}PROCEDUREqclr(){VERBATIM{clear_event_queue();}ENDVERBATIM}PROCEDUREjitcondiv(){VERBATIM{Symbol*sym;inti,j;charname[100];ip->pg=(postgrp*)malloc(sizeof(postgrp));pg=ip->pg;sym=hoc_lookup("ce");ce=(*(hoc_objectdata[sym->u.oboff].pobj));sym=hoc_lookup("aml");aml=(*(hoc_objectdata[sym->u.oboff].pobj));sym=hoc_lookup("gal");gal=(*(hoc_objectdata[sym->u.oboff].pobj));cesz=ivoc_list_count(ce);if(cesz!=(i=ivoc_list_count(aml))||cesz!=(j=ivoc_list_count(gal))){printf("All3listsshouldbesamesize:ce,aml,gal%d,%d,%d\n",cesz,i,j);hxe();}cty[0]=SU;cty[1]=IN;CTYPi=HVAL("CTYPi");STYPi=HVAL("STYPi");scrsz=HVAL("scrsz");allcells=HVAL("allcells");pg->ix=HPTR("ix");pg->ixe=HPTR("ixe");pg->dvg=HPTR("div");pg->wmat=HPTR("wmat");pg->delm=HPTR("delm");pg->deld=HPTR("deld");scr=HPTR("scr");if(!ce){printf("JitConjitcondivERRA:cenotfound\n");hxe();}printf("Checkingforpossiblesegerrorindoublearrays:CTYPi==%d:",CTYPi);printf("%d%d%d",DVG(CTYPi-1,CTYPi-1),(int)pg->ix[CTYPi-1],(int)pg->ixe[CTYPi-1]);printf("%g",WMAT(CTYPi-1,CTYPi-1));printf("%g%g",DELM(CTYPi-1,CTYPi-1),DELD(CTYPi-1,CTYPi-1));printf("%d%g\n",scrsz,scr[scrsz-1]);}ENDVERBATIM}PROCEDUREprobejcd(){VERBATIM{inti,a[4];for(i=1;i<=3;i++)a[i]=(int)*getarg(i);printf("CTYPi:%d,STYPi:%d,",CTYPi,STYPi);printf("wmat:%g\n",WMAT(a[1],a[2]));}ENDVERBATIM}PROCEDUREvers(){printf("$Id}VERBATIMstaticdouble*lop(Object*ob,unsignedinti){Object*lb;lb=ivoc_list_item(ob,i);if(!lb){printf("JitCon:lop%dexceeds%dforlistce\n",i,cesz);hxe();}pmt=ob2pntproc(lb);qp=*((id0**)&((pmt->_prop->dparam)[2]));returnpmt->_prop->param;}intstoppo(){}ENDVERBATIMPROCEDURElof(){VERBATIM{Object*ob;intnum,i,ii,j,k,si,nx;double*vvo[7],*par;void*vv[7];ob=*(hoc_objgetarg(1));si=(int)*getarg(2);num=ivoc_list_count(ob);if(num!=7){printf("JitConlofERR%d>7\n",num);hxe();}for(i=0;i<num;i++){j=list_vector_px3(ob,i,&vvo[i],&vv[i]);if(i==0)nx=j;if(j!=nx){printf("JitConlofERR%d%d\n",j,nx);hxe();}}}ENDVERBATIM}PROCEDUREldv(){VERBATIM{Object*ob;intdv,num,i,j,ii,prty,poty,nx,offset;double*vvo[100000],*x;void*vv[100000];ob=*(hoc_objgetarg(1));nx=vector_arg_px(2,&x);prty=(int)*getarg(3);poty=(int)*getarg(4);if(ifarg(5))offset=(int)*getarg(5);elseoffset=0;num=ivoc_list_count(ob);if(num!=nx){printf("JitConldvERRD%d%d\n",num,nx);hxe();}if(num>1e5){printf("JitConldvERRA%d>1e5\n",num);hxe();}i=0;nx=list_vector_px3(ob,i,&vvo[i],&vv[i]);dv=DVG(prty,poty);if(nx!=dv){printf("JitConldvERRB%d%d\n",dv,nx);hxe();}for(i=1;i<num;i++){j=list_vector_px3(ob,i,&vvo[i],&vv[i]);if(j!=nx){printf("JitConldvERRC%d%d\n",j,nx);hxe();}}if(ii!=num)printf("INFldvWARNING:onlyfilled%dof%dcolumns\n",ii,num);}ENDVERBATIM}PROCEDUREchk(f){VERBATIM{inti,lfg;lfg=(int)_lf;ip=IDP;if(lfg==1){}if(lfg==2){}if(lfg==3){}if(lfg==4){}if(lfg==5){}}ENDVERBATIM}FUNCTIONpid(){VERBATIMprintf("JitCon%d(%d/%d@%g)",IDP->id,IDP->type,IDP->col,t);_lpid=(double)IDP->id;ENDVERBATIM}FUNCTIONid(){VERBATIMif(ifarg(1))IDP->id=(unsignedint)*getarg(1);_lid=(double)IDP->id;ENDVERBATIM}FUNCTIONtype(){VERBATIMif(ifarg(1))IDP->type=(unsignedchar)*getarg(1);_ltype=(double)IDP->type;ENDVERBATIM}FUNCTIONcol(){VERBATIMip=IDP;if(ifarg(1))ip->col=(unsignedchar)*getarg(1);_lcol=(double)ip->col;ENDVERBATIM}FUNCTIONdbx(){VERBATIMip=IDP;if(ifarg(1))ip->dbx=(unsignedchar)*getarg(1);_ldbx=(double)ip->dbx;ENDVERBATIM}FUNCTIONfflag(){fflag=1}FUNCTIONflag(){VERBATIM{char*sf;intii,i;unsignedcharval;ip=IDP;sf=gargstr(1);for(ii=0;ii<iflnum&&strncmp(sf,&iflags[ii*4],3)!=0;ii++);if(ii==iflnum){printf("JitConERR:%snotfoundasaflag(%s)\n",sf,iflags);hxe();}if(ifarg(2))(&ip->type)[ii]=val=(unsignedchar)*getarg(2);_lflag=(double)(unsignedchar)(&ip->type)[ii];if(ifarg(3))for(i=0;i<cesz;i++){lop(ce,i);(&qp->type)[ii]=val;}}ENDVERBATIM}