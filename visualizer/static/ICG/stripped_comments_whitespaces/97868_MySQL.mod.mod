NEURON{SUFFIXmysqlGLOBALverbose}PARAMETER{verbose=0}VERBATIM#include<stdlib.h>#include"mysql/mysql.h"#include"mysql/errmsg.h"MYSQLg_mysql;staticintg_iInit=0;MYSQL_RES*g_result=0;charg_user_name[1024]={0};charg_user_pass[1024]={0};charg_host[1024]={0};externObject**hoc_objgetarg();externintivoc_list_count(Object*);intlist_vector_px();externchar*hoc_object_name(Object*);voidFreeRes(MYSQL_RES**ppRes){if(!ppRes)return;mysql_free_result(*ppRes);*ppRes=0;}intConnectReal(){mysql_options(&g_mysql,MYSQL_READ_DEFAULT_GROUP,"nrniv");my_boolrt=1;mysql_options(&g_mysql,MYSQL_OPT_RECONNECT,&rt);if(!mysql_real_connect(&g_mysql,g_host,g_user_name,g_user_pass,NULL,0,NULL,0)){printf("\nConnectRealERRA:FailedtoconnecttoMySQLserver\n");return0.0;}if(0!=mysql_autocommit(&g_mysql,1)){printf("\nConnectRealERRB:Couldn'tturnauto-commitmodeon\n");return0.0;}return1.0;}intInitReal(){g_iInit=0;if(mysql_init(&g_mysql)==NULL){printf("\nInitRealERRA:FailedtoinitMySQLconnection\n");return0.0;}else{g_mysql.reconnect=1;if(ConnectReal()){g_iInit=1;return1.0;}return0.0;}}intCheckConnection(){if(!g_iInit){printf("MySQLERRA:neverconnectedtoMySQLserver\n");return0;}g_mysql.reconnect=1;intiCheck=mysql_ping(&g_mysql);if(iCheck==0)return1.0;if(iCheck==CR_SERVER_GONE_ERROR){printf("MySQLConnectiontimedout,reconnecting...\n");return1;}printf("LostconnectiontoMySQLserver:Error:%s\n",mysql_error(&g_mysql));return0;}ENDVERBATIMFUNCTIONReCon(){VERBATIMprintf("g_mysql.reconnect=%d\n",g_mysql.reconnect);returng_mysql.reconnect;ENDVERBATIM}FUNCTIONClose(){VERBATIMif(!g_iInit){printf("\nCloseMySQLERRA:Noconnectiontoclose\n");return0;}mysql_close(&g_mysql);g_iInit=0;printf("\nClosedMySQLconnection\n");return1.0;ENDVERBATIM}FUNCTIONInit(){VERBATIMif(g_iInit){printf("Init:Alreadyinitialized,checkingconnectionstatus...\n");return(double)CheckConnection();}if(!ifarg(3)){printf("\nInitERRB:usage:Init(host,user,passwd)\n");return0.0;}char*tmp=gargstr(1);intiLen=strlen(tmp);if(iLen>=1024){printf("InitERR:hoststringmustbe<1024chars%d!\n",iLen);return0.0;}else{strcpy(g_host,tmp);}tmp=gargstr(2);iLen=strlen(tmp);if(iLen>=1024){printf("InitERR:userstringmustbe<1024chars%d!\n",iLen);return0.0;}else{strcpy(g_user_name,tmp);}tmp=gargstr(3);iLen=strlen(tmp);if(iLen>=1024){printf("InitERR:passwdstringmustbe<1024chars%d!\n",iLen);return0.0;}else{strcpy(g_user_pass,tmp);}return(double)InitReal();ENDVERBATIM}FUNCTIONSelectDB(){VERBATIMif(!CheckConnection())return0.0;if(!ifarg(1)){printf("SelectDBERRA:mustsupplydatabasename\n");return0.0;}char*dbname=gargstr(1);if(mysql_select_db(&g_mysql,dbname)==0){printf("Database%sSelected\n",dbname);}else{printf("FailedtoconnecttoDatabase:Error:%s\n",mysql_error(&g_mysql));}return1.0;ENDVERBATIM}FUNCTIONFreeResults(){VERBATIMif(!CheckConnection())return0.0;if(!g_result){printf("FreeResultsERRA:Noresultstofree\n");return0.0;}FreeRes(&g_result);return1.0;ENDVERBATIM}FUNCTIONNumCols(){VERBATIMif(!CheckConnection())return0.0;if(g_result){return(double)mysql_num_fields(g_result);}else{printf("NumColsERRA:noresultset\n");return0.0;}ENDVERBATIM}FUNCTIONNumRows(){VERBATIMif(!CheckConnection())return0.0;if(g_result){return(double)mysql_num_rows(g_result);}else{printf("NumRowsERRA:noresultset\n");return0.0;}ENDVERBATIM}FUNCTIONGetRows(){VERBATIMif(!CheckConnection())return0.0;if(!ifarg(1)){printf("GetRowsERRA:mustpassinlistofvectorsasarg1\n");return-1.0;}if(!g_result){printf("GetRowsERRB:noSQLresults\n");return-1.0;}unsignedintnum_fields=mysql_num_fields(g_result);unsignedintnum_rows=mysql_num_rows(g_result);if(num_fields==0){printf("GetRowsERRC:emptySQLresultsrows=%dfields=%d\n",num_rows,num_fields);return-1.0;}Object*pList=*hoc_objgetarg(1);if(!pList){printf("GetRowsERRD:firstargmustbelistofvectors\n");return-1.0;}intiColumns=ivoc_list_count(pList);if(iColumns<num_fields){printf("GetRowsERRE:numcolumnsinlist<numSQLselectcolumns\n");return-1.0;}inti;double**vvo=(double**)malloc(iColumns*sizeof(double*));if(!vvo){printf("GetRowsERRF:outofmemory\n");return-1.0;}intiVecSz=0;for(i=0;i<iColumns;i++){iVecSz=list_vector_px(pList,i,&vvo[i]);if(iVecSz<num_rows){printf("GetRowsERRG:vecsize%d<SQLresultrows%d\n",iVecSz,num_rows);free(vvo);return-1.0;}}MYSQL_ROWrow;intj=0;while((row=mysql_fetch_row(g_result))){unsignedlong*lengths=mysql_fetch_lengths(g_result);inti;for(i=0;i<num_fields;i++){vvo[i][j]=atof(row[i]);if(verbose)printf("[%.*s]",(int)lengths[i],row[i]?row[i]:"NULL");}if(verbose)printf("\n");j++;}free(vvo);return(double)num_rows;ENDVERBATIM}VERBATIMintStringEqualIgnoreCase(char*p1,char*p2,intn){inti;for(i=0;i<n;i++){if(tolower(p1[i])!=tolower(p2[i])){return0;}}return1;}ENDVERBATIMFUNCTIONFind(){VERBATIMif(!CheckConnection())return0.0;if(!ifarg(1)){printf("FindERRA:mustsupplytablename\n");return-1.0;}char*table=gargstr(1);if(g_result){FreeRes(&g_result);if(verbose)printf("FindWarning:previousSQLresultsfreed\n");}double*pVec;intiVecSz=vector_arg_px(2,&pVec);if(!pVec||iVecSz<1){printf("FindERRB:arg2mustbeaVector>0size\n");return-1.0;}MYSQL_RES*res=mysql_list_fields(&g_mysql,table,NULL);if(!res){printf("Failedtosearchforrecord:Error:%s\n",mysql_error(&g_mysql));return-1.0;}unsignedintnum_fields=mysql_num_fields(res);if(iVecSz>num_fields){printf("FindERRC:incorrectsizedvector%d,%snumcols=%d\n",iVecSz,table,num_fields);FreeRes(&res);return-1.0;}charsql_select[2048]={0};sprintf(sql_select,"select*from%swhere",table);charsql_val[1024]={0};inti;intiSearchCols=num_fields<iVecSz?num_fields:iVecSz;for(i=0;i<num_fields&&i<iVecSz;i++){MYSQL_FIELD*field=mysql_fetch_field(res);sprintf(sql_val,"%s=%f",field->name,pVec[i]);strcat(sql_select,sql_val);if(i<iSearchCols-1){strcat(sql_select,"and");}else{strcat(sql_select,";");}}FreeRes(&res);if(verbose)printf("Find:sqlcommand=%s\n",sql_select);if(0==mysql_real_query(&g_mysql,sql_select,strlen(sql_select))){g_result=mysql_store_result(&g_mysql);if(g_result){unsignedintnum_rows=mysql_num_rows(g_result);return(double)num_rows;}else{fprintf(stderr,"FindERRE:%s\n",mysql_error(&g_mysql));return-1.0;}}else{printf("FindERRD:%s\n",mysql_error(&g_mysql));return-1.0;}ENDVERBATIM}FUNCTIONUpdateCol(){VERBATIMif(!CheckConnection())return0.0;if(!ifarg(4)){printf("UpdateColERRA:usageUpdateCol(table_name,col_name,order_by_col_name,vec_of_vals\n");return0.0;}char*table=gargstr(1);char*col_name=gargstr(2);char*order_by_col=gargstr(3);double*pVec=0;intiSz=vector_arg_px(4,&pVec);if(!pVec){printf("UpdateColERRB:couldn'tgetvectorarg4!\n");return0.0;}intidx=ifarg(5)?(int)*getarg(5):0;charsql_command[8192]={0};inti;for(i=0;i<iSz;i++){sprintf(sql_command,"update%sset%s=%fwhere%s=%d;",table,col_name,pVec[i],order_by_col,idx);idx++;if(verbose)printf("sqlcmd=%s\n",sql_command);if(mysql_real_query(&g_mysql,sql_command,strlen(sql_command))==0){if(verbose)printf("col%supdated\n");}else{printf("Failedtoupdaterecord:Error:%s\n",mysql_error(&g_mysql));}}return1.0;ENDVERBATIM}FUNCTIONInsert(){VERBATIMif(!CheckConnection())return0.0;if(!ifarg(1)){printf("InsertERRB:mustsupplytablename\n");return0.0;}char*table=gargstr(1);if(g_result){FreeRes(&g_result);if(verbose)printf("InsertWarning:previousSQLresultsfreed\n");}Object*pObj=*hoc_objgetarg(2);if(!pObj){printf("InsertERRC:secondargmustbeListofVector(s)orVector\n");return0.0;}charsql_insert[2048]={0};sprintf(sql_insert,"insertinto%svalues(",table);charsql_command[8192]={0};charsql_val[256]={0};if(!strncmp(hoc_object_name(pObj),"List",4)){intiColumns=ivoc_list_count(pObj);if(iColumns==0){printf("InsertERRD:emptylist\n!");return0.0;}inti;double**vvo=(double**)malloc(iColumns*sizeof(double*));if(!vvo){printf("InsertERRE:outofmemory\n");return0.0;}intiVecSz=list_vector_px(pObj,0,&vvo[0]);for(i=1;i<iColumns;i++){intiTmp=list_vector_px(pObj,i,&vvo[i]);if(iTmp!=iVecSz){printf("InsertERRF:vectorsofdifferentsizes%d%d!\n",iVecSz,iTmp);free(vvo);return0.0;}}intj=0;for(i=0;i<iVecSz;i++){strcpy(sql_command,sql_insert);for(j=0;j<iColumns;j++){sprintf(sql_val,"%f",vvo[j][i]);strcat(sql_command,sql_val);if(j<iColumns-1)strcat(sql_command,",");}strcat(sql_command,");");if(verbose)printf("sql_command=%s\n",sql_command);if(mysql_real_query(&g_mysql,sql_command,strlen(sql_command))==0){if(verbose)printf("RecordAdded\n");}else{printf("Failedtoaddrecord:Error:%s\n",mysql_error(&g_mysql));}}free(vvo);}elseif(!strncmp(hoc_object_name(pObj),"Vector",6)){double*pVec=NULL;intiCols=vector_arg_px(2,&pVec);inti=0;strcpy(sql_command,sql_insert);for(i=0;i<iCols;i++){sprintf(sql_val,"%f",pVec[i]);strcat(sql_command,sql_val);if(i<iCols-1)strcat(sql_command,",");}strcat(sql_command,");");if(verbose)printf("sql_command=%s\n",sql_command);if(mysql_real_query(&g_mysql,sql_command,strlen(sql_command))==0){if(verbose)printf("RecordAdded\n");}else{printf("Failedtoaddrecord:Error:%s\n",mysql_error(&g_mysql));}}else{printf("InsertERRG:Invalidobjecttype%s\n",hoc_object_name(pObj));return0.0;}return1.0;ENDVERBATIM}FUNCTIONSelect(){VERBATIMif(!CheckConnection())return0.0;if(!ifarg(1)){printf("SelectSQLERRA:mustsupplySQLselectstring!\n");return-1.0;}char*query=gargstr(1);if(strlen(query)<6||!StringEqualIgnoreCase(query,"select",6)){printf("SelectSQLERRB:mustsupplySQLselectstring!\n");return-1.0;}if(g_result){FreeRes(&g_result);if(verbose)printf("SelectSQLWarning:previousSQLresultsfreed\n");}if(0==mysql_real_query(&g_mysql,query,strlen(query))){g_result=mysql_store_result(&g_mysql);if(g_result){unsignedintnum_fields=mysql_num_fields(g_result);unsignedintnum_rows=mysql_num_rows(g_result);printf("%drows,%dfieldsperrow,callGetRowstoget\n",num_rows,num_fields);return(double)num_rows;}else{fprintf(stderr,"SelectSQLERRC:%s\n",mysql_error(&g_mysql));return-1.0;}}else{printf("SelectSQLERRB:%s\n",mysql_error(&g_mysql));return-1.0;}ENDVERBATIM}FUNCTIONGetColNames(){VERBATIMif(!CheckConnection())return0.0;if(!g_result){printf("GetColNamesERRA:nosqlselectresults\n");return0.0;}unsignedintnum_fields=mysql_num_fields(g_result);if(!ifarg(num_fields)){printf("GetColNamesERRB:mustpassinatleast%dchar*'s\n",num_fields);return0.0;}MYSQL_FIELD*fields=mysql_fetch_fields(g_result);if(!fields){printf("GetColNamesERRC:couldn'tgetcolumnnames\n");return0.0;}inti;for(i=0;i<num_fields;i++){strcpy(gargstr(i+1),fields[i].name);}return1.0;ENDVERBATIM}VERBATIMdoublePrintRows(MYSQL_RES*res){if(!res)return0.0;unsignedintnum_fields=mysql_num_fields(res);unsignedintnum_rows=mysql_num_rows(res);MYSQL_FIELD*fields=mysql_fetch_fields(res);printf("\n__________________________________________________\n");inti;for(i=0;i<num_fields;i++){printf("[%s]\t",fields[i].name);}printf("\n__________________________________________________\n\n");MYSQL_ROWrow;while((row=mysql_fetch_row(res))){unsignedlong*lengths=mysql_fetch_lengths(res);inti;for(i=0;i<num_fields;i++){printf("[%.*s]\t",(int)lengths[i],row[i]?row[i]:"NULL");}printf("\n");}printf("\n__________________________________________________\n");printf("%drow(s),%dcol(s)\n",num_rows,num_fields);printf("__________________________________________________\n\n");return(double)num_rows;}ENDVERBATIMFUNCTIONListDBs(){VERBATIMif(!CheckConnection())return0.0;if(g_result){FreeRes(&g_result);if(verbose)printf("ListDBsWarning:previousSQLresultsfreed\n");}MYSQL_RES*dbres=mysql_list_dbs(&g_mysql,NULL);if(dbres){doublenum_rows=PrintRows(dbres);FreeRes(&dbres);returnnum_rows;}else{fprintf(stderr,"ListDBsERRA:%s\n",mysql_error(&g_mysql));return-1.0;}ENDVERBATIM}FUNCTIONQuery(){VERBATIMif(!CheckConnection())return0.0;if(!ifarg(1)){printf("QueryERRA:mustsupplySQLquerystring!\n");return-1.0;}char*query=gargstr(1);if(g_result){FreeRes(&g_result);if(verbose)printf("QueryWarning:previousSQLresultsfreed\n");}if(0==mysql_real_query(&g_mysql,query,strlen(query))){MYSQL_RES*result=mysql_store_result(&g_mysql);if(result){doublenum_rows=PrintRows(result);FreeRes(&result);returnnum_rows;}else{if(mysql_field_count(&g_mysql)==0){unsignedintnum_rows=mysql_affected_rows(&g_mysql);printf("Query:affectedrows=%d\n",num_rows);return(double)num_rows;}else{fprintf(stderr,"QueryERRC:%s\n",mysql_error(&g_mysql));return-1.0;}}}else{printf("QueryERRB:%s\n",mysql_error(&g_mysql));return-1.0;}ENDVERBATIM}PROCEDUREVersionInfo(){VERBATIMif(!CheckConnection())return;printf("MySQLClientVersionis%s\n",mysql_get_client_info());printf("MySQLServerVersionis%s\n",mysql_get_server_info(&g_mysql));ENDVERBATIM}