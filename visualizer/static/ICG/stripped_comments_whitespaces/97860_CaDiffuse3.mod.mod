NEURON{SUFFIXCaDiffuse3USEIONcaREADcai,icaWRITEcaiGLOBALvol,TotalBuffer,Pmax,beta,Dapp,multRANGEcai0,d2cai,cai_prime,cal,d1cai_0,d1cai_1,counter}DEFINENANN4UNITS{(molar)=(1/liter)(mM)=(millimolar)(um)=(micron)(mA)=(milliamp)FARADAY=(faraday)(10000coulomb)PI=(pi)(1)}PARAMETER{DCa=0.6(um2/ms)k1buf=100(/mM-ms)k2buf=0.1(/ms)TotalBuffer=0.003(mM)cai0=50e-6(mM)Pmax=2(um/ms)beta=0.001z=2F=9.64846e4(coulomb)Dapp=.02(um2/ms)mult=.000001}ASSIGNED{diam(um)ica(mA/cm2)icalcium(mA/m2)dt(ms)cai_prime(mM/ms)cai(mM)vol[NANN](1)Kd(/mM)B0(mM)d1cai_0(mM/um)d1cai_1(mM/um)d2cai(mM/um2)cal(mM)counter}STATE{ca[NANN](mM)<1e-6>CaBuffer[NANN](mM)Buffer[NANN](mM)}BREAKPOINT{ca[0]=caiSOLVEstateMETHODsparse}LOCALfactors_doneINITIAL{counter=0if(factors_done==0){factors_done=1factors()}Kd=k1buf/k2bufB0=TotalBuffer/(1+Kd*cai)FROMi=0TONANN-1{ca[i]=cai*(1-i/NANN)Buffer[i]=B0CaBuffer[i]=TotalBuffer-B0}d2()rate()caistep()}LOCALfrat[NANN]PROCEDUREfactors(){LOCALr,dr2r=1/2dr2=r/(NANN-1)/2vol[0]=0frat[0]=2*rFROMi=0TONANN-2{vol[i]=vol[i]+PI*(r-dr2/2)*2*dr2r=r-dr2frat[i+1]=2*PI*r/(2*dr2)r=r-dr2vol[i+1]=PI*(r+dr2/2)*2*dr2}}LOCALdsq,dsqvolKINETICstate{COMPARTMENTi,diam*diam*vol[i]{caCaBufferBuffer}LONGITUDINAL_DIFFUSIONi,DCa*diam*diam*vol[i]{ca}~ca[0]<<(-ica*PI*diam/(2*FARADAY))FROMi=0TONANN-2{~ca[i]<->ca[i+1](DCa*frat[i+1],DCa*frat[i+1])}dsq=diam*diamFROMi=0TONANN-1{dsqvol=dsq*vol[i]~ca[i]+Buffer[i]<->CaBuffer[i](k1buf*dsqvol,k2buf*dsqvol)}d2()rate()caistep()}PROCEDUREd2(){LOCALradius,drradius=diam/2dr=radius/(NANN-1)d1cai_0=(ca[0]-ca[1])/drd1cai_1=(ca[1]-ca[2])/drd2cai=(d1cai_0-d1cai_1)/dr}PROCEDURErate(){icalcium=ica*1e4(cm2/m2)cai_prime=(Dapp*d2cai)-((icalcium*4*beta)/(z*F*diam))-((Pmax*4*beta*ca[0])/diam)}PROCEDUREcaistep(){counter=counter+1cai=ca[0]+cai_prime*dt}